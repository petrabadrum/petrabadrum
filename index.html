<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petrabadrum ‚Äì Offertunderlag</title>
  <style>
    :root{
      --bg:#eef2f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#1d4ed8;
      --btn:#e9eef6;
      --btnText:#0f172a;
      --pill:#f8fafc;
      --chosenBg:#e8f5e9;     /* mindre ‚Äúskrikig‚Äù gr√∂n */
      --chosenBorder:#2e7d32;
      --shadow:0 12px 26px rgba(15,23,42,.08);
      --radius:18px;
      --radiusSm:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:linear-gradient(180deg,#f7f9fc 0%, var(--bg) 45%, #edf2f7 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px 14px 36px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 6px 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700;
      color:#0b2a6a;
      letter-spacing:.2px;
    }
    .brand img{
      width:34px; height:34px; object-fit:contain;
      border-radius:10px;
      background:#fff;
      border:1px solid var(--line);
    }
    .actions{
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--btnText);
      border-radius:999px;
      padding:10px 14px;
      font-weight:600;
      letter-spacing:.1px;
      box-shadow:0 6px 14px rgba(15,23,42,.06);
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{
      background:var(--brand);
      color:#fff;
      border-color:transparent;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:12px 0;
    }
    .card h2{
      margin:0 0 6px;
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
      color:#0b2a6a;
    }
    .card .sub{
      margin:0 0 14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      font-weight:500;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px 12px;
    }
    @media (max-width:700px){
      .grid2{grid-template-columns:1fr 1fr;} /* h√•ller 2 kolumner p√• iPhone */
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      margin:0 0 6px;
    }

    .field, .select, .pillBtn{
      width:100%;
      border:1px solid var(--line);
      border-radius:var(--radiusSm);
      background:var(--pill);
      padding:12px 12px;
      font-size:15px;
      font-weight:600;
      color:var(--text);
      outline:none;
      min-height:48px;
    }
    .field::placeholder{color:#94a3b8; font-weight:600}
    .select{padding-right:38px}

    .chosen{
      background:var(--chosenBg) !important;
      border-color:rgba(46,125,50,.65) !important;
      box-shadow:0 8px 18px rgba(46,125,50,.10);
      color:#0b3d1a !important;
    }

    .checkRow{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:6px;
    }
    .check{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      border-radius:var(--radiusSm);
      background:#fbfdff;
      padding:12px 12px;
      font-weight:700;
    }
    .check input{width:20px;height:20px}

    .twoBtns{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }

    .note{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      margin-top:8px;
      font-weight:500;
    }

    .priceBox{
      border:2px dashed #cbd5e1;
      border-radius:18px;
      padding:14px;
      background:#fbfdff;
      margin-top:12px;
    }
    .priceRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      color:#0f172a;
      font-weight:700;
    }
    .priceRow small{color:var(--muted); font-weight:700}
    .priceBig{
      font-size:18px;
      font-weight:900;
      color:#0b2a6a;
      padding-top:8px;
      border-top:1px solid var(--line);
      margin-top:6px;
    }

    .textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:var(--radiusSm);
      padding:12px;
      font-size:14px;
      font-weight:600;
      background:#fbfdff;
      outline:none;
    }
    .textarea::placeholder{color:#94a3b8; font-weight:600}

    /* Print/PDF (A4) */
    .printOnly{display:none}
    @media print{
      body{background:#fff}
      .wrap{max-width:none; padding:0}
      .noPrint{display:none !important}
      .printOnly{display:block !important}
      .a4{
        width:210mm;
        min-height:297mm;
        padding:16mm 14mm;
      }
      .a4Header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        border-bottom:2px solid #e5e7eb;
        padding-bottom:10px;
        margin-bottom:12px;
      }
      .a4Header img{height:26mm; width:auto; object-fit:contain}
      .a4Title{
        font-size:18pt;
        font-weight:800;
        margin:0;
      }
      .a4Sub{margin:4px 0 0; color:#334155; font-weight:600}
      .a4Section{margin:12px 0}
      .a4Section h3{
        margin:0 0 6px;
        font-size:12.5pt;
        font-weight:800;
        color:#0f172a;
      }
      .a4Grid{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:8px 14px;
        font-size:11pt;
      }
      .kv{display:flex; gap:8px}
      .k{min-width:82px; color:#334155; font-weight:800}
      .v{color:#0f172a; font-weight:650}
      .a4Box{
        border:1px solid #e5e7eb;
        border-radius:10px;
        padding:10px;
      }
      .a4Price{
        font-size:13pt;
        font-weight:900;
        color:#0b2a6a;
      }
      .split{
        margin-top:10px;
        border-top:1px solid #e5e7eb;
        padding-top:10px;
      }
      .splitRow{
        display:flex; justify-content:space-between; gap:10px;
        font-size:11pt; font-weight:800;
        padding:4px 0;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar noPrint">
      <div class="brand">
        <img id="logoTop" alt="Petra" />
        <div>Petrabadrum</div>
      </div>
      <div class="actions">
        <button class="btn" id="resetBtn" type="button">Nollst√§ll</button>
      </div>
    </div>

    <!-- KUNDUPPGIFTER + M√ñTESDATA -->
    <div class="card noPrint" id="cardCustomer">
      <h2>Kunduppgifter</h2>
      <p class="sub">Fylls i vid f√∂rsta telefonkontakten och inf√∂r kundbes√∂k.</p>

      <div class="grid2">
        <div>
          <label for="kundnamn">Kundnamn</label>
          <input class="field" id="kundnamn" placeholder="Ex. Anna Andersson" />
        </div>
        <div>
          <label for="adress">Adress</label>
          <input class="field" id="adress" placeholder="Gata, postnummer, ort" />
        </div>

        <div>
          <label for="telefon">Telefon</label>
          <input class="field" id="telefon" placeholder="" inputmode="tel" />
        </div>
        <div>
          <label for="epost">E-post</label>
          <input class="field" id="epost" placeholder="" inputmode="email" />
        </div>
      </div>

      <div style="height:10px"></div>
      <h2 style="font-size:20px; margin-top:6px;">M√∂tesdata</h2>

      <div class="grid2">
        <div>
          <label for="datum">Datum</label>
          <select class="select" id="datum"></select>
        </div>

        <div style="position:relative;">
          <label for="tid">Tid</label>
          <div style="position:relative;">
            <select class="select" id="tid" style="padding-right:58px;"></select>
            <!-- kalenderikon i tidf√§ltet -->
            <button id="calendarBtn" type="button"
              title="L√§gg till i kalender"
              style="position:absolute; right:8px; top:50%; transform:translateY(-50%);
                     width:40px; height:40px; border-radius:12px; border:1px solid var(--line);
                     background:#fff; font-weight:900; cursor:pointer;">
              üìÖ
            </button>
          </div>
        </div>

        <div>
          <label for="motestyp">M√∂testyp</label>
          <select class="select" id="motestyp">
            <option value="">Ej valt</option>
            <option>F√∂rsta bes√∂k</option>
            <option>√Öterbes√∂k</option>
            <option>Digitalt m√∂te</option>
          </select>
        </div>
        <div>
          <label for="plats">Plats</label>
          <input class="field" id="plats" placeholder="Hos kund, adress eller Teams-l√§nk" />
        </div>

        <div class="check" style="grid-column:1 / span 1;">
          <input type="checkbox" id="rotCheck" />
          <label for="rotCheck" style="margin:0; font-size:14px; color:#0f172a; font-weight:800;">Kund vill utnyttja ROT</label>
        </div>
        <div>
          <label for="rotBelopp">Belopp (ROT)</label>
          <input class="field" id="rotBelopp" inputmode="numeric" placeholder="0" />
        </div>
      </div>

      <div class="note">
        Kalenderknappen skapar en .ics-fil som du kan l√§gga till i iPhone-kalendern (och d√§rifr√•n delas den som vanligt via iCloud-kalendrar).
      </div>
    </div>

    <!-- BADRUMSDATA -->
    <div class="card noPrint">
      <h2>Badrumsdata</h2>
      <p class="sub">Valen anv√§nds f√∂r pris + sammanfattning.</p>

      <div class="grid2">
        <div>
          <label for="niva">Niv√•</label>
          <select class="select" id="niva">
            <option value="">Ej valt</option>
            <option value="standard">Standard</option>
            <option value="premium">Premium</option>
            <option value="exclusive">Exclusive</option>
          </select>
        </div>
        <div>
          <label for="storlek">Storlek (m¬≤)</label>
          <select class="select" id="storlek"></select>
        </div>
        <div>
          <label for="takh">Takh√∂jd (m)</label>
          <select class="select" id="takh"></select>
        </div>
        <div>
          <label for="reserv1">Reserv</label>
          <select class="select" id="reserv1">
            <option value="">Ej valt</option>
            <option>Ej valt</option>
          </select>
        </div>
      </div>
    </div>

    <!-- FUNKTIONER & UTRUSTNING -->
    <div class="card noPrint">
      <h2>Funktioner & utrustning</h2>
      <p class="sub">Kryssa i d√§r det √§r relevant. Prissatta val p√•verkar kalkylen.</p>

      <div class="checkRow">
        <div class="check"><input type="checkbox" id="wcVagg" /><label for="wcVagg" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">V√§ggh√§ngd WC</label></div>
        <div class="check"><input type="checkbox" id="wcGolv" /><label for="wcGolv" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Golvst√•ende WC</label></div>
        <div class="check"><input type="checkbox" id="handdusch" /><label for="handdusch" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Handdusch vid toalett</label></div>
        <div class="check"><input type="checkbox" id="badkar" /><label for="badkar" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Badkar</label></div>
        <div class="check"><input type="checkbox" id="enbartDusch" /><label for="enbartDusch" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Enbart dusch</label></div>

        <div class="check"><input type="checkbox" id="tvattmaskin" /><label for="tvattmaskin" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Tv√§ttmaskin inkl el & avlopp</label></div>
        <div class="check"><input type="checkbox" id="undertak" /><label for="undertak" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Nytt undertak / s√§nkt tak</label></div>
        <div class="check"><input type="checkbox" id="behallDorTroskel" /><label for="behallDorTroskel" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Beh√•lla befintlig d√∂rr & tr√∂skel</label></div>

        <div class="check"><input type="checkbox" id="spacklaMala" /><label for="spacklaMala" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Spackling & m√•lning</label></div>
        <div class="check"><input type="checkbox" id="nyDor" /><label for="nyDor" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Ny d√∂rr</label></div>
        <div class="check"><input type="checkbox" id="nyTroskel" /><label for="nyTroskel" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Ny tr√∂skel</label></div>

        <div class="check"><input type="checkbox" id="hamtaKakel" /><label for="hamtaKakel" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Vi h√§mtar kakel & klinker √•t kund</label></div>
        <div class="check"><input type="checkbox" id="hamtaInredning" /><label for="hamtaInredning" style="margin:0; font-size:15px; color:#0f172a; font-weight:800;">Vi h√§mtar badrumsinredning √•t kund</label></div>
      </div>

      <div style="height:12px"></div>

      <div class="grid2">
        <div>
          <label for="flyttAvlopp">Flytt av avlopp</label>
          <select class="select" id="flyttAvlopp">
            <option value="nej">Nej</option>
            <option value="tra">Tr√§bj√§lklag</option>
            <option value="betong">Betongbj√§lklag</option>
          </select>
        </div>
        <div>
          <label>√ñvrigt</label>
          <button class="pillBtn" id="ovrigtBtn" type="button">L√§gg till poster</button>
        </div>
      </div>

      <div id="ovrigtList" style="margin-top:10px;"></div>

      <div class="priceBox">
        <div class="priceRow"><small>Delsumma (exkl. moms, inkl. 10% h√∂jning)</small><span id="sumEx">0 kr</span></div>
        <div class="priceRow"><small>ROT-avdrag</small><span id="rotOut">-0 kr</span></div>
        <div class="priceRow priceBig"><span>Pris efter ROT-avdrag (exkl. moms)</span><span id="afterRotEx">0 kr</span></div>
        <div class="priceRow"><small>Pris efter ROT-avdrag (inkl. moms)</small><span id="afterRotInc">0 kr</span></div>
      </div>
    </div>

    <!-- ANTECKNINGAR -->
    <div class="card noPrint">
      <h2>Anteckningar</h2>
      <p class="sub">Frivilligt. Ing√•r i A4-sammanfattningen (PDF).</p>

      <textarea class="textarea" id="notes" placeholder="S√§rskilda f√∂ruts√§ttningar, tr√•nga utrymmen, parkering, tidsf√∂nster, bilder/video bifogas separat etc."></textarea>

      <div class="twoBtns">
        <button class="btn btnPrimary" id="calcBtn" type="button">Ber√§kna pris</button>
        <button class="btn" id="copyBtn" type="button">Kopiera text</button>
        <button class="btn" id="saveBtn" type="button">Spara</button>
        <button class="btn" id="pdfBtn" type="button">Spara som PDF</button>
      </div>

      <div class="note">
        ‚ÄúSpara‚Äù laddar ner en JSON med all data (kan sparas i iCloud Drive / delad mapp).
        ‚ÄúSpara som PDF‚Äù √∂ppnar en A4-vy och startar utskrift. P√• iPhone v√§ljer du ‚ÄúDela‚Äù ‚Üí ‚ÄúSpara i filer‚Äù.
      </div>
    </div>

    <!-- PRINT A4 -->
    <div class="printOnly a4" id="printA4">
      <div class="a4Header">
        <img id="logoPrint" alt="Petra" />
        <div style="flex:1;">
          <p class="a4Title">Offertunderlag f√∂r badrumsrenovering</p>
          <p class="a4Sub" id="a4Meta"></p>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Kund</h3>
        <div class="a4Grid">
          <div class="kv"><div class="k">Namn:</div><div class="v" id="a4Kund"></div></div>
          <div class="kv"><div class="k">Adress:</div><div class="v" id="a4Adress"></div></div>
          <div class="kv"><div class="k">Telefon:</div><div class="v" id="a4Tel"></div></div>
          <div class="kv"><div class="k">E-post:</div><div class="v" id="a4Epost"></div></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Badrumsdata</h3>
        <div class="a4Grid">
          <div class="kv"><div class="k">Niv√•:</div><div class="v" id="a4Niva"></div></div>
          <div class="kv"><div class="k">Storlek:</div><div class="v" id="a4Storlek"></div></div>
          <div class="kv"><div class="k">Takh√∂jd:</div><div class="v" id="a4Takh"></div></div>
          <div class="kv"><div class="k">ROT:</div><div class="v" id="a4Rot"></div></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Val & till√§gg</h3>
        <div class="a4Grid" id="a4Val"></div>
      </div>

      <div class="a4Section a4Box">
        <h3>Uppskattat pris (efter ROT)</h3>
        <div class="a4Price" id="a4Pris"></div>

        <!-- H√§r: bara 3 delar (5/55/40) enligt din instruktion -->
        <div class="split">
          <div class="splitRow"><span>Etablering (5%)</span><span id="a4Etab"></span></div>
          <div class="splitRow"><span>Arbetskostnad (55%)</span><span id="a4Arb"></span></div>
          <div class="splitRow"><span>Materialkostnad (40%)</span><span id="a4Mat"></span></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Anteckningar</h3>
        <div style="white-space:pre-wrap; font-size:11pt; font-weight:650;" id="a4Notes"></div>
      </div>
    </div>

  </div>

<script>
/* =========================
   KONFIG
========================= */
const STORAGE_KEY = "petrabadrum_form_v1";
const LOGO_SRC = "logo.png"; // √§ndra om din fil heter annat

/* Prislista ‚Äì justera h√§r.
   Viktigt: Jag kan inte veta dina ‚Äúursprungspriser‚Äù om de √§ndrats i repo,
   s√• h√§r √§r uppl√§gget robust + l√§tt att finjustera.
*/
const PRICES = {
  PCT_UPLIFT: 0.10,              // +10% exkl moms (enligt din instruktion)
  VAT: 0.25,

  // Till√§gg/val
  flyttAvlopp: { nej: 0, tra: 10000, betong: 20000 },
  hamtaService: 5000,            // per kryss
  nyDor: 0,                      // l√§gg pris om du vill priss√§tta
  nyTroskel: 0,                  // l√§gg pris om du vill priss√§tta
  undertak: 0,                   // l√§gg pris om du vill priss√§tta
  spacklaMala: 0,                // l√§gg pris om du vill priss√§tta
  tvattmaskin: 0,                // l√§gg pris om du vill priss√§tta
  badkar: 0,                     // l√§gg pris om du vill priss√§tta

  // Baspris ‚Äì h√§r beh√∂ver du l√§gga dina ‚Äúapp-priser‚Äù.
  // Modell: bas = niv√• * storlek. Takh√∂jd kan p√•verka med faktor.
  basePerM2: {
    standard: 0,
    premium: 0,
    exclusive: 0
  },
  ceilingFactor: (h) => {
    // Exempel: ingen √§ndring upp till 2.4, +5% √∂ver 2.5, +10% √∂ver 2.8
    if (h >= 2.8) return 1.10;
    if (h >= 2.5) return 1.05;
    return 1.00;
  }
};

/* =========================
   HJ√ÑLPARE
========================= */
const el = (id) => document.getElementById(id);
const fmt = (n) => (Math.round(n)).toLocaleString("sv-SE") + " kr";

function setLogo(){
  const img1 = el("logoTop");
  const img2 = el("logoPrint");
  img1.src = LOGO_SRC;
  img2.src = LOGO_SRC;
  img1.onerror = () => { img1.style.display="none"; };
  img2.onerror = () => { img2.style.display="none"; };
}

function populateDateTime(){
  // Datum: idag + 60 dagar
  const dSel = el("datum");
  dSel.innerHTML = `<option value="">Datum</option>`;
  const now = new Date();
  for(let i=0;i<61;i++){
    const d = new Date(now);
    d.setDate(now.getDate()+i);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const val = `${y}-${m}-${day}`;
    const txt = `${day}/${m}/${y}`;
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = txt;
    dSel.appendChild(opt);
  }

  // Tid: 07:00‚Äì19:00 i 15-min intervall
  const tSel = el("tid");
  tSel.innerHTML = `<option value="">Tid</option>`;
  for(let h=7; h<=19; h++){
    for(let min=0; min<60; min+=15){
      const hh = String(h).padStart(2,"0");
      const mm = String(min).padStart(2,"0");
      const val = `${hh}:${mm}`;
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      tSel.appendChild(opt);
    }
  }
}

function populateBathroom(){
  const size = el("storlek");
  size.innerHTML = `<option value="">Ej valt</option>`;
  for(let i=2;i<=20;i++){
    const opt=document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i} m¬≤`;
    size.appendChild(opt);
  }

  const takh = el("takh");
  takh.innerHTML = `<option value="">Ej valt</option>`;
  for(let x=2.0; x<=3.0+1e-9; x+=0.1){
    const v = x.toFixed(1).replace(".", ",");
    const opt=document.createElement("option");
    opt.value = String(x.toFixed(1));
    opt.textContent = `${v} m`;
    takh.appendChild(opt);
  }
}

function markChosenUI(){
  // Markera selects med valt v√§rde
  document.querySelectorAll("select.select").forEach(s=>{
    if(s.value && s.value !== "nej") s.classList.add("chosen");
    else s.classList.remove("chosen");
  });

  // ROT-belopp f√§lt
  const rb = el("rotBelopp");
  if((rb.value||"").trim() && Number(rb.value||0) > 0) rb.classList.add("chosen");
  else rb.classList.remove("chosen");
}

function getState(){
  const ovr = [...document.querySelectorAll(".ovrItem")].map(row=>{
    const t = row.querySelector(".ovrText").value.trim();
    const a = Number((row.querySelector(".ovrAmount").value||"0").replace(/\s/g,"").replace(",", "."));
    return { text:t, amount:isFinite(a)?a:0 };
  }).filter(x=>x.text || x.amount);

  return {
    kundnamn: el("kundnamn").value.trim(),
    adress: el("adress").value.trim(),
    telefon: el("telefon").value.trim(),
    epost: el("epost").value.trim(),

    datum: el("datum").value,
    tid: el("tid").value,
    motestyp: el("motestyp").value,
    plats: el("plats").value.trim(),

    rotCheck: el("rotCheck").checked,
    rotBelopp: Number((el("rotBelopp").value||"0").replace(/\s/g,"").replace(",", ".")) || 0,

    niva: el("niva").value,
    storlek: Number(el("storlek").value||0) || 0,
    takh: Number(el("takh").value||0) || 0,

    checks: {
      wcVagg: el("wcVagg").checked,
      wcGolv: el("wcGolv").checked,
      handdusch: el("handdusch").checked,
      badkar: el("badkar").checked,
      enbartDusch: el("enbartDusch").checked,
      tvattmaskin: el("tvattmaskin").checked,
      undertak: el("undertak").checked,
      behallDorTroskel: el("behallDorTroskel").checked,
      spacklaMala: el("spacklaMala").checked,
      nyDor: el("nyDor").checked,
      nyTroskel: el("nyTroskel").checked,
      hamtaKakel: el("hamtaKakel").checked,
      hamtaInredning: el("hamtaInredning").checked
    },

    flyttAvlopp: el("flyttAvlopp").value,
    ovrigt: ovr,

    notes: el("notes").value
  };
}

function setState(s){
  if(!s) return;

  el("kundnamn").value = s.kundnamn || "";
  el("adress").value = s.adress || "";
  el("telefon").value = s.telefon || "";
  el("epost").value = s.epost || "";

  el("datum").value = s.datum || "";
  el("tid").value = s.tid || "";
  el("motestyp").value = s.motestyp || "";
  el("plats").value = s.plats || "";

  el("rotCheck").checked = !!s.rotCheck;
  el("rotBelopp").value = (s.rotBelopp ?? 0) ? String(s.rotBelopp) : "";

  el("niva").value = s.niva || "";
  el("storlek").value = s.storlek ? String(s.storlek) : "";
  el("takh").value = s.takh ? String(Number(s.takh).toFixed(1)) : "";

  const c = s.checks || {};
  el("wcVagg").checked = !!c.wcVagg;
  el("wcGolv").checked = !!c.wcGolv;
  el("handdusch").checked = !!c.handdusch;
  el("badkar").checked = !!c.badkar;
  el("enbartDusch").checked = !!c.enbartDusch;
  el("tvattmaskin").checked = !!c.tvattmaskin;
  el("undertak").checked = !!c.undertak;
  el("behallDorTroskel").checked = !!c.behallDorTroskel;
  el("spacklaMala").checked = !!c.spacklaMala;
  el("nyDor").checked = !!c.nyDor;
  el("nyTroskel").checked = !!c.nyTroskel;
  el("hamtaKakel").checked = !!c.hamtaKakel;
  el("hamtaInredning").checked = !!c.hamtaInredning;

  el("flyttAvlopp").value = s.flyttAvlopp || "nej";
  el("notes").value = s.notes || "";

  // √ñvrigt
  el("ovrigtList").innerHTML = "";
  (s.ovrigt || []).forEach(x => addOvrigtRow(x.text, x.amount));

  markChosenUI();
}

function persist(){
  const s = getState();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
}

function restore(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    setState(s);
  }catch(e){}
}

function resetAll(){
  localStorage.removeItem(STORAGE_KEY);
  // nollst√§ll inputs
  document.querySelectorAll("input, textarea").forEach(i=>{
    if(i.type === "checkbox") i.checked = false;
    else i.value = "";
  });
  document.querySelectorAll("select").forEach(s=>{
    s.value = "";
  });
  el("flyttAvlopp").value = "nej";
  el("ovrigtList").innerHTML = "";
  updatePriceUI(0,0);
  markChosenUI();
}

function addOvrigtRow(text="", amount=0){
  const row = document.createElement("div");
  row.className = "grid2 ovrItem";
  row.style.marginTop="10px";

  row.innerHTML = `
    <div>
      <label>Post</label>
      <input class="field ovrText" placeholder="Ex. F√∂nsterbyte / Bygga in badkar" value="${escapeHtml(text)}" />
    </div>
    <div>
      <label>Belopp (kr)</label>
      <input class="field ovrAmount" inputmode="numeric" placeholder="0" value="${amount ? String(amount) : ""}" />
    </div>
  `;

  el("ovrigtList").appendChild(row);

  row.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", ()=>{ persist(); calc(); });
  });
}

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* =========================
   PRISLOGIK
========================= */
function calc(){
  const s = getState();

  // Bas (niv√• + storlek)
  let base = 0;
  if(s.niva && s.storlek){
    const per = PRICES.basePerM2[s.niva] || 0;
    base = per * s.storlek;
    if(s.takh){
      base = base * PRICES.ceilingFactor(s.takh);
    }
  }

  // Till√§gg
  let add = 0;

  // Flytt av avlopp
  add += PRICES.flyttAvlopp[s.flyttAvlopp] || 0;

  // H√§mtservice
  if(s.checks.hamtaKakel) add += PRICES.hamtaService;
  if(s.checks.hamtaInredning) add += PRICES.hamtaService;

  // √ñvrigt poster
  add += (s.ovrigt||[]).reduce((sum,x)=> sum + (Number(x.amount)||0), 0);

  // (Om du vill priss√§tta dessa, l√§gg belopp i PRICES och aktivera nedan)
  if(s.checks.nyDor) add += PRICES.nyDor || 0;
  if(s.checks.nyTroskel) add += PRICES.nyTroskel || 0;
  if(s.checks.undertak) add += PRICES.undertak || 0;
  if(s.checks.spacklaMala) add += PRICES.spacklaMala || 0;
  if(s.checks.tvattmaskin) add += PRICES.tvattmaskin || 0;
  if(s.checks.badkar) add += PRICES.badkar || 0;

  let subtotal = base + add;

  // +10% exkl moms
  subtotal = subtotal * (1 + PRICES.PCT_UPLIFT);

  // ROT
  let rot = 0;
  if(s.rotCheck){
    rot = Math.max(0, Number(s.rotBelopp)||0);
  }
  rot = Math.min(rot, subtotal); // kan ej dra av mer √§n subtotal

  const afterRotEx = Math.max(0, subtotal - rot);
  const afterRotInc = afterRotEx * (1 + PRICES.VAT);

  updatePriceUI(subtotal, rot, afterRotEx, afterRotInc);
  markChosenUI();
  persist();
}

function updatePriceUI(subtotal=0, rot=0, afterRotEx=0, afterRotInc=0){
  el("sumEx").textContent = fmt(subtotal);
  el("rotOut").textContent = "-" + fmt(rot).replace(" kr","");
  el("afterRotEx").textContent = fmt(afterRotEx);
  el("afterRotInc").textContent = fmt(afterRotInc);
}

/* =========================
   PDF / A4
========================= */
function buildA4(){
  const s = getState();

  // meta
  const metaParts = [];
  if(s.datum) metaParts.push(`Datum: ${s.datum}`);
  if(s.tid) metaParts.push(`Tid: ${s.tid}`);
  if(s.motestyp) metaParts.push(`M√∂testyp: ${s.motestyp}`);
  if(s.plats) metaParts.push(`Plats: ${s.plats}`);
  el("a4Meta").textContent = metaParts.join("  ‚Ä¢  ");

  el("a4Kund").textContent = s.kundnamn || "‚Äî";
  el("a4Adress").textContent = s.adress || "‚Äî";
  el("a4Tel").textContent = s.telefon || "‚Äî";
  el("a4Epost").textContent = s.epost || "‚Äî";

  el("a4Niva").textContent = s.niva ? (s.niva[0].toUpperCase()+s.niva.slice(1)) : "‚Äî";
  el("a4Storlek").textContent = s.storlek ? `${s.storlek} m¬≤` : "‚Äî";
  el("a4Takh").textContent = s.takh ? `${String(s.takh).replace(".", ",")} m` : "‚Äî";
  el("a4Rot").textContent = s.rotCheck ? (`Ja, ${fmt(s.rotBelopp||0)}`) : "Nej";

  // Pris efter ROT (exkl moms)
  const afterRotEx = Number((el("afterRotEx").textContent||"0").replace(/\s/g,"").replace("kr","").replace(/\./g,"").replace(",", ".")) || 0;
  // Om parsing strular, r√§kna om:
  // (vi tar s√§krare via calc() i runtime, men h√§r anv√§nder vi texten)

  // b√§ttre: r√§kna exakt igen:
  calc();
  const afterRotExTxt = el("afterRotEx").textContent;

  el("a4Pris").textContent = `${afterRotExTxt} (efter ROT, exkl. moms)`;

  // 5/55/40
  const exNum = Number((el("afterRotEx").textContent||"0")
    .replaceAll("kr","").replace(/\s/g,"")
    .replaceAll(".", "").replace(",", ".")) || 0;

  const etab = exNum * 0.05;
  const arb  = exNum * 0.55;
  const mat  = exNum * 0.40;

  el("a4Etab").textContent = fmt(etab);
  el("a4Arb").textContent  = fmt(arb);
  el("a4Mat").textContent  = fmt(mat);

  // Val & till√§gg (inkl ‚Äúvi h√§mtar ‚Ä¶‚Äù)
  const pairs = [];
  const c = s.checks || {};
  const yesNo = (b)=> b ? "Ja" : "Nej";

  pairs.push(["V√§ggh√§ngd WC", yesNo(c.wcVagg)]);
  pairs.push(["Golvst√•ende WC", yesNo(c.wcGolv)]);
  pairs.push(["Handdusch vid toalett", yesNo(c.handdusch)]);
  pairs.push(["Badkar", yesNo(c.badkar)]);
  pairs.push(["Enbart dusch", yesNo(c.enbartDusch)]);
  pairs.push(["Tv√§ttmaskin", yesNo(c.tvattmaskin)]);
  pairs.push(["Undertak/s√§nkt tak", yesNo(c.undertak)]);
  pairs.push(["Beh√•lla d√∂rr & tr√∂skel", yesNo(c.behallDorTroskel)]);
  pairs.push(["Spackling & m√•lning", yesNo(c.spacklaMala)]);
  pairs.push(["Ny d√∂rr", yesNo(c.nyDor)]);
  pairs.push(["Ny tr√∂skel", yesNo(c.nyTroskel)]);
  pairs.push(["Vi h√§mtar kakel & klinker", c.hamtaKakel ? "Ja (+5 000 kr)" : "Nej"]);
  pairs.push(["Vi h√§mtar badrumsinredning", c.hamtaInredning ? "Ja (+5 000 kr)" : "Nej"]);
  pairs.push(["Flytt av avlopp", s.flyttAvlopp === "nej" ? "Nej" : (s.flyttAvlopp === "tra" ? "Tr√§bj√§lklag (+10 000 kr)" : "Betongbj√§lklag (+20 000 kr)")]);

  // √ñvrigt
  (s.ovrigt||[]).forEach((x,idx)=>{
    if(x.text || x.amount){
      pairs.push([`√ñvrigt ${idx+1}`, `${x.text || "‚Äî"} (${fmt(x.amount||0)})`]);
    }
  });

  const box = el("a4Val");
  box.innerHTML = "";
  pairs.forEach(([k,v])=>{
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<div class="k">${escapeHtml(k)}:</div><div class="v">${escapeHtml(v)}</div>`;
    box.appendChild(div);
  });

  el("a4Notes").textContent = (s.notes || "‚Äî");
}

function printPDF(){
  buildA4();
  window.print();
}

/* =========================
   KALENDER (.ics)
========================= */
function addToCalendar(){
  const s = getState();
  if(!s.datum || !s.tid){
    alert("Fyll i datum och tid f√∂rst.");
    return;
  }
  const [y,m,d] = s.datum.split("-").map(Number);
  const [hh,mm] = s.tid.split(":").map(Number);

  // 60 min m√∂te default
  const start = new Date(y, m-1, d, hh, mm, 0);
  const end = new Date(start.getTime() + 60*60*1000);

  const pad = (n)=> String(n).padStart(2,"0");
  const toICS = (dt)=>{
    // local time -> "YYYYMMDDTHHMMSS"
    return `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}00`;
  };

  const title = `Kundbes√∂k: ${s.kundnamn || "Badrum"}`;
  const loc = s.plats || s.adress || "";
  const desc = `Petrabadrum ‚Äì offertunderlag.\nM√∂testyp: ${s.motestyp||"‚Äî"}\nTelefon: ${s.telefon||"‚Äî"}\nE-post: ${s.epost||"‚Äî"}`;

  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Petrabadrum//SE
BEGIN:VEVENT
DTSTART:${toICS(start)}
DTEND:${toICS(end)}
SUMMARY:${title}
LOCATION:${loc}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `petrabadrum_mote_${s.datum}_${s.tid.replace(":","")}.ics`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   SPARA / KOPIERA
========================= */
function saveJSON(){
  const s = getState();
  // se till att pris √§r uppdaterat
  calc();
  const payload = {
    ...s,
    price: {
      subtotal_excl_vat_incl_uplift: el("sumEx").textContent,
      rot: el("rotOut").textContent + " kr",
      after_rot_excl_vat: el("afterRotEx").textContent,
      after_rot_incl_vat: el("afterRotInc").textContent
    },
    savedAt: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const safeName = (s.kundnamn || "kund").replace(/[^\w√•√§√∂√Ö√Ñ√ñ-]+/g,"_");
  a.download = `petrabadrum_${safeName}_${(s.datum||"datum")}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function copySummaryText(){
  calc();
  const s = getState();
  const lines = [];
  lines.push("PETRABADRUM ‚Äì Offertunderlag");
  lines.push("");
  lines.push(`Kund: ${s.kundnamn || "‚Äî"}`);
  lines.push(`Adress: ${s.adress || "‚Äî"}`);
  lines.push(`Telefon: ${s.telefon || "‚Äî"}`);
  lines.push(`E-post: ${s.epost || "‚Äî"}`);
  lines.push("");
  lines.push(`M√∂te: ${s.datum || "‚Äî"} ${s.tid || ""} ‚Ä¢ ${s.motestyp || "‚Äî"} ‚Ä¢ ${s.plats || "‚Äî"}`);
  lines.push("");
  lines.push(`Niv√•: ${s.niva || "‚Äî"} ‚Ä¢ Storlek: ${s.storlek ? s.storlek+" m¬≤" : "‚Äî"} ‚Ä¢ Takh√∂jd: ${s.takh ? String(s.takh).replace(".",",")+" m" : "‚Äî"}`);
  lines.push("");
  lines.push(`Delsumma (exkl. moms, inkl. 10%): ${el("sumEx").textContent}`);
  lines.push(`ROT-avdrag: ${el("rotOut").textContent} kr`);
  lines.push(`Pris efter ROT (exkl. moms): ${el("afterRotEx").textContent}`);
  lines.push(`Pris efter ROT (inkl. moms): ${el("afterRotInc").textContent}`);
  lines.push("");
  lines.push("Anteckningar:");
  lines.push(s.notes || "‚Äî");

  navigator.clipboard.writeText(lines.join("\n"))
    .then(()=> alert("Kopierat."))
    .catch(()=> alert("Kunde inte kopiera i denna webbl√§sare."));
}

/* =========================
   EVENTS
========================= */
function bindEvents(){
  // autosave
  document.querySelectorAll("input, textarea, select").forEach(inp=>{
    inp.addEventListener("change", ()=>{ persist(); calc(); });
    inp.addEventListener("input", ()=>{ persist(); });
  });

  el("resetBtn").addEventListener("click", ()=>{
    if(confirm("Nollst√§lla allt?")) resetAll();
  });

  el("ovrigtBtn").addEventListener("click", ()=>{
    addOvrigtRow("", 0);
    persist();
  });

  el("calcBtn").addEventListener("click", calc);
  el("calendarBtn").addEventListener("click", addToCalendar);
  el("copyBtn").addEventListener("click", copySummaryText);
  el("saveBtn").addEventListener("click", saveJSON);
  el("pdfBtn").addEventListener("click", printPDF);
}

/* =========================
   INIT
========================= */
(function init(){
  setLogo();
  populateDateTime();
  populateBathroom();
  bindEvents();
  restore();
  calc();
})();
</script>
</body>
</html>
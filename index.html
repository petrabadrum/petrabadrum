<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petrabadrum ‚Äì Offertunderlag</title>

  <style>
    :root{
      --bg:#eef2f7;
      --card:#ffffff;
      --stroke:#cfd7e3;
      --text:#0b1a33;
      --muted:#6c7a92;
      --primary:#1e5bd7;
      --pill:#f3f5f8;
      --pillText:#111827;
      --okBg:#e9f6ec;
      --okBorder:#2f7a3b;
      --shadow: 0 10px 30px rgba(10,20,40,.08);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, #f7f9fc, var(--bg));
      color:var(--text);
    }

    .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 70px; }

    .card{
      background:var(--card);
      border:1px solid rgba(207,215,227,.9);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:14px 0;
    }

    h2{ margin:0 0 6px; font-size:22px; letter-spacing:.2px; color:#163a7a; }
    .sub{ margin:0 0 12px; color:var(--muted); font-size:14px; line-height:1.35; }

    /* Sticky top actions */
    .stickyTop{
      position:sticky;
      top:0;
      z-index:20;
      padding:10px 0 8px;
      background: linear-gradient(180deg, rgba(247,249,252,.98), rgba(247,249,252,.86));
      backdrop-filter: blur(6px);
    }
    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .btn{
      border:1px solid var(--stroke);
      background:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      color:#0b1a33;
      cursor:pointer;
      font-size:14px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px 14px; }
    .field label{
      display:block;
      font-weight:900;
      font-size:14px;
      margin:6px 0 6px;
      color:#142a55;
    }

    input[type="text"], input[type="tel"], input[type="email"], input[type="number"], input[type="date"], input[type="time"], textarea, select{
      width:100%;
      border:1px solid var(--stroke);
      background:#f8fafc;
      border-radius:16px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    /* Date/Time as pill */
    .pillwrap{ position:relative; }
    .pill{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--stroke);
      background:var(--pill);
      border-radius:18px;
      padding:12px 12px;
      font-size:16px;
      cursor:pointer;
      user-select:none;
      min-height:48px;
    }
    .pill .value{ font-weight:900; color:var(--pillText); }
    .pill .value.muted{ color:#9aa6ba; }
    .pill .chev{ opacity:.6; font-size:18px; line-height:1; }
    .pill.selected{
      background:var(--okBg);
      border-color: rgba(47,122,59,.45);
      box-shadow: 0 8px 18px rgba(47,122,59,.10);
    }

    /* Time with calendar icon */
    .timeWithIcon{ position:relative; }
    .timeWithIcon input{ padding-right:46px; }
    .calIconBtn{
      position:absolute;
      top:50%;
      right:10px;
      transform: translateY(-50%);
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:18px;
    }

    /* Checkboxes */
    .checks{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px; }
    .check{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background:#fbfcfe;
    }
    .check input{ width:22px; height:22px; }
    .check span{ font-weight:800; }

    /* Actions */
    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top: 10px;
    }
    .actionBtn{
      border-radius:22px;
      padding:16px 12px;
      font-weight:1000;
      font-size:16px;
      border:1px solid var(--stroke);
      background:#eef2f7;
      cursor:pointer;
    }
    .actionBtn.primary{
      background:var(--primary);
      color:#fff;
      border-color: rgba(30,91,215,.3);
    }

    /* Modal √ñvrigt */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(5,12,25,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid var(--stroke);
      box-shadow: 0 22px 60px rgba(0,0,0,.25);
      padding:14px;
    }
    .modal h3{ margin:6px 6px 10px; }
    .otherRows{ display:grid; gap:10px; }
    .otherRow{
      display:grid;
      grid-template-columns: 1fr 140px 44px;
      gap:10px;
      align-items:center;
    }
    .iconBtn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:#fff;
      cursor:pointer;
      font-size:18px;
      font-weight:1000;
    }
    .modalFoot{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:12px;
    }

    .muted{ color: var(--muted); }

    @media print{
      body{ background:#fff; }
      .wrap{ max-width:100%; padding:0; }
      .noPrint{ display:none !important; }
      .card{ box-shadow:none; border:0; margin:0; padding:0; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="appRoot">

    <!-- Sticky top (s√• Nollst√§ll alltid syns) -->
    <div class="stickyTop noPrint">
      <div class="toprow">
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="btn" id="resetBtn" type="button">Nollst√§ll</button>
        </div>
        <div style="font-weight:900; color:#163a7a;">Petrabadrum</div>
      </div>
    </div>

    <div class="card">
      <div class="toprow" style="margin-bottom:8px;">
        <h2 style="margin:0;">Kunduppgifter</h2>
      </div>
      <p class="sub">Fylls i vid f√∂rsta telefonkontakten och inf√∂r kundbes√∂k.</p>

      <div class="grid2">
        <div class="field">
          <label>Kundnamn</label>
          <input id="kundnamn" type="text" placeholder="Ex. Anna Andersson" />
        </div>
        <div class="field">
          <label>Adress</label>
          <input id="adress" type="text" placeholder="Gata, postnummer, ort" />
        </div>

        <div class="field">
          <label>Telefon</label>
          <input id="telefon" type="tel" placeholder="" />
        </div>
        <div class="field">
          <label>E-post</label>
          <input id="epost" type="email" placeholder="" />
        </div>
      </div>

      <div style="height:10px"></div>

      <h2 style="margin-top:6px;">M√∂tesdata</h2>
      <div class="grid2">
        <!-- Datum pill -->
        <div class="field pillwrap">
          <label>Datum</label>
          <div class="pill" id="datePill" role="button" tabindex="0">
            <div class="value muted" id="datePillText">Datum</div>
            <div class="chev">‚ñæ</div>
          </div>
          <input id="datum" type="date" style="position:absolute; inset:0; opacity:0; pointer-events:auto;" />
        </div>

        <!-- Tid pill + kalenderikon i f√§ltet -->
        <div class="field pillwrap timeWithIcon">
          <label>Tid</label>
          <div class="pill" id="timePill" role="button" tabindex="0">
            <div class="value muted" id="timePillText">Tid</div>
            <div class="chev">‚ñæ</div>
          </div>
          <input id="tid" type="time" style="position:absolute; inset:0; opacity:0; pointer-events:auto;" />
          <button class="calIconBtn" id="calendarIconBtn" type="button" title="L√§gg till i kalender">üìÖ</button>
        </div>

        <div class="field">
          <label>M√∂testyp</label>
          <select id="motestyp">
            <option value="">Ej valt</option>
            <option>F√∂rsta bes√∂k</option>
            <option>√Öterbes√∂k</option>
            <option>Digitalt m√∂te</option>
            <option>Telefonsamtal</option>
          </select>
        </div>

        <div class="field">
          <label>Plats</label>
          <input id="plats" type="text" placeholder="Hos kund, adress eller Teams-l√§nk" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid2">
        <div class="check">
          <input id="rot" type="checkbox" />
          <span>Kund vill utnyttja ROT</span>
        </div>
        <div class="field">
          <label>Belopp (ROT)</label>
          <input id="rotBelopp" type="number" inputmode="numeric" placeholder="0" min="0" step="100" />
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Funktioner & utrustning</h2>
      <p class="sub">Valen anv√§nds f√∂r pris + sammanfattning.</p>

      <!-- Flyttat upp: s√§nkt tak + beh√•lla d√∂rr/tr√∂skel ligger nu uppe h√§r bland kryssrutorna -->
      <div class="checks">
        <label class="check"><input id="vh_wc" type="checkbox"><span>V√§ggh√§ngd WC</span></label>
        <label class="check"><input id="gs_wc" type="checkbox"><span>Golvst√•ende WC</span></label>
        <label class="check"><input id="handdusch_wc" type="checkbox"><span>Handdusch vid toalett</span></label>
        <label class="check"><input id="badkar" type="checkbox"><span>Badkar</span></label>
        <label class="check"><input id="enbart_dusch" type="checkbox"><span>Enbart dusch</span></label>

        <label class="check"><input id="tvattmaskin" type="checkbox"><span>Tv√§ttmaskin inkl el & avlopp</span></label>

        <label class="check"><input id="sankt_innertak" type="checkbox"><span>Nytt undertak / s√§nkt tak</span></label>
        <label class="check"><input id="behalla_dorr_troskel" type="checkbox"><span>Beh√•lla befintlig d√∂rr & tr√∂skel</span></label>

        <label class="check"><input id="spackel_malning" type="checkbox"><span>Spackling & m√•lning</span></label>
        <label class="check"><input id="ny_dorr" type="checkbox"><span>Ny d√∂rr</span></label>
        <label class="check"><input id="ny_troskel" type="checkbox"><span>Ny tr√∂skel</span></label>

        <!-- H√§mtning (5 000 kr/st) -->
        <label class="check"><input id="hamta_kakel" type="checkbox"><span>Vi h√§mtar kakel & klinker √•t kund</span></label>
        <label class="check"><input id="hamta_inredning" type="checkbox"><span>Vi h√§mtar badrumsinredning √•t kund</span></label>
      </div>

      <div style="height:14px"></div>

      <div class="grid2">
        <div class="field">
          <label>Flytt av avlopp</label>
          <select id="flytt_avlopp">
            <option value="0">Nej</option>
            <option value="10000">Tr√§bj√§lklag (+10 000)</option>
            <option value="20000">Betongbj√§lklag (+20 000)</option>
          </select>
        </div>

        <div class="field">
          <label>√ñvrigt</label>
          <button class="btn noPrint" id="otherBtn" type="button" style="width:100%; border-radius:16px; padding:12px; font-weight:1000;">
            L√§gg till poster
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Anteckningar</h2>
      <p class="sub">Frivilligt. Ing√•r i A4-sammanfattningen (PDF).</p>
      <textarea id="notes" placeholder="S√§rskilda f√∂ruts√§ttningar, tr√•nga utrymmen, parkering, bilder/video bifogas separat etc."></textarea>

      <div class="actions noPrint">
        <button class="actionBtn primary" id="calcBtn" type="button">Ber√§kna pris</button>
        <button class="actionBtn" id="copyBtn" type="button">Kopiera text</button>
        <button class="actionBtn" id="saveBtn" type="button">Spara</button>
        <button class="actionBtn" id="pdfBtn" type="button">Spara som PDF</button>
      </div>
    </div>

    <!-- Modal: √ñvrigt -->
    <div class="modalBack noPrint" id="modalBack">
      <div class="modal">
        <h3>√ñvrigt ‚Äì L√§gg till poster</h3>
        <p class="sub" style="margin: 0 6px 10px;">Ex. f√∂nsterbyte, bygga in badkar, special√∂nskem√•l. Belopp exkl. moms (innan ROT).</p>

        <div class="otherRows" id="otherRows"></div>

        <div class="modalFoot">
          <button class="btn" id="addOtherRow" type="button">+ Ny rad</button>
          <button class="btn" id="closeOther" type="button">Klar</button>
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================
   PRISER (EXKL MOMS)
   Alla priser h√∂js 10% i ber√§kningen (UPLIFT).
   ========================= */

const UPLIFT = 1.10;
const VAT = 1.25;

// OBS: Beh√•lla d√∂rr/tr√∂skel + golvst√•ende WC ska vara 0 kr.
// H√§mtning: 5 000 kr/st.
const PRICE = {
  vh_wc: 0,
  gs_wc: 0,
  handdusch_wc: 2500,
  badkar: 12000,
  enbart_dusch: 0,
  tvattmaskin: 8500,
  sankt_innertak: 6500,
  behalla_dorr_troskel: 0,
  spackel_malning: 9500,
  ny_dorr: 4500,
  ny_troskel: 2500,
  hamta_kakel: 5000,
  hamta_inredning: 5000
};

const el = (id) => document.getElementById(id);

const state = { other: [] };
const LS_KEY = "petrabadrum_state_v2";

function formatSEK(n){
  const v = Math.max(0, Math.round(n));
  return v.toLocaleString("sv-SE") + " kr";
}

/* ==============
   PERSISTENS
   ============== */
function readForm(){
  const ids = [
    "kundnamn","adress","telefon","epost",
    "datum","tid","motestyp","plats",
    "rot","rotBelopp",
    "vh_wc","gs_wc","handdusch_wc","badkar","enbart_dusch","tvattmaskin",
    "sankt_innertak","behalla_dorr_troskel","spackel_malning","ny_dorr","ny_troskel",
    "hamta_kakel","hamta_inredning",
    "flytt_avlopp",
    "notes"
  ];
  const obj = {};
  ids.forEach(id=>{
    const node = el(id);
    if(!node) return;
    if(node.type === "checkbox") obj[id] = node.checked;
    else obj[id] = node.value ?? "";
  });
  obj.other = state.other;
  return obj;
}
function writeForm(obj){
  if(!obj) return;
  Object.keys(obj).forEach(k=>{
    if(k === "other") return;
    const node = el(k);
    if(!node) return;
    if(node.type === "checkbox") node.checked = !!obj[k];
    else node.value = obj[k];
  });
  state.other = Array.isArray(obj.other) ? obj.other : [];
  renderOtherRows();
  syncDateTimePills();
}
function saveToLS(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(readForm())); }catch(e){}
}
function loadFromLS(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    writeForm(JSON.parse(raw));
  }catch(e){}
}
function bindAutoSave(){
  document.addEventListener("input", (e)=>{
    if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT")){
      syncDateTimePills();
      saveToLS();
    }
  });
  document.addEventListener("change", ()=>{
    syncDateTimePills();
    saveToLS();
  });
}

/* ==============
   ‚ÄúPILL‚Äù DATE/TIME
   ============== */
function syncDateTimePills(){
  const d = el("datum").value;
  const t = el("tid").value;

  const datePill = el("datePill");
  const dateTxt = el("datePillText");
  if(d){
    datePill.classList.add("selected");
    dateTxt.classList.remove("muted");
    dateTxt.textContent = d;
  }else{
    datePill.classList.remove("selected");
    dateTxt.classList.add("muted");
    dateTxt.textContent = "Datum";
  }

  const timePill = el("timePill");
  const timeTxt = el("timePillText");
  if(t){
    timePill.classList.add("selected");
    timeTxt.classList.remove("muted");
    timeTxt.textContent = t;
  }else{
    timePill.classList.remove("selected");
    timeTxt.classList.add("muted");
    timeTxt.textContent = "Tid";
  }
}
function initPillClicks(){
  el("datePill").addEventListener("click", ()=> el("datum").showPicker ? el("datum").showPicker() : el("datum").focus());
  el("timePill").addEventListener("click", ()=> el("tid").showPicker ? el("tid").showPicker() : el("tid").focus());
}

/* ==============
   √ñVRIGT MODAL
   ============== */
function renderOtherRows(){
  const wrap = el("otherRows");
  wrap.innerHTML = "";
  if(state.other.length === 0) state.other.push({ text:"", amount:"" });

  state.other.forEach((row, idx)=>{
    const div = document.createElement("div");
    div.className = "otherRow";

    const t = document.createElement("input");
    t.type = "text";
    t.placeholder = "Beskrivning (ex. f√∂nsterbyte)";
    t.value = row.text || "";
    t.addEventListener("input", ()=>{
      state.other[idx].text = t.value;
      saveToLS();
    });

    const a = document.createElement("input");
    a.type = "number";
    a.inputMode = "numeric";
    a.placeholder = "Belopp";
    a.min = "0";
    a.step = "100";
    a.value = row.amount ?? "";
    a.addEventListener("input", ()=>{
      state.other[idx].amount = a.value;
      saveToLS();
    });

    const del = document.createElement("button");
    del.className = "iconBtn";
    del.type = "button";
    del.textContent = "‚úï";
    del.addEventListener("click", ()=>{
      state.other.splice(idx,1);
      if(state.other.length===0) state.other.push({text:"", amount:""});
      renderOtherRows();
      saveToLS();
    });

    div.appendChild(t);
    div.appendChild(a);
    div.appendChild(del);
    wrap.appendChild(div);
  });
}
function openOther(){ el("modalBack").style.display="flex"; }
function closeOther(){ el("modalBack").style.display="none"; saveToLS(); }

/* ==============
   KALKYL
   ============== */
function getSelectedCostBase(){
  let sum = 0;

  // Kryssrutor med pris
  Object.keys(PRICE).forEach(k=>{
    const node = el(k);
    if(node && node.type === "checkbox" && node.checked){
      sum += (PRICE[k] || 0);
    }
  });

  // Flytt av avlopp
  const av = parseInt(el("flytt_avlopp").value || "0", 10);
  sum += isNaN(av) ? 0 : av;

  // √ñvrigt
  for(const r of state.other){
    const amt = parseFloat(r.amount || "0");
    if(!isNaN(amt) && amt>0) sum += amt;
  }
  return sum;
}

function calcTotals(){
  const base = getSelectedCostBase();
  const uplifted = base * UPLIFT;

  const rotOn = el("rot").checked;
  const rotAmt = rotOn ? Math.max(0, parseFloat(el("rotBelopp").value || "0")) : 0;

  const afterRot = Math.max(0, uplifted - rotAmt);
  const afterRotInc = afterRot * VAT;

  return { base, uplifted, rotAmt, afterRot, afterRotInc };
}

/* ==============
   BYGG A4 (vit)
   Beh√•ll √∂vre del till ‚ÄúPrisuppdelning‚Äù
   Sen endast 5/55/40
   ============== */

function yesNo(b){ return b ? "Ja" : "Nej"; }

function buildA4HTML(){
  const { uplifted, rotAmt, afterRot, afterRotInc } = calcTotals();

  const name = el("kundnamn").value.trim();
  const addr = el("adress").value.trim();
  const tel  = el("telefon").value.trim();
  const mail = el("epost").value.trim();

  const d = el("datum").value;
  const t = el("tid").value;
  const mt = el("motestyp").value;
  const pl = el("plats").value.trim();

  // Prisuppdelning p√• totalen EFTER ROT (exkl moms)
  const total = afterRot;
  const etablering = total * 0.05;
  const arbete     = total * 0.55;
  const material   = total * 0.40;

  const hamtaKakel = el("hamta_kakel").checked;
  const hamtaInred = el("hamta_inredning").checked;

  // √ñvrigt-rader (f√∂r att det ska framg√•)
  const otherLines = state.other
    .map(r => {
      const txt = (r.text||"").trim();
      const amt = Math.max(0, parseFloat(r.amount||"0") || 0);
      if(!txt && !amt) return null;
      return `<li>${escapeHtml(txt || "√ñvrigt")} ‚Äì <strong>${formatSEK(amt)}</strong> (exkl. moms)</li>`;
    })
    .filter(Boolean)
    .join("");

  const notes = el("notes").value.trim();

  // Byt till din faktiska loggfil i repo om du vill:
  const LOGO_SRC = "Petra Bygg.jpeg"; // ex: "logo.png" om du har den i repo

  return `
  <!doctype html>
  <html lang="sv">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Petrabadrum ‚Äì Underlag</title>
    <style>
      body{ margin:0; background:#fff; font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#0b1a33; }
      .page{
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto;
        padding: 18mm 16mm;
        box-sizing:border-box;
      }
      .header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:16px;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 10mm;
        margin-bottom: 8mm;
      }
      .logo{
        height: 22mm;
        width:auto;
        object-fit:contain;
      }
      .title{
        text-align:right;
      }
      .title h1{ margin:0; font-size:18pt; letter-spacing:.2px; }
      .title .sub{ margin-top:2mm; color:#4b5563; font-weight:700; }

      h2{ margin: 8mm 0 3mm; font-size: 12.5pt; color:#163a7a; }
      .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 6mm 10mm; }
      .kv{
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px 12px;
      }
      .k{ color:#6b7280; font-weight:800; font-size:10pt; margin-bottom:2mm; }
      .v{ font-weight:900; font-size:11pt; }

      ul{ margin:3mm 0 0 5mm; }
      li{ margin: 1.5mm 0; }

      .sectionBox{
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px 12px;
        margin-top: 4mm;
      }
      .priceTable{
        width:100%;
        border-collapse:collapse;
        margin-top: 2mm;
      }
      .priceTable td{
        padding: 3mm 0;
        border-bottom: 1px solid #eef2f7;
        font-size: 11pt;
      }
      .priceTable td:last-child{ text-align:right; font-weight:1000; }
      .muted{ color:#6b7280; font-weight:800; }
      .big{ font-size: 13pt; }
      .note{
        white-space: pre-wrap;
        font-size: 10.5pt;
        line-height: 1.35;
      }
      @media print{
        @page{ size:A4; margin:0; }
        .page{ padding: 18mm 16mm; }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header">
        <div>
          <img class="logo" src="${LOGO_SRC}" alt="Petra Bygg & Renovering AB" onerror="this.style.display='none'">
          <div style="font-weight:900; color:#163a7a; margin-top:2mm;">PETRA BYGG & RENOVERING AB</div>
        </div>
        <div class="title">
          <h1>Offertunderlag f√∂r badrumsrenovering</h1>
          <div class="sub">Petrabadrum</div>
        </div>
      </div>

      <!-- Beh√•ll sammanfattningens √∂vre del till Prisuppdelning -->
      <h2>Kunduppgifter</h2>
      <div class="grid2">
        <div class="kv"><div class="k">Kundnamn</div><div class="v">${escapeHtml(name || "-")}</div></div>
        <div class="kv"><div class="k">Adress</div><div class="v">${escapeHtml(addr || "-")}</div></div>
        <div class="kv"><div class="k">Telefon</div><div class="v">${escapeHtml(tel || "-")}</div></div>
        <div class="kv"><div class="k">E-post</div><div class="v">${escapeHtml(mail || "-")}</div></div>
      </div>

      <h2>M√∂tesdata</h2>
      <div class="grid2">
        <div class="kv"><div class="k">Datum</div><div class="v">${escapeHtml(d || "-")}</div></div>
        <div class="kv"><div class="k">Tid</div><div class="v">${escapeHtml(t || "-")}</div></div>
        <div class="kv"><div class="k">M√∂testyp</div><div class="v">${escapeHtml(mt || "-")}</div></div>
        <div class="kv"><div class="k">Plats</div><div class="v">${escapeHtml(pl || "-")}</div></div>
      </div>

      <h2>Service √•t kund</h2>
      <div class="sectionBox">
        <ul>
          <li>Vi h√§mtar kakel & klinker √•t kund: <strong>${yesNo(hamtaKakel)}</strong>${hamtaKakel ? " (+5 000 kr)" : ""}</li>
          <li>Vi h√§mtar badrumsinredning √•t kund: <strong>${yesNo(hamtaInred)}</strong>${hamtaInred ? " (+5 000 kr)" : ""}</li>
        </ul>
      </div>

      ${otherLines ? `
      <h2>√ñvrigt</h2>
      <div class="sectionBox">
        <ul>${otherLines}</ul>
      </div>` : ``}

      ${notes ? `
      <h2>Anteckningar</h2>
      <div class="sectionBox note">${escapeHtml(notes)}</div>` : ``}

      <h2>Prisuppdelning</h2>
      <div class="sectionBox">
        <div class="muted">Pris efter ROT-avdrag (exkl. moms)</div>
        <div class="big" style="font-weight:1100; margin-top:2mm;">${formatSEK(total)}</div>

        <table class="priceTable">
          <tr><td>Etablering (5%)</td><td>${formatSEK(etablering)}</td></tr>
          <tr><td>Arbetskostnad (55%)</td><td>${formatSEK(arbete)}</td></tr>
          <tr><td>Materialkostnad (40%)</td><td>${formatSEK(material)}</td></tr>
        </table>

        <div style="margin-top:4mm; display:flex; justify-content:space-between; gap:10mm;">
          <div class="muted">ROT-belopp</div>
          <div style="font-weight:1000;">-${formatSEK(rotAmt)}</div>
        </div>
        <div style="margin-top:2mm; display:flex; justify-content:space-between; gap:10mm;">
          <div class="muted">Pris efter ROT-avdrag (inkl. moms)</div>
          <div style="font-weight:1100;">${formatSEK(afterRotInc)}</div>
        </div>
      </div>

      <div style="margin-top:10mm; color:#6b7280; font-size:9.5pt;">
        Priset √§r prelimin√§rt. Slutlig offert tas fram av entrepren√∂r. Priser ovan avser efter ROT-avdrag.
      </div>
    </div>
  </body>
  </html>
  `;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

/* ==============
   KALENDER (ICS)
   ============== */
function pad2(n){ return String(n).padStart(2,"0"); }
function toICSDateTime(dateStr, timeStr){
  if(!dateStr || !timeStr) return null;
  const [Y,M,D] = dateStr.split("-").map(Number);
  const [h,m] = timeStr.split(":").map(Number);
  return `${Y}${pad2(M)}${pad2(D)}T${pad2(h)}${pad2(m)}00`;
}
function download(filename, text, mime="text/plain"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function addToCalendar(){
  const d = el("datum").value;
  const t = el("tid").value;
  if(!d || !t){ alert("Fyll i Datum och Tid f√∂rst."); return; }

  const dtStart = toICSDateTime(d,t);
  const end = new Date(`${d}T${t}:00`);
  end.setMinutes(end.getMinutes()+60);
  const dtEnd = `${end.getFullYear()}${pad2(end.getMonth()+1)}${pad2(end.getDate())}T${pad2(end.getHours())}${pad2(end.getMinutes())}00`;

  const title = `Kundbes√∂k ‚Äì ${el("kundnamn").value.trim() || "Petrabadrum"}`;
  const loc = el("plats").value.trim() || el("adress").value.trim();
  const desc = "Bokat via Petrabadrum (offertunderlag).";

  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Petrabadrum//SE
CALSCALE:GREGORIAN
BEGIN:VEVENT
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${title}
LOCATION:${loc}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

  download("kundbesok.ics", ics, "text/calendar");
}

/* ==============
   Spara / PDF / Kopiera
   ============== */

function buildTextForCopy(){
  const { uplifted, rotAmt, afterRot } = calcTotals();
  const total = afterRot;
  const etablering = total * 0.05;
  const arbete     = total * 0.55;
  const material   = total * 0.40;

  const lines = [];
  lines.push("Petrabadrum ‚Äì Offertunderlag");
  lines.push("");

  lines.push("Kund:");
  lines.push(`‚Ä¢ Namn: ${el("kundnamn").value.trim() || "-"}`);
  lines.push(`‚Ä¢ Adress: ${el("adress").value.trim() || "-"}`);
  lines.push(`‚Ä¢ Telefon: ${el("telefon").value.trim() || "-"}`);
  lines.push(`‚Ä¢ E-post: ${el("epost").value.trim() || "-"}`);
  lines.push("");

  lines.push("M√∂te:");
  lines.push(`‚Ä¢ Datum: ${el("datum").value || "-"}`);
  lines.push(`‚Ä¢ Tid: ${el("tid").value || "-"}`);
  lines.push(`‚Ä¢ M√∂testyp: ${el("motestyp").value || "-"}`);
  lines.push(`‚Ä¢ Plats: ${el("plats").value.trim() || "-"}`);
  lines.push("");

  lines.push("Service √•t kund:");
  lines.push(`‚Ä¢ H√§mtar kakel & klinker: ${el("hamta_kakel").checked ? "Ja (+5 000)" : "Nej"}`);
  lines.push(`‚Ä¢ H√§mtar badrumsinredning: ${el("hamta_inredning").checked ? "Ja (+5 000)" : "Nej"}`);
  lines.push("");

  lines.push("Prisuppdelning (pris efter ROT-avdrag, exkl. moms):");
  lines.push(`‚Ä¢ Total: ${formatSEK(total)}`);
  lines.push(`‚Ä¢ Etablering (5%): ${formatSEK(etablering)}`);
  lines.push(`‚Ä¢ Arbetskostnad (55%): ${formatSEK(arbete)}`);
  lines.push(`‚Ä¢ Materialkostnad (40%): ${formatSEK(material)}`);
  lines.push(`‚Ä¢ ROT-belopp: -${formatSEK(rotAmt)}`);

  return lines.join("\n");
}

function copyText(){
  const txt = buildTextForCopy();
  navigator.clipboard?.writeText(txt).then(()=>{
    alert("Text kopierad.");
  }).catch(()=>{
    alert("Kunde inte kopiera automatiskt i denna webbl√§sare.");
  });
}

async function savePack(){
  // Spara som .html (A4) s√• du enkelt kan dela/spara i iCloud via Filer
  const html = buildA4HTML();
  const safeName = (el("kundnamn").value.trim() || "kund")
    .replace(/[^\w√•√§√∂√Ö√Ñ√ñ\- ]+/g,"").trim().replace(/\s+/g,"_");
  const filename = `Petrabadrum_${safeName}.html`;
  download(filename, html, "text/html");

  // F√∂rs√∂k √∂ppna delning (iOS)
  try{
    if(navigator.share){
      const file = new File([html], filename, {type:"text/html"});
      await navigator.share({ title: "Petrabadrum ‚Äì underlag", files: [file] });
    }
  }catch(e){}
}

function saveAsPDF(){
  const html = buildA4HTML();
  const w = window.open("", "_blank");
  if(!w){ alert("Popup blockerad. Till√•t popup-f√∂nster f√∂r att spara PDF."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  // L√•t rendera och trigga print
  setTimeout(()=> w.print(), 250);
}

/* ==============
   RESET
   ============== */
function resetAll(){
  if(!confirm("Nollst√§ll allt? (Detta rensar alla f√§lt, val, √ñvrigt och sparad data.)")) return;
  try{ localStorage.removeItem(LS_KEY); }catch(e){}
  document.querySelectorAll("input, textarea, select").forEach(node=>{
    if(node.type === "checkbox") node.checked = false;
    else node.value = "";
  });
  state.other = [{text:"", amount:""}];
  renderOtherRows();
  syncDateTimePills();
  saveToLS();
}

/* ==============
   INIT
   ============== */
function init(){
  bindAutoSave();
  initPillClicks();

  el("calendarIconBtn").addEventListener("click", addToCalendar);
  el("calcBtn").addEventListener("click", ()=> alert("Klar. Anv√§nd 'Spara som PDF' f√∂r A4-sammanfattning."));
  el("copyBtn").addEventListener("click", copyText);
  el("saveBtn").addEventListener("click", savePack);
  el("pdfBtn").addEventListener("click", saveAsPDF);
  el("resetBtn").addEventListener("click", resetAll);

  el("otherBtn").addEventListener("click", openOther);
  el("closeOther").addEventListener("click", closeOther);
  el("modalBack").addEventListener("click", (e)=>{ if(e.target === el("modalBack")) closeOther(); });
  el("addOtherRow").addEventListener("click", ()=>{
    state.other.push({text:"", amount:""});
    renderOtherRows();
    saveToLS();
  });

  renderOtherRows();
  syncDateTimePills();
  loadFromLS();
}
init();
</script>
</body>
</html>
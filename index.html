no<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petrabadrum ‚Äì Offertunderlag</title>
  <style>
    :root{
      --bg:#eef2f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#1d4ed8;
      --btn:#e9eef6;
      --btnText:#0f172a;
      --pill:#f8fafc; ppl
      --chosenBg:#e8f5e9;
      --shadow:0 12px 26px rgba(15,23,42,.08);
      --radius:18px;
      --radiusSm:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:linear-gradient(180deg,#f7f9fc 0%, var(--bg) 45%, #edf2f7 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 36px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 6px 14px;}
    .brand{display:flex;align-items:center;gap:10px;color:#0b2a6a;letter-spacing:.2px}
    .brand img{width:34px;height:34px;object-fit:contain;border-radius:10px;background:#fff;border:1px solid var(--line)}
    .brand .name{font-weight:700}
    .actions{display:flex;gap:10px;align-items:center}

    .btn{
      appearance:none;border:1px solid var(--line);
      background:var(--btn);color:var(--btnText);
      border-radius:999px;padding:10px 14px;
      font-weight:650;letter-spacing:.1px;
      box-shadow:0 6px 14px rgba(15,23,42,.06);
      min-height:44px;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{background:var(--brand);color:#fff;border-color:transparent}
    .btnGhost{background:#fff}

    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:var(--radius);box-shadow:var(--shadow);
      padding:16px;margin:12px 0;
    }
    .card h2{margin:0 0 6px;font-size:22px;font-weight:800;letter-spacing:.2px;color:#0b2a6a;}
    .card .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.35;font-weight:500;}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px 12px;}
    @media (max-width:700px){.grid2{grid-template-columns:1fr 1fr;}}

    label{display:block;font-size:12px;color:var(--muted);font-weight:700;letter-spacing:.2px;margin:0 0 6px;}
    .field,.select,.pillBtn{
      width:100%;border:1px solid var(--line);border-radius:var(--radiusSm);
      background:var(--pill);padding:12px 12px;
      font-size:15px;font-weight:600;color:var(--text);outline:none;min-height:48px;
    }
    .field::placeholder{color:#94a3b8;font-weight:600}
    .select{padding-right:38px}

    .chosen{
      background:var(--chosenBg) !important;
      border-color:rgba(46,125,50,.65) !important;
      box-shadow:0 8px 18px rgba(46,125,50,.10);
      color:#0b3d1a !important;
    }

    .checkRow{display:grid;grid-template-columns:1fr;gap:10px;margin-top:6px;}
    .check{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--line);
      border-radius:var(--radiusSm);
      background:#fbfdff;
      padding:10px 12px;
      font-weight:600;
    }
    .check input{width:18px;height:18px}
    .check .lbl{margin:0;font-size:14.5px;color:#0f172a;font-weight:650}

    .twoBtns{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
    .note{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px;font-weight:500;}

    .priceBox{
      border:2px dashed #cbd5e1;border-radius:18px;
      padding:16px 16px;background:#fbfdff;margin-top:12px;
    }
    .priceRow{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:9px 0;color:#0f172a;font-weight:700;
    }
    .priceRow small{color:var(--muted);font-weight:650;line-height:1.25}
    .priceRow span{line-height:1.25}
    .priceBig{
      font-size:18px;font-weight:900;color:#0b2a6a;
      padding-top:12px;border-top:1px solid var(--line);margin-top:10px;
    }

    .textarea{
      width:100%;min-height:110px;resize:vertical;
      border:1px solid var(--line);border-radius:var(--radiusSm);
      padding:12px;font-size:14px;font-weight:600;background:#fbfdff;outline:none;
    }
    .textarea::placeholder{color:#94a3b8;font-weight:600}

    /* Overlays */
    .overlay{
      position:fixed;inset:0;background:rgba(2,6,23,.55);
      display:none;align-items:flex-end;justify-content:center;
      padding:14px;z-index:9999;
    }
    .sheet{
      width:min(780px,100%);
      background:#fff;border-radius:18px;
      border:1px solid rgba(226,232,240,.8);
      box-shadow:0 18px 40px rgba(15,23,42,.25);
      padding:14px;
      max-height:85vh;overflow:auto;
    }
    .sheetHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;}
    .sheetHeaderLeft{display:flex;align-items:center;gap:10px}
    .sheetHeaderLeft img{width:34px;height:34px;object-fit:contain;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    .sheetTitle{margin:0;font-size:16px;font-weight:900;color:#0b2a6a}
    .sheetSub{margin:0 0 10px;color:var(--muted);font-size:12px;line-height:1.35}
    .sheetBox{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fbfdff;margin:10px 0;}
    .kvGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px 12px;font-size:13px;}
    .kv{display:flex;gap:8px}
    .k{min-width:120px;color:#334155;font-weight:900}
    .v{color:#0f172a;font-weight:650}
    .sheetBtns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}

    /* iOS-lik action sheet */
    .actionSheet{
      width:min(520px,100%);
      background:transparent;border:none;box-shadow:none;padding:0;max-height:85vh;
    }
    .asGroup{
      background:#fff;border-radius:16px;border:1px solid rgba(226,232,240,.8);
      box-shadow:0 18px 40px rgba(15,23,42,.25);overflow:hidden;
    }
    .asHeader{padding:14px 14px 10px;border-bottom:1px solid #e5e7eb;}
    .asTitle{margin:0;font-size:15px;font-weight:900;color:#0b2a6a}
    .asSub{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.35}
    .asBtn{
      width:100%;
      appearance:none;
      border:0;
      border-top:1px solid #e5e7eb;
      background:#fff;
      padding:14px;
      font-size:16px;
      font-weight:800;
      color:#0f172a;
      text-align:center;
    }
    .asBtn:active{background:#f1f5f9}
    .asCancel{
      margin-top:10px;
      background:#fff;border-radius:16px;border:1px solid rgba(226,232,240,.8);
      box-shadow:0 18px 40px rgba(15,23,42,.25);
      overflow:hidden;
    }
    .asCancel .asBtn{border-top:0;color:#ef4444}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <img id="logoTop" alt="Petra" />
        <div class="name">Petrabadrum</div>
      </div>
      <div class="actions">
        <button class="btn" id="resetBtn" type="button">Nollst√§ll</button>
      </div>
    </div>

    <!-- KUNDUPPGIFTER + M√ñTESDATA -->
    <div class="card" id="cardCustomer">
      <h2>Kunduppgifter</h2>
      <p class="sub">Fylls i vid f√∂rsta telefonkontakten och inf√∂r kundbes√∂k.</p>

      <div class="grid2">
        <div>
          <label for="kundnamn">Kundnamn</label>
          <input class="field" id="kundnamn" placeholder="Ex. Anna Andersson" />
        </div>
        <div>
          <label for="adress">Adress</label>
          <input class="field" id="adress" placeholder="Gata, postnummer, ort" />
        </div>

        <div>
          <label for="telefon">Telefon</label>
          <input class="field" id="telefon" inputmode="tel" />
        </div>
        <div>
          <label for="epost">E-post</label>
          <input class="field" id="epost" inputmode="email" />
        </div>
      </div>

      <div style="height:10px"></div>
      <h2 style="font-size:20px; margin-top:6px;">M√∂tesdata</h2>

      <div class="grid2">
        <div>
          <label for="datum">Datum</label>
          <select class="select" id="datum"></select>
        </div>

        <div style="position:relative;">
          <label for="tid">Tid</label>
          <div style="position:relative;">
            <select class="select" id="tid" style="padding-right:58px;"></select>
            <button id="calendarBtn" type="button"
              title="L√§gg till i kalender"
              style="position:absolute; right:8px; top:50%; transform:translateY(-50%);
                     width:40px; height:40px; border-radius:12px; border:1px solid var(--line);
                     background:#fff; font-weight:900; cursor:pointer;">
              üìÖ
            </button>
          </div>
        </div>

        <div>
          <label for="motestyp">M√∂testyp</label>
          <select class="select" id="motestyp">
            <option value="">Ej valt</option>
            <option>F√∂rsta bes√∂k</option>
            <option>√Öterbes√∂k</option>
            <option>Digitalt m√∂te</option>
          </select>
        </div>
        <div>
          <label for="plats">Plats</label>
          <input class="field" id="plats" placeholder="Hos kund, adress eller Teams-l√§nk" />
        </div>

        <div class="check" style="grid-column:1 / span 1;">
          <input type="checkbox" id="rotCheck" />
          <div class="lbl">Kund vill utnyttja ROT</div>
        </div>
        <div>
          <label for="rotBelopp">Belopp (ROT)</label>
          <input class="field" id="rotBelopp" inputmode="numeric" placeholder="0" />
        </div>
      </div>

      <div class="note">
        Kalenderknappen skapar en .ics-fil som du kan l√§gga till i iPhone-kalendern.
      </div>
    </div>

    <!-- BADRUMSDATA -->
    <div class="card">
      <h2>Badrumsdata</h2>
      <p class="sub">Valen anv√§nds f√∂r pris + sammanfattning.</p>

      <div class="grid2">
        <div>
          <label for="niva">Niv√•</label>
          <select class="select" id="niva">
            <option value="">Ej valt</option>
            <option value="standard">Standard</option>
            <option value="premium">Premium</option>
            <option value="exclusive">Exclusive</option>
          </select>
        </div>
        <div>
          <label for="storlek">Storlek (m¬≤)</label>
          <select class="select" id="storlek"></select>
        </div>
        <div>
          <label for="takh">Takh√∂jd (m)</label>
          <select class="select" id="takh"></select>
        </div>
        <div>
          <label for="flyttAvlopp">√Ñndra avloppsplacering</label>
          <select class="select" id="flyttAvlopp">
            <option value="nej">Nej</option>
            <option value="tra">Tr√§bj√§lklag</option>
            <option value="betong">Betongbj√§lklag</option>
          </select>
        </div>
      </div>
    </div>

    <!-- FUNKTIONER & UTRUSTNING -->
    <div class="card">
      <h2>Funktioner & utrustning</h2>
      <p class="sub">Kryssa i d√§r det √§r relevant. Prissatta val p√•verkar kalkylen.</p>

      <div class="checkRow">
        <div class="check"><input type="checkbox" id="wcVagg" /><div class="lbl">V√§ggh√§ngd WC</div></div>
        <div class="check"><input type="checkbox" id="wcGolv" /><div class="lbl">Golvst√•ende WC</div></div>
        <div class="check"><input type="checkbox" id="handdusch" /><div class="lbl">Handdusch vid toalett</div></div>
        <div class="check"><input type="checkbox" id="badkar" /><div class="lbl">Badkar</div></div>
        <div class="check"><input type="checkbox" id="enbartDusch" /><div class="lbl">Enbart dusch</div></div>
        <div class="check"><input type="checkbox" id="tvattmaskin" /><div class="lbl">Tv√§ttmaskin inkl el & avlopp</div></div>
        <div class="check"><input type="checkbox" id="undertak" /><div class="lbl">Nytt undertak / s√§nkt tak</div></div>
        <div class="check"><input type="checkbox" id="spacklaMala" /><div class="lbl">Spackling & m√•lning</div></div>
        <div class="check"><input type="checkbox" id="behallDorTroskel" /><div class="lbl">Beh√•lla befintlig d√∂rr & tr√∂skel</div></div>
        <div class="check"><input type="checkbox" id="nyDor" /><div class="lbl">Ny d√∂rr</div></div>
        <div class="check"><input type="checkbox" id="nyTroskel" /><div class="lbl">Ny tr√∂skel</div></div>
        <div class="check"><input type="checkbox" id="hamtaKakel" /><div class="lbl">Vi h√§mtar kakel & klinker √•t kund</div></div>
        <div class="check"><input type="checkbox" id="hamtaInredning" /><div class="lbl">Vi h√§mtar badrumsinredning √•t kund</div></div>
      </div>

      <div style="height:12px"></div>

      <div>
        <label>√ñvrigt</label>
        <button class="pillBtn" id="ovrigtBtn" type="button">L√§gg till poster</button>
        <div id="ovrigtList" style="margin-top:10px;"></div>
      </div>

      <div class="priceBox">
        <div class="priceRow"><small>Delsumma (exkl. moms, inkl. 10% h√∂jning)</small><span id="sumEx">0 kr</span></div>
        <div class="priceRow"><small>ROT-avdrag</small><span id="rotOut">-0 kr</span></div>
        <div class="priceRow priceBig"><span>Pris efter ROT-avdrag (exkl. moms)</span><span id="afterRotEx">0 kr</span></div>
        <div class="priceRow"><small>Pris efter ROT-avdrag (inkl. moms)</small><span id="afterRotInc">0 kr</span></div>
      </div>
    </div>

    <!-- ANTECKNINGAR + KNAPPAR -->
    <div class="card">
      <h2>Anteckningar</h2>
      <p class="sub">Frivilligt.</p>

      <textarea class="textarea" id="notes" placeholder="S√§rskilda f√∂ruts√§ttningar, tr√•nga utrymmen, parkering, tidsf√∂nster, bilder/video bifogas separat etc."></textarea>

      <div class="twoBtns">
        <button class="btn btnPrimary" id="calcBtn" type="button">Ber√§kna pris</button>
        <button class="btn" id="mailBtn" type="button">Maila</button>
        <button class="btn" id="saveBtn" type="button">Spara</button>
        <button class="btn" id="detailBtn" type="button">Detaljerad summering</button>
      </div>

      <div class="note">
        ‚ÄúSpara‚Äù √∂ppnar en meny (PDF/TXT/JSON). ‚ÄúMaila‚Äù √∂ppnar ett snyggt entrepren√∂rssheet med logga.
      </div>
    </div>

  </div>

  <!-- ACTION SHEET: SAVE -->
  <div class="overlay" id="saveOverlay" aria-hidden="true">
    <div class="actionSheet" role="dialog" aria-modal="true">
      <div class="asGroup">
        <div class="asHeader">
          <p class="asTitle">Spara</p>
          <p class="asSub">V√§lj format. P√• iPhone kan du sedan v√§lja plats via Dela/Spara i filer.</p>
        </div>
        <button class="asBtn" id="saveAsPdfBtn" type="button">Spara som PDF</button>
        <button class="asBtn" id="saveAsTxtBtn" type="button">Spara som TXT</button>
        <button class="asBtn" id="saveAsJsonBtn" type="button">Spara som JSON</button>
      </div>
      <div class="asCancel">
        <button class="asBtn" id="saveCancelBtn" type="button">Avbryt</button>
      </div>
    </div>
  </div>

  <!-- ENTREPREN√ñR SHEET (MAILA) -->
  <div class="overlay" id="mailOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div class="sheetHeaderLeft">
          <img id="logoMail" alt="Petra" />
          <div>
            <p class="sheetTitle">Entrepren√∂rssammanfattning</p>
            <p class="sheetSub" id="mailMeta"></p>
          </div>
        </div>
        <button class="btn btnGhost" id="mailCloseBtn" type="button">St√§ng</button>
      </div>

      <div class="sheetBox">
        <div class="kvGrid">
          <div class="kv"><div class="k">Kund:</div><div class="v" id="mKund">‚Äî</div></div>
          <div class="kv"><div class="k">Adress:</div><div class="v" id="mAdress">‚Äî</div></div>
          <div class="kv"><div class="k">Telefon:</div><div class="v" id="mTel">‚Äî</div></div>
          <div class="kv"><div class="k">E-post:</div><div class="v" id="mEpost">‚Äî</div></div>
        </div>
      </div>

      <div class="sheetBox">
        <div class="kvGrid">
          <div class="kv"><div class="k">Niv√•:</div><div class="v" id="mNiva">‚Äî</div></div>
          <div class="kv"><div class="k">Storlek:</div><div class="v" id="mStorlek">‚Äî</div></div>
          <div class="kv"><div class="k">Takh√∂jd:</div><div class="v" id="mTakh">‚Äî</div></div>
          <div class="kv"><div class="k">Avlopp:</div><div class="v" id="mAvlopp">‚Äî</div></div>
        </div>
      </div>

      <div class="sheetBox">
        <p style="margin:0 0 8px;font-weight:900;color:#0b2a6a">Val (Ja/Nej)</p>
        <div class="kvGrid" id="mVal"></div>
      </div>

      <div class="sheetBox">
        <p style="margin:0 0 8px;font-weight:900;color:#0b2a6a">Prisuppskattning</p>
        <div class="kvGrid">
          <div class="kv"><div class="k">Etablering (5%):</div><div class="v" id="mEtab">‚Äî</div></div>
          <div class="kv"><div class="k">Arbetskostnad (55%):</div><div class="v" id="mArb">‚Äî</div></div>
          <div class="kv"><div class="k">Material (40%):</div><div class="v" id="mMat">‚Äî</div></div>
        </div>
        <div style="margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px;font-weight:900;color:#0b2a6a">
          Totalt (efter ROT, exkl. moms): <span id="mTotal">‚Äî</span>
        </div>
        <div style="margin-top:6px;color:var(--muted);font-size:12px">
          (Radpriser visas inte h√§r ‚Äî detta √§r avsett att skickas till entrepren√∂ren.)
        </div>
      </div>

      <div class="sheetBox">
        <p style="margin:0 0 8px;font-weight:900;color:#0b2a6a">Anteckningar</p>
        <div id="mNotes" style="white-space:pre-wrap;font-weight:650;color:#0f172a">‚Äî</div>
      </div>

      <div class="sheetBtns">
        <button class="btn btnPrimary" id="mailShareBtn" type="button">Dela / Maila</button>
        <button class="btn" id="mailCopyBtn" type="button">Kopiera text</button>
      </div>

      <div class="note">
        ‚ÄúDela/Maila‚Äù f√∂rs√∂ker dela en HTML-fil med logga. Om din webbl√§sare inte st√∂djer filer √∂ppnas en ny flik med samma sammanfattning.
      </div>
    </div>
  </div>

  <!-- DETALJERAD (placeholder - beh√•ller din befintliga knapp) -->
  <div class="overlay" id="detailOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div class="sheetHeaderLeft">
          <img id="logoDetail" alt="Petra" />
          <div>
            <p class="sheetTitle">Detaljerad summering</p>
            <p class="sheetSub">Intern kontroll (inkl. priser).</p>
          </div>
        </div>
        <button class="btn btnGhost" id="detailCloseBtn" type="button">St√§ng</button>
      </div>

      <div class="sheetBox" id="detailBody"></div>

      <div class="sheetBtns">
        <button class="btn btnPrimary" id="detailSaveBtn" type="button">Spara</button>
        <button class="btn" id="detailCopyBtn" type="button">Kopiera</button>
      </div>

      <div class="note">‚ÄúSpara‚Äù h√§r √∂ppnar samma spara-meny (PDF/TXT/JSON).</div>
    </div>
  </div>

<script>
/* =========================
   KONFIG
========================= */
const STORAGE_KEY = "petrabadrum_form_v1";
const LOGO_SRC = "petrabygg_logo.png";

const PRICES = {
  PCT_UPLIFT: 0.10,
  VAT: 0.25,

  flyttAvlopp: { nej: 0, tra: 10000, betong: 20000 },
  hamtaService: 5000,

  // Baspris per m¬≤ (DU beh√•ller dina nuvarande ‚Äì l√§gg in exakt som i repo)
  basePerM2: {const BASE_PRICING = {
  start: {
    standard: 115000,
    premium: 135000,
    exclusive: 165000
  },
  perM2: {
    standard: 6500,
    premium: 8000,
    exclusive: 9500
  },
  sizeFactor: (m2)=> 1.0
  
  ceilingFactor: (h) => {
    if (h >= 2.8) return 1.10;
    if (h >= 2.5) return 1.05;
    return 1.00;
  }
};

/* =========================
   HJ√ÑLPARE
========================= */
const el = (id) => document.getElementById(id);
const fmt = (n) => (Math.round(n)).toLocaleString("sv-SE") + " kr";

function setLogos(){
  const ids = ["logoTop","logoMail","logoDetail"];
  ids.forEach(id=>{
    const img = el(id);
    img.src = LOGO_SRC;
    img.onerror = () => { img.style.display="none"; };
  });
}

function populateDateTime(){
  const dSel = el("datum");
  dSel.innerHTML = `<option value="">Datum</option>`;
  const now = new Date();
  for(let i=0;i<61;i++){
    const d = new Date(now);
    d.setDate(now.getDate()+i);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const val = `${y}-${m}-${day}`;
    const txt = `${day}/${m}/${y}`;
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = txt;
    dSel.appendChild(opt);
  }

  const tSel = el("tid");
  tSel.innerHTML = `<option value="">Tid</option>`;
  for(let h=7; h<=19; h++){
    for(let min=0; min<60; min+=15){
      const hh = String(h).padStart(2,"0");
      const mm = String(min).padStart(2,"0");
      const val = `${hh}:${mm}`;
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      tSel.appendChild(opt);
    }
  }
}

function populateBathroom(){
  const size = el("storlek");
  size.innerHTML = `<option value="">Ej valt</option>`;
  for(let i=2;i<=20;i++){
    const opt=document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i} m¬≤`;
    size.appendChild(opt);
  }

  const takh = el("takh");
  takh.innerHTML = `<option value="">Ej valt</option>`;
  for(let x=2.0; x<=3.0+1e-9; x+=0.1){
    const v = x.toFixed(1).replace(".", ",");
    const opt=document.createElement("option");
    opt.value = String(x.toFixed(1));
    opt.textContent = `${v} m`;
    takh.appendChild(opt);
  }
}

function markChosenUI(){
  document.querySelectorAll("select.select").forEach(s=>{
    if(s.value && s.value !== "nej") s.classList.add("chosen");
    else s.classList.remove("chosen");
  });
  const rb = el("rotBelopp");
  if((rb.value||"").trim() && Number(rb.value||0) > 0) rb.classList.add("chosen");
  else rb.classList.remove("chosen");
}

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function addOvrigtRow(text="", amount=0){
  const row = document.createElement("div");
  row.className = "grid2 ovrItem";
  row.style.marginTop="10px";
  row.innerHTML = `
    <div>
      <label>Post</label>
      <input class="field ovrText" placeholder="Ex. F√∂nsterbyte / Bygga in badkar" value="${escapeHtml(text)}" />
    </div>
    <div>
      <label>Belopp (kr)</label>
      <input class="field ovrAmount" inputmode="numeric" placeholder="0" value="${amount ? String(amount) : ""}" />
    </div>
  `;
  el("ovrigtList").appendChild(row);

  row.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", ()=>{ persist(); calc(); });
  });
}

function getState(){
  const ovr = [...document.querySelectorAll(".ovrItem")].map(row=>{
    const t = row.querySelector(".ovrText").value.trim();
    const a = Number((row.querySelector(".ovrAmount").value||"0").replace(/\s/g,"").replace(",", "."));
    return { text:t, amount:isFinite(a)?a:0 };
  }).filter(x=>x.text || x.amount);

  return {
    kundnamn: el("kundnamn").value.trim(),
    adress: el("adress").value.trim(),
    telefon: el("telefon").value.trim(),
    epost: el("epost").value.trim(),

    datum: el("datum").value,
    tid: el("tid").value,
    motestyp: el("motestyp").value,
    plats: el("plats").value.trim(),

    rotCheck: el("rotCheck").checked,
    rotBelopp: Number((el("rotBelopp").value||"0").replace(/\s/g,"").replace(",", ".")) || 0,

    niva: el("niva").value,
    storlek: Number(el("storlek").value||0) || 0,
    takh: Number(el("takh").value||0) || 0,

    checks: {
      wcVagg: el("wcVagg").checked,
      wcGolv: el("wcGolv").checked,
      handdusch: el("handdusch").checked,
      badkar: el("badkar").checked,
      enbartDusch: el("enbartDusch").checked,
      tvattmaskin: el("tvattmaskin").checked,
      undertak: el("undertak").checked,
      spacklaMala: el("spacklaMala").checked,
      behallDorTroskel: el("behallDorTroskel").checked,
      nyDor: el("nyDor").checked,
      nyTroskel: el("nyTroskel").checked,
      hamtaKakel: el("hamtaKakel").checked,
      hamtaInredning: el("hamtaInredning").checked
    },

    flyttAvlopp: el("flyttAvlopp").value,
    ovrigt: ovr,

    notes: el("notes").value
  };
}

function setState(s){
  if(!s) return;

  el("kundnamn").value = s.kundnamn || "";
  el("adress").value = s.adress || "";
  el("telefon").value = s.telefon || "";
  el("epost").value = s.epost || "";

  el("datum").value = s.datum || "";
  el("tid").value = s.tid || "";
  el("motestyp").value = s.motestyp || "";
  el("plats").value = s.plats || "";

  el("rotCheck").checked = !!s.rotCheck;
  el("rotBelopp").value = (s.rotBelopp ?? 0) ? String(s.rotBelopp) : "";

  el("niva").value = s.niva || "";
  el("storlek").value = s.storlek ? String(s.storlek) : "";
  el("takh").value = s.takh ? String(Number(s.takh).toFixed(1)) : "";

  const c = s.checks || {};
  Object.keys(c).forEach(k=>{
    const id = k;
    if (el(id)) el(id).checked = !!c[k];
  });

  el("flyttAvlopp").value = s.flyttAvlopp || "nej";
  el("notes").value = s.notes || "";

  el("ovrigtList").innerHTML = "";
  (s.ovrigt || []).forEach(x => addOvrigtRow(x.text, x.amount));

  markChosenUI();
}

function persist(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(getState()));
}

function restore(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{ setState(JSON.parse(raw)); }catch(e){}
}

function resetAll(){
  localStorage.removeItem(STORAGE_KEY);
  document.querySelectorAll("input, textarea").forEach(i=>{
    if(i.type === "checkbox") i.checked = false;
    else i.value = "";
  });
  document.querySelectorAll("select").forEach(s=> s.value = "");
  el("flyttAvlopp").value = "nej";
  el("ovrigtList").innerHTML = "";
  updatePriceUI(0,0,0,0);
  markChosenUI();
}

/* =========================
   PRISLOGIK (samma uppl√§gg som din fil)
========================= */
function calc(){
  const s = getState();

  let base = 0;
  if(s.niva && s.storlek){
    const per = PRICES.basePerM2[s.niva] || 0;
    base = per * s.storlek;
    if(s.takh){
      base = base * PRICES.ceilingFactor(s.takh);
    }
  }

  let add = 0;
  add += PRICES.flyttAvlopp[s.flyttAvlopp] || 0;

  if(s.checks.hamtaKakel) add += PRICES.hamtaService;
  if(s.checks.hamtaInredning) add += PRICES.hamtaService;

  add += (s.ovrigt||[]).reduce((sum,x)=> sum + (Number(x.amount)||0), 0);

  let subtotal = (base + add) * (1 + PRICES.PCT_UPLIFT);

  let rot = 0;
  if(s.rotCheck){
    rot = Math.max(0, Number(s.rotBelopp)||0);
  }
  rot = Math.min(rot, subtotal);

  const afterRotEx = Math.max(0, subtotal - rot);
  const afterRotInc = afterRotEx * (1 + PRICES.VAT);

  updatePriceUI(subtotal, rot, afterRotEx, afterRotInc);
  markChosenUI();
  persist();
}

function updatePriceUI(subtotal=0, rot=0, afterRotEx=0, afterRotInc=0){
  el("sumEx").textContent = fmt(subtotal);
  el("rotOut").textContent = "-" + Math.round(rot).toLocaleString("sv-SE") + " kr";
  el("afterRotEx").textContent = fmt(afterRotEx);
  el("afterRotInc").textContent = fmt(afterRotInc);
}

function priceAfterRotExNumber(){
  const txt = (el("afterRotEx").textContent||"0").replaceAll("kr","").replace(/\s/g,"");
  const n = Number(txt.replaceAll(".","").replace(",","."));
  return isFinite(n) ? n : 0;
}

function splitCosts(totalEx){
  return {
    etab: totalEx * 0.05,
    arb:  totalEx * 0.55,
    mat:  totalEx * 0.40
  };
}

/* =========================
   KALENDER (.ics)
========================= */
function addToCalendar(){
  const s = getState();
  if(!s.datum || !s.tid){
    alert("Fyll i datum och tid f√∂rst.");
    return;
  }
  const [y,m,d] = s.datum.split("-").map(Number);
  const [hh,mm] = s.tid.split(":").map(Number);
  const start = new Date(y, m-1, d, hh, mm, 0);
  const end = new Date(start.getTime() + 60*60*1000);

  const pad = (n)=> String(n).padStart(2,"0");
  const toICS = (dt)=> `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}00`;

  const title = `Kundbes√∂k: ${s.kundnamn || "Badrum"}`;
  const loc = s.plats || s.adress || "";
  const desc = `Petrabadrum ‚Äì offertunderlag.\nM√∂testyp: ${s.motestyp||"‚Äî"}\nTelefon: ${s.telefon||"‚Äî"}\nE-post: ${s.epost||"‚Äî"}`;

  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Petrabadrum//SE
BEGIN:VEVENT
DTSTART:${toICS(start)}
DTEND:${toICS(end)}
SUMMARY:${title}
LOCATION:${loc}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `petrabadrum_mote_${s.datum}_${s.tid.replace(":","")}.ics`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   ACTION SHEET: SAVE
========================= */
function openSaveSheet(){
  el("saveOverlay").style.display = "flex";
  el("saveOverlay").setAttribute("aria-hidden","false");
}
function closeSaveSheet(){
  el("saveOverlay").style.display = "none";
  el("saveOverlay").setAttribute("aria-hidden","true");
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function buildPlainText(includePrices=true){
  calc();
  const s = getState();
  const totalEx = priceAfterRotExNumber();
  const split = splitCosts(totalEx);

  const yesNo = (b)=> b ? "Ja" : "Nej";
  const avloppTxt = s.flyttAvlopp === "nej" ? "Nej" : (s.flyttAvlopp === "tra" ? "Tr√§bj√§lklag" : "Betongbj√§lklag");

  const lines = [];
  lines.push("PETRABADRUM ‚Äì Sammanfattning");
  lines.push("");
  lines.push(`Kund: ${s.kundnamn || "‚Äî"}`);
  lines.push(`Adress: ${s.adress || "‚Äî"}`);
  lines.push(`Telefon: ${s.telefon || "‚Äî"}`);
  lines.push(`E-post: ${s.epost || "‚Äî"}`);
  lines.push("");
  lines.push(`M√∂te: ${s.datum || "‚Äî"} ${s.tid || ""} ‚Ä¢ ${s.motestyp || "‚Äî"} ‚Ä¢ ${s.plats || "‚Äî"}`);
  lines.push("");
  lines.push(`Niv√•: ${s.niva || "‚Äî"} ‚Ä¢ Storlek: ${s.storlek ? s.storlek+" m¬≤" : "‚Äî"} ‚Ä¢ Takh√∂jd: ${s.takh ? String(s.takh).replace(".",",")+" m" : "‚Äî"}`);
  lines.push(`√Ñndra avloppsplacering: ${avloppTxt}`);
  lines.push("");
  lines.push("Val:");
  lines.push(`- V√§ggh√§ngd WC: ${yesNo(s.checks.wcVagg)}`);
  lines.push(`- Golvst√•ende WC: ${yesNo(s.checks.wcGolv)}`);
  lines.push(`- Handdusch: ${yesNo(s.checks.handdusch)}`);
  lines.push(`- Badkar: ${yesNo(s.checks.badkar)}`);
  lines.push(`- Enbart dusch: ${yesNo(s.checks.enbartDusch)}`);
  lines.push(`- Tv√§ttmaskin: ${yesNo(s.checks.tvattmaskin)}`);
  lines.push(`- Undertak/s√§nkt tak: ${yesNo(s.checks.undertak)}`);
  lines.push(`- Spackling & m√•lning: ${yesNo(s.checks.spacklaMala)}`);
  lines.push(`- Beh√•lla d√∂rr & tr√∂skel: ${yesNo(s.checks.behallDorTroskel)}`);
  lines.push(`- Ny d√∂rr: ${yesNo(s.checks.nyDor)}`);
  lines.push(`- Ny tr√∂skel: ${yesNo(s.checks.nyTroskel)}`);
  lines.push(`- Vi h√§mtar kakel & klinker: ${yesNo(s.checks.hamtaKakel)}`);
  lines.push(`- Vi h√§mtar badrumsinredning: ${yesNo(s.checks.hamtaInredning)}`);

  if ((s.ovrigt||[]).length){
    lines.push("");
    lines.push("√ñvrigt:");
    s.ovrigt.forEach((x,i)=>{
      lines.push(`- ${i+1}. ${x.text || "‚Äî"} (${Math.round(x.amount||0).toLocaleString("sv-SE")} kr)`);
    });
  }

  lines.push("");
  lines.push("Anteckningar:");
  lines.push(s.notes || "‚Äî");

  if(includePrices){
    lines.push("");
    lines.push("Pris (efter ROT, exkl moms): " + el("afterRotEx").textContent);
    lines.push("Etablering (5%): " + fmt(split.etab));
    lines.push("Arbetskostnad (55%): " + fmt(split.arb));
    lines.push("Material (40%): " + fmt(split.mat));
  }

  return lines.join("\n");
}

function saveAsTXT(){
  const s = getState();
  const safeName = (s.kundnamn || "kund").replace(/[^\w√•√§√∂√Ö√Ñ√ñ-]+/g,"_");
  const blob = new Blob([buildPlainText(true)], {type:"text/plain;charset=utf-8"});
  downloadBlob(blob, `petrabadrum_${safeName}_${(s.datum||"datum")}.txt`);
}

function saveAsJSON(){
  calc();
  const s = getState();
  const payload = {
    ...s,
    price: {
      subtotal_excl_vat_incl_uplift: el("sumEx").textContent,
      rot: el("rotOut").textContent,
      after_rot_excl_vat: el("afterRotEx").textContent,
      after_rot_incl_vat: el("afterRotInc").textContent
    },
    savedAt: new Date().toISOString()
  };
  const safeName = (s.kundnamn || "kund").replace(/[^\w√•√§√∂√Ö√Ñ√ñ-]+/g,"_");
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json;charset=utf-8"});
  downloadBlob(blob, `petrabadrum_${safeName}_${(s.datum||"datum")}.json`);
}

function saveAsPDF(){
  // PDF via print (iOS: Dela -> Spara i filer)
  openPrintablePage(buildEntrepreneurHTML({includePrices:true, detailed:true}));
}

function openPrintablePage(html){
  const w = window.open("", "_blank");
  if(!w){ alert("Till√•t popup-f√∂nster f√∂r att spara/skriva ut."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
  setTimeout(()=>{ try{ w.focus(); }catch(e){} }, 120);
}

/* =========================
   ENTREPREN√ñR SHEET (MAILA)
========================= */
function openMailSheet(){
  buildMailSheetUI();
  el("mailOverlay").style.display="flex";
  el("mailOverlay").setAttribute("aria-hidden","false");
}
function closeMailSheet(){
  el("mailOverlay").style.display="none";
  el("mailOverlay").setAttribute("aria-hidden","true");
}

function buildMailSheetUI(){
  calc();
  const s = getState();
  const metaParts = [];
  if(s.datum) metaParts.push(`Datum: ${s.datum}`);
  if(s.tid) metaParts.push(`Tid: ${s.tid}`);
  if(s.motestyp) metaParts.push(`M√∂testyp: ${s.motestyp}`);
  if(s.plats) metaParts.push(`Plats: ${s.plats}`);
  el("mailMeta").textContent = metaParts.join("  ‚Ä¢  ");

  el("mKund").textContent = s.kundnamn || "‚Äî";
  el("mAdress").textContent = s.adress || "‚Äî";
  el("mTel").textContent = s.telefon || "‚Äî";
  el("mEpost").textContent = s.epost || "‚Äî";

  el("mNiva").textContent = s.niva ? (s.niva[0].toUpperCase()+s.niva.slice(1)) : "‚Äî";
  el("mStorlek").textContent = s.storlek ? `${s.storlek} m¬≤` : "‚Äî";
  el("mTakh").textContent = s.takh ? `${String(s.takh).replace(".", ",")} m` : "‚Äî";
  el("mAvlopp").textContent = s.flyttAvlopp === "nej" ? "Nej" : (s.flyttAvlopp === "tra" ? "Tr√§bj√§lklag" : "Betongbj√§lklag");

  const pairs = [];
  const c = s.checks || {};
  const yesNo = (b)=> b ? "Ja" : "Nej";
  pairs.push(["V√§ggh√§ngd WC", yesNo(c.wcVagg)]);
  pairs.push(["Golvst√•ende WC", yesNo(c.wcGolv)]);
  pairs.push(["Handdusch vid toalett", yesNo(c.handdusch)]);
  pairs.push(["Badkar", yesNo(c.badkar)]);
  pairs.push(["Enbart dusch", yesNo(c.enbartDusch)]);
  pairs.push(["Tv√§ttmaskin", yesNo(c.tvattmaskin)]);
  pairs.push(["Undertak/s√§nkt tak", yesNo(c.undertak)]);
  pairs.push(["Spackling & m√•lning", yesNo(c.spacklaMala)]);
  pairs.push(["Beh√•lla d√∂rr & tr√∂skel", yesNo(c.behallDorTroskel)]);
  pairs.push(["Ny d√∂rr", yesNo(c.nyDor)]);
  pairs.push(["Ny tr√∂skel", yesNo(c.nyTroskel)]);
  pairs.push(["H√§mta kakel & klinker", yesNo(c.hamtaKakel)]);
  pairs.push(["H√§mta badrumsinredning", yesNo(c.hamtaInredning)]);

  const box = el("mVal");
  box.innerHTML = "";
  pairs.forEach(([k,v])=>{
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<div class="k">${escapeHtml(k)}:</div><div class="v">${escapeHtml(v)}</div>`;
    box.appendChild(div);
  });

  const totalEx = priceAfterRotExNumber();
  const split = splitCosts(totalEx);
  el("mEtab").textContent = fmt(split.etab);
  el("mArb").textContent  = fmt(split.arb);
  el("mMat").textContent  = fmt(split.mat);
  el("mTotal").textContent = el("afterRotEx").textContent;

  el("mNotes").textContent = s.notes || "‚Äî";
}

async function getLogoDataURL(){
  // F√∂r att HTML-filen ska bli "standalone" (logga med)
  // f√∂rs√∂ker vi l√§sa in loggan och b√§dda in den som dataURL.
  try{
    const res = await fetch(LOGO_SRC, {cache:"force-cache"});
    const blob = await res.blob();
    return await new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }catch(e){
    return null;
  }
}

function buildEntrepreneurHTML({includePrices=false, detailed=false}={}){
  const s = getState();
  const totalEx = priceAfterRotExNumber();
  const split = splitCosts(totalEx);

  const yesNo = (b)=> b ? "Ja" : "Nej";
  const avloppTxt = s.flyttAvlopp === "nej" ? "Nej" : (s.flyttAvlopp === "tra" ? "Tr√§bj√§lklag" : "Betongbj√§lklag");

  const vals = [
    ["V√§ggh√§ngd WC", yesNo(s.checks.wcVagg)],
    ["Golvst√•ende WC", yesNo(s.checks.wcGolv)],
    ["Handdusch vid toalett", yesNo(s.checks.handdusch)],
    ["Badkar", yesNo(s.checks.badkar)],
    ["Enbart dusch", yesNo(s.checks.enbartDusch)],
    ["Tv√§ttmaskin", yesNo(s.checks.tvattmaskin)],
    ["Undertak/s√§nkt tak", yesNo(s.checks.undertak)],
    ["Spackling & m√•lning", yesNo(s.checks.spacklaMala)],
    ["Beh√•lla d√∂rr & tr√∂skel", yesNo(s.checks.behallDorTroskel)],
    ["Ny d√∂rr", yesNo(s.checks.nyDor)],
    ["Ny tr√∂skel", yesNo(s.checks.nyTroskel)],
    ["Vi h√§mtar kakel & klinker", yesNo(s.checks.hamtaKakel)],
    ["Vi h√§mtar badrumsinredning", yesNo(s.checks.hamtaInredning)],
    ["√Ñndra avloppsplacering", avloppTxt],
  ];

  const ovr = (s.ovrigt||[]).map((x,i)=> `<div class="row"><div class="k">√ñvrigt ${i+1}:</div><div class="v">${escapeHtml(x.text||"‚Äî")} (${Math.round(x.amount||0).toLocaleString("sv-SE")} kr)</div></div>`).join("");

  // Logo byts ut dynamiskt (dataURL) i share-filen
  return `<!doctype html>
<html lang="sv"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Petrabadrum ‚Äì Entrepren√∂rssammanfattning</title>
<style>
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0f172a;background:#fff}
  .a4{max-width:860px;margin:0 auto;padding:22px 18px}
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:14px;border-bottom:2px solid #e5e7eb;padding-bottom:12px;margin-bottom:14px}
  .hdr img{height:44px;object-fit:contain}
  .ttl{margin:0;font-size:18px;font-weight:900;color:#0b2a6a}
  .sub{margin:6px 0 0;color:#475569;font-weight:650;font-size:12px}
  .box{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fbfdff;margin:12px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px;font-size:13px}
  .row{display:flex;gap:10px}
  .k{min-width:140px;color:#334155;font-weight:900}
  .v{color:#0f172a;font-weight:650}
  .h3{margin:0 0 8px;font-size:14px;font-weight:900;color:#0b2a6a}
  .tot{margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px;font-weight:900;color:#0b2a6a}
  .muted{color:#64748b;font-size:12px;line-height:1.35;font-weight:600}
  @media print{.a4{width:210mm;min-height:297mm;padding:16mm 14mm}}
</style></head>
<body>
  <div class="a4">
    <div class="hdr">
      <img id="logo" alt="Petra" src="${LOGO_SRC}">
      <div style="flex:1">
        <p class="ttl">${detailed ? "Detaljerad summering (intern)" : "Entrepren√∂rssammanfattning"}</p>
        <p class="sub">${escapeHtml([s.datum&&("Datum: "+s.datum), s.tid&&("Tid: "+s.tid), s.motestyp&&("M√∂testyp: "+s.motestyp), s.plats&&("Plats: "+s.plats)].filter(Boolean).join("  ‚Ä¢  ") || "‚Äî")}</p>
      </div>
    </div>

    <div class="box">
      <p class="h3">Kund</p>
      <div class="grid">
        <div class="row"><div class="k">Namn:</div><div class="v">${escapeHtml(s.kundnamn||"‚Äî")}</div></div>
        <div class="row"><div class="k">Adress:</div><div class="v">${escapeHtml(s.adress||"‚Äî")}</div></div>
        <div class="row"><div class="k">Telefon:</div><div class="v">${escapeHtml(s.telefon||"‚Äî")}</div></div>
        <div class="row"><div class="k">E-post:</div><div class="v">${escapeHtml(s.epost||"‚Äî")}</div></div>
      </div>
    </div>

    <div class="box">
      <p class="h3">Badrumsdata</p>
      <div class="grid">
        <div class="row"><div class="k">Niv√•:</div><div class="v">${escapeHtml(s.niva ? (s.niva[0].toUpperCase()+s.niva.slice(1)) : "‚Äî")}</div></div>
        <div class="row"><div class="k">Storlek:</div><div class="v">${s.storlek ? escapeHtml(s.storlek+" m¬≤") : "‚Äî"}</div></div>
        <div class="row"><div class="k">Takh√∂jd:</div><div class="v">${s.takh ? escapeHtml(String(s.takh).replace(".",",")+" m") : "‚Äî"}</div></div>
        <div class="row"><div class="k">Avlopp:</div><div class="v">${escapeHtml(avloppTxt)}</div></div>
      </div>
    </div>

    <div class="box">
      <p class="h3">Val</p>
      <div class="grid">
        ${vals.map(([k,v])=>`<div class="row"><div class="k">${escapeHtml(k)}:</div><div class="v">${escapeHtml(v)}</div></div>`).join("")}
      </div>
      ${ovr ? `<div style="margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px">${ovr}</div>` : ``}
    </div>

    <div class="box">
      <p class="h3">Prisuppskattning</p>
      <div class="grid">
        <div class="row"><div class="k">Etablering (5%):</div><div class="v">${fmt(split.etab)}</div></div>
        <div class="row"><div class="k">Arbetskostnad (55%):</div><div class="v">${fmt(split.arb)}</div></div>
        <div class="row"><div class="k">Material (40%):</div><div class="v">${fmt(split.mat)}</div></div>
      </div>
      <div class="tot">Totalt (efter ROT, exkl. moms): ${escapeHtml(el("afterRotEx").textContent || "‚Äî")}</div>
      ${detailed ? `<div class="muted" style="margin-top:8px">Delsumma: ${escapeHtml(el("sumEx").textContent||"‚Äî")} ‚Ä¢ ROT: ${escapeHtml(el("rotOut").textContent||"‚Äî")} ‚Ä¢ Efter ROT inkl moms: ${escapeHtml(el("afterRotInc").textContent||"‚Äî")}</div>` : `<div class="muted" style="margin-top:8px">Radpriser visas inte h√§r.</div>`}
    </div>

    <div class="box">
      <p class="h3">Anteckningar</p>
      <div style="white-space:pre-wrap;font-weight:650">${escapeHtml(s.notes||"‚Äî")}</div>
    </div>
  </div>
</body></html>`;
}

async function shareEntrepreneurHTML(){
  const s = getState();
  const safeName = (s.kundnamn || "kund").replace(/[^\w√•√§√∂√Ö√Ñ√ñ-]+/g,"_");
  const filename = `petrabadrum_entreprenor_${safeName}_${(s.datum||"datum")}.html`;

  // B√§dda in logga som dataURL om m√∂jligt (s√• filen blir frist√•ende)
  let html = buildEntrepreneurHTML({includePrices:false, detailed:false});
  const dataUrl = await getLogoDataURL();
  if (dataUrl){
    html = html.replaceAll(`src="${LOGO_SRC}"`, `src="${dataUrl}"`);
  }

  const file = new File([html], filename, {type:"text/html"});
  const textFallback = buildPlainText(true);

  if (navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
    try{
      await navigator.share({
        title: "Petrabadrum ‚Äì entrepren√∂rssammanfattning",
        text: "Entrepren√∂rssammanfattning bifogad (HTML).",
        files: [file]
      });
      return;
    }catch(e){
      // anv√§nd fallback nedan
    }
  }

  // Fallback: √∂ppna ny flik med HTML (anv√§nd Dela manuellt)
  openPrintablePage(html);

  // extra fallback: kopiera text
  try{ await navigator.clipboard.writeText(textFallback); }catch(e){}
}

function copyEntrepreneurText(){
  const txt = buildPlainText(true);
  navigator.clipboard.writeText(txt)
    .then(()=> alert("Kopierat."))
    .catch(()=> alert("Kunde inte kopiera i denna webbl√§sare."));
}

/* =========================
   DETALJERAD SHEET (enkel)
========================= */
function openDetailSheet(){
  calc();
  const s = getState();
  const html = buildEntrepreneurHTML({includePrices:true, detailed:true});
  el("detailBody").innerHTML =
    `<div style="font-weight:900;color:#0b2a6a;margin-bottom:6px">Intern vy</div>
     <div class="note">√ñppnar du ‚ÄúSpara‚Äù kan du v√§lja PDF/TXT/JSON. (PDF = utskrift)</div>
     <div style="margin-top:10px">
       <button class="btn" type="button" onclick="(function(){ const w=window.open('','_blank'); if(w){ w.document.write(${JSON.stringify(html)}); w.document.close(); } })()">√ñppna som A4</button>
     </div>`;
  el("detailOverlay").style.display="flex";
  el("detailOverlay").setAttribute("aria-hidden","false");
}
function closeDetailSheet(){
  el("detailOverlay").style.display="none";
  el("detailOverlay").setAttribute("aria-hidden","true");
}

/* =========================
   EVENTS / INIT
========================= */
function bindEvents(){
  document.querySelectorAll("input, textarea, select").forEach(inp=>{
    inp.addEventListener("change", ()=>{ persist(); calc(); });
    inp.addEventListener("input", ()=>{ persist(); });
  });

  el("resetBtn").addEventListener("click", ()=>{
    if(confirm("Nollst√§lla allt?")) resetAll();
  });

  el("ovrigtBtn").addEventListener("click", ()=>{
    addOvrigtRow("", 0);
    persist();
  });

  el("calcBtn").addEventListener("click", calc);
  el("calendarBtn").addEventListener("click", addToCalendar);

  // Maila (sheet)
  el("mailBtn").addEventListener("click", openMailSheet);
  el("mailCloseBtn").addEventListener("click", closeMailSheet);
  el("mailShareBtn").addEventListener("click", shareEntrepreneurHTML);
  el("mailCopyBtn").addEventListener("click", copyEntrepreneurText);

  // Save action sheet
  el("saveBtn").addEventListener("click", openSaveSheet);
  el("saveCancelBtn").addEventListener("click", closeSaveSheet);
  el("saveAsPdfBtn").addEventListener("click", ()=>{ closeSaveSheet(); saveAsPDF(); });
  el("saveAsTxtBtn").addEventListener("click", ()=>{ closeSaveSheet(); saveAsTXT(); });
  el("saveAsJsonBtn").addEventListener("click", ()=>{ closeSaveSheet(); saveAsJSON(); });

  // Close on overlay click (tap outside)
  el("saveOverlay").addEventListener("click", (e)=>{ if(e.target === el("saveOverlay")) closeSaveSheet(); });
  el("mailOverlay").addEventListener("click", (e)=>{ if(e.target === el("mailOverlay")) closeMailSheet(); });
  el("detailOverlay").addEventListener("click", (e)=>{ if(e.target === el("detailOverlay")) closeDetailSheet(); });

  // Detail sheet
  el("detailBtn").addEventListener("click", openDetailSheet);
  el("detailCloseBtn").addEventListener("click", closeDetailSheet);
  el("detailSaveBtn").addEventListener("click", openSaveSheet);
  el("detailCopyBtn").addEventListener("click", ()=> copyEntrepreneurText());
}

(function init(){
  setLogos();
  populateDateTime();
  populateBathroom();
  bindEvents();
  restore();
  calc();
})();
</script>
</body>
</html>
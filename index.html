<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petrabadrum ‚Äì Offertunderlag</title>
  <style>
    :root{
      --bg:#eef2f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#1d4ed8;
      --btn:#e9eef6;
      --btnText:#0f172a;
      --pill:#f8fafc;
      --chosenBg:#e8f5e9;
      --chosenBorder:#2e7d32;
      --shadow:0 12px 26px rgba(15,23,42,.08);
      --radius:18px;
      --radiusSm:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:linear-gradient(180deg,#f7f9fc 0%, var(--bg) 45%, #edf2f7 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px 14px 36px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 6px 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:650;
      color:#0b2a6a;
      letter-spacing:.2px;
    }
    .brand .brandText{font-size:18px;}
    .brand img{
      width:34px; height:34px; object-fit:contain;
      border-radius:10px;
      background:#fff;
      border:1px solid var(--line);
    }
    .brand .logoFallback{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      display:flex;align-items:center;justify-content:center;
    }

    .actions{display:flex; gap:10px; align-items:center;}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--btnText);
      border-radius:999px;
      padding:10px 14px;
      font-weight:650;
      letter-spacing:.1px;
      box-shadow:0 6px 14px rgba(15,23,42,.06);
      min-height:42px;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{
      background:var(--brand);
      color:#fff;
      border-color:transparent;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:12px 0;
    }
    .card h2{
      margin:0 0 6px;
      font-size:22px;
      font-weight:750; /* mindre ‚Äúbold‚Äù */
      letter-spacing:.2px;
      color:#0b2a6a;
    }
    .card .sub{
      margin:0 0 14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      font-weight:500;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px 12px;
    }
    @media (max-width:700px){
      .grid2{grid-template-columns:1fr 1fr;}
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:650;
      letter-spacing:.2px;
      margin:0 0 6px;
    }

    .field, .select, .pillBtn{
      width:100%;
      border:1px solid var(--line);
      border-radius:var(--radiusSm);
      background:var(--pill);
      padding:12px 12px;
      font-size:15px;
      font-weight:600;
      color:var(--text);
      outline:none;
      min-height:48px;
    }
    .field::placeholder{color:#94a3b8; font-weight:600}
    .select{padding-right:38px}

    .chosen{
      background:var(--chosenBg) !important;
      border-color:rgba(46,125,50,.65) !important;
      box-shadow:0 8px 18px rgba(46,125,50,.10);
      color:#0b3d1a !important;
    }

    /* Mindre klumpiga valrader */
    .checkRow{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:6px;
    }
    .check{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      border-radius:var(--radiusSm);
      background:#fbfdff;
      padding:10px 12px;      /* mindre padding */
      font-weight:600;        /* mindre bold */
      min-height:46px;
    }
    .check input{width:18px;height:18px}
    .check span{
      font-size:15px;
      font-weight:650;
      color:#0f172a;
    }

    .twoBtns{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }

    .note{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      margin-top:8px;
      font-weight:500;
    }

    /* Lufigare summeringsruta */
    .priceBox{
      border:2px dashed #cbd5e1;
      border-radius:18px;
      padding:18px 16px;      /* mer luft */
      background:#fbfdff;
      margin-top:14px;
    }
    .priceRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      padding:8px 0;          /* mer luft */
      color:#0f172a;
      font-weight:650;
    }
    .priceRow small{color:var(--muted); font-weight:650}
    .priceBig{
      font-size:18px;
      font-weight:800;
      color:#0b2a6a;
      padding-top:10px;
      border-top:1px solid var(--line);
      margin-top:8px;
      line-height:1.2;
    }
    .priceNum{
      font-weight:750;
      color:#0f172a;
      min-width:120px;
      text-align:right;
    }

    .textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:var(--radiusSm);
      padding:12px;
      font-size:14px;
      font-weight:600;
      background:#fbfdff;
      outline:none;
    }
    .textarea::placeholder{color:#94a3b8; font-weight:600}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(15,23,42,.42);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 24px 60px rgba(15,23,42,.25);
      padding:16px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .modalTitle{
      font-weight:750;
      color:#0b2a6a;
      font-size:16px;
      margin:0;
    }
    .modalBody{
      color:#0f172a;
      font-size:13px;
      line-height:1.45;
    }
    .monoBox{
      border:1px solid var(--line);
      background:#fbfdff;
      border-radius:12px;
      padding:12px;
      white-space:pre-wrap;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      max-height:52vh;
      overflow:auto;
    }
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:10px;
    }
    .radio{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fbfdff;
      font-weight:650;
      cursor:pointer;
    }
    .radio input{width:16px;height:16px}

    /* Print/PDF (A4) */
    .printOnly{display:none}
    @media print{
      body{background:#fff}
      .wrap{max-width:none; padding:0}
      .noPrint{display:none !important}
      .printOnly{display:block !important}
      .a4{
        width:210mm;
        min-height:297mm;
        padding:16mm 14mm;
      }
      .a4Header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        border-bottom:2px solid #e5e7eb;
        padding-bottom:10px;
        margin-bottom:12px;
      }
      .a4Header img{height:26mm; width:auto; object-fit:contain}
      .a4Title{font-size:18pt;font-weight:800;margin:0;}
      .a4Sub{margin:4px 0 0; color:#334155; font-weight:600}
      .a4Section{margin:12px 0}
      .a4Section h3{
        margin:0 0 6px;
        font-size:12.5pt;
        font-weight:800;
        color:#0f172a;
      }
      .a4Grid{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:8px 14px;
        font-size:11pt;
      }
      .kv{display:flex; gap:8px}
      .k{min-width:92px; color:#334155; font-weight:800}
      .v{color:#0f172a; font-weight:650}
      .a4Box{
        border:1px solid #e5e7eb;
        border-radius:10px;
        padding:10px;
      }
      .a4Price{
        font-size:13pt;
        font-weight:900;
        color:#0b2a6a;
      }
      .split{
        margin-top:10px;
        border-top:1px solid #e5e7eb;
        padding-top:10px;
      }
      .splitRow{
        display:flex; justify-content:space-between; gap:10px;
        font-size:11pt; font-weight:800;
        padding:4px 0;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar noPrint">
      <div class="brand">
        <div class="logoFallback" id="logoFallback" aria-hidden="true"></div>
        <img id="logoTop" alt="Petra" style="display:none;" />
        <div class="brandText">Petrabadrum</div>
      </div>
      <div class="actions">
        <button class="btn" id="resetBtn" type="button">Nollst√§ll</button>
      </div>
    </div>

    <!-- KUNDUPPGIFTER + M√ñTESDATA -->
    <div class="card noPrint" id="cardCustomer">
      <h2>Kunduppgifter</h2>
      <p class="sub">Fylls i vid f√∂rsta telefonkontakten och inf√∂r kundbes√∂k.</p>

      <div class="grid2">
        <div>
          <label for="kundnamn">Kundnamn</label>
          <input class="field" id="kundnamn" placeholder="Ex. Anna Andersson" />
        </div>
        <div>
          <label for="adress">Adress</label>
          <input class="field" id="adress" placeholder="Gata, postnummer, ort" />
        </div>

        <div>
          <label for="telefon">Telefon</label>
          <input class="field" id="telefon" placeholder="" inputmode="tel" />
        </div>
        <div>
          <label for="epost">E-post</label>
          <input class="field" id="epost" placeholder="" inputmode="email" />
        </div>
      </div>

      <div style="height:10px"></div>
      <h2 style="font-size:20px; margin-top:6px;">M√∂tesdata</h2>

      <div class="grid2">
        <div>
          <label for="datum">Datum</label>
          <select class="select" id="datum"></select>
        </div>

        <div style="position:relative;">
          <label for="tid">Tid</label>
          <div style="position:relative;">
            <select class="select" id="tid" style="padding-right:58px;"></select>
            <!-- kalenderikon i tidf√§ltet -->
            <button id="calendarBtn" type="button"
              title="L√§gg till i kalender"
              style="position:absolute; right:8px; top:50%; transform:translateY(-50%);
                     width:40px; height:40px; border-radius:12px; border:1px solid var(--line);
                     background:#fff; font-weight:900; cursor:pointer;">
              üìÖ
            </button>
          </div>
        </div>

        <div>
          <label for="motestyp">M√∂testyp</label>
          <select class="select" id="motestyp">
            <option value="">Ej valt</option>
            <option>F√∂rsta bes√∂k</option>
            <option>√Öterbes√∂k</option>
            <option>Digitalt m√∂te</option>
          </select>
        </div>
        <div>
          <label for="plats">Plats</label>
          <input class="field" id="plats" placeholder="Hos kund, adress eller Teams-l√§nk" />
        </div>

        <!-- ROT: lika stora rutor -->
        <div>
          <label for="rotCheck">Kund vill utnyttja ROT</label>
          <div class="field" style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="rotCheck" style="width:18px;height:18px;margin:0;" />
            <span style="font-weight:650;color:#0f172a;">Ja</span>
          </div>
        </div>
        <div>
          <label for="rotBelopp">Belopp (ROT)</label>
          <input class="field" id="rotBelopp" inputmode="numeric" placeholder="0" />
        </div>
      </div>

      <div class="note">
        Kalenderknappen skapar en .ics-fil som du kan l√§gga till i iPhone-kalendern (och d√§rifr√•n delas den som vanligt via iCloud-kalendrar).
      </div>
    </div>

    <!-- BADRUMSDATA -->
    <div class="card noPrint">
      <h2>Badrumsdata</h2>
      <p class="sub">Valen anv√§nds f√∂r pris + sammanfattning.</p>

      <div class="grid2">
        <div>
          <label for="niva">Niv√•</label>
          <select class="select" id="niva">
            <option value="">Ej valt</option>
            <option value="standard">Standard</option>
            <option value="premium">Premium</option>
            <option value="exclusive">Exclusive</option>
          </select>
        </div>
        <div>
          <label for="storlek">Storlek (m¬≤)</label>
          <select class="select" id="storlek"></select>
        </div>
        <div>
          <label for="takh">Takh√∂jd (m)</label>
          <select class="select" id="takh"></select>
        </div>

        <!-- Flytt av avlopp flyttad hit (ers√§tter Reserv) -->
        <div>
          <label for="flyttAvlopp">√Ñndra avloppsplacering</label>
          <select class="select" id="flyttAvlopp">
            <option value="nej">Nej</option>
            <option value="tra">Tr√§bj√§lklag</option>
            <option value="betong">Betongbj√§lklag</option>
          </select>
        </div>
      </div>
    </div>

    <!-- FUNKTIONER & UTRUSTNING -->
    <div class="card noPrint">
      <h2>Funktioner & utrustning</h2>
      <p class="sub">Kryssa i d√§r det √§r relevant. Prissatta val p√•verkar kalkylen.</p>

      <div class="checkRow">
        <div class="check"><input type="checkbox" id="wcVagg" /><span>V√§ggh√§ngd WC</span></div>
        <div class="check"><input type="checkbox" id="wcGolv" /><span>Golvst√•ende WC</span></div>
        <div class="check"><input type="checkbox" id="handdusch" /><span>Handdusch vid toalett</span></div>
        <div class="check"><input type="checkbox" id="badkar" /><span>Badkar</span></div>
        <div class="check"><input type="checkbox" id="enbartDusch" /><span>Enbart dusch</span></div>

        <div class="check"><input type="checkbox" id="tvattmaskin" /><span>Tv√§ttmaskin inkl el & avlopp</span></div>
        <div class="check"><input type="checkbox" id="undertak" /><span>Nytt undertak / s√§nkt tak</span></div>

        <!-- Flyttad hit enligt instruktion -->
        <div class="check"><input type="checkbox" id="spacklaMala" /><span>Spackling & m√•lning</span></div>

        <div class="check"><input type="checkbox" id="behallDorTroskel" /><span>Beh√•lla befintlig d√∂rr & tr√∂skel</span></div>

        <div class="check"><input type="checkbox" id="nyDor" /><span>Ny d√∂rr</span></div>
        <div class="check"><input type="checkbox" id="nyTroskel" /><span>Ny tr√∂skel</span></div>

        <div class="check"><input type="checkbox" id="hamtaKakel" /><span>Vi h√§mtar kakel & klinker √•t kund</span></div>
        <div class="check"><input type="checkbox" id="hamtaInredning" /><span>Vi h√§mtar badrumsinredning √•t kund</span></div>
      </div>

      <div style="height:12px"></div>

      <div class="grid2">
        <div>
          <label>√ñvrigt</label>
          <button class="pillBtn" id="ovrigtBtn" type="button">L√§gg till poster</button>
        </div>
        <div></div>
      </div>

      <div id="ovrigtList" style="margin-top:10px;"></div>

      <div class="priceBox">
        <div class="priceRow">
          <small>Delsumma (exkl. moms, inkl. 10% h√∂jning)</small>
          <span class="priceNum" id="sumEx">0 kr</span>
        </div>
        <div class="priceRow">
          <small>ROT-avdrag</small>
          <span class="priceNum" id="rotOut">-0 kr</span>
        </div>
        <div class="priceRow priceBig">
          <span>Pris efter ROT-avdrag (exkl. moms)</span>
          <span class="priceNum" id="afterRotEx">0 kr</span>
        </div>
        <div class="priceRow">
          <small>Pris efter ROT-avdrag (inkl. moms)</small>
          <span class="priceNum" id="afterRotInc">0 kr</span>
        </div>
      </div>
    </div>

    <!-- ANTECKNINGAR + KNAPPAR -->
    <div class="card noPrint">
      <h2>Anteckningar</h2>
      <p class="sub">Frivilligt. Ing√•r i A4-sammanfattningen.</p>

      <textarea class="textarea" id="notes" placeholder="S√§rskilda f√∂ruts√§ttningar, tr√•nga utrymmen, parkering, tidsf√∂nster, bilder/video bifogas separat etc."></textarea>

      <div class="twoBtns">
        <button class="btn btnPrimary" id="calcBtn" type="button">Ber√§kna pris</button>
        <button class="btn" id="mailBtn" type="button">Maila</button>
        <button class="btn" id="saveBtn" type="button">Spara</button>
        <button class="btn" id="detailBtn" type="button">Detaljerad summering</button>
      </div>

      <div class="note">
        ‚ÄúSpara‚Äù √∂ppnar en ‚ÄúSpara som‚Ä¶‚Äù-dialog (PDF/JSON/TXT) via iPhone ‚ÄúDela/Spara i filer‚Äù.
        ‚ÄúDetaljerad summering‚Äù √§r intern kontroll (inkl. radpriser).
      </div>
    </div>

    <!-- MODAL: Spara som -->
    <div class="modalOverlay" id="saveModal">
      <div class="modal">
        <div class="modalHeader">
          <p class="modalTitle">Spara som‚Ä¶</p>
          <button class="btn" type="button" id="closeSaveModal">St√§ng</button>
        </div>
        <div class="modalBody">
          V√§lj filtyp:
          <div class="row" style="margin-top:8px;">
            <label class="radio"><input type="radio" name="saveType" value="pdf" checked> PDF (A4)</label>
            <label class="radio"><input type="radio" name="saveType" value="json"> JSON (all data)</label>
            <label class="radio"><input type="radio" name="saveType" value="txt"> TXT (summering)</label>
          </div>

          <div class="row" style="margin-top:12px; justify-content:flex-end;">
            <button class="btn btnPrimary" type="button" id="doSave">Forts√§tt</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Detaljerad summering -->
    <div class="modalOverlay" id="detailModal">
      <div class="modal">
        <div class="modalHeader">
          <p class="modalTitle">Detaljerad summering (intern)</p>
          <button class="btn" type="button" id="closeDetailModal">St√§ng</button>
        </div>
        <div class="modalBody">
          <div class="monoBox" id="detailBox"></div>
        </div>
      </div>
    </div>

    <!-- PRINT A4 -->
    <div class="printOnly a4" id="printA4">
      <div class="a4Header">
        <img id="logoPrint" alt="Petra" />
        <div style="flex:1;">
          <p class="a4Title">Offertunderlag f√∂r badrumsrenovering</p>
          <p class="a4Sub" id="a4Meta"></p>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Kund</h3>
        <div class="a4Grid">
          <div class="kv"><div class="k">Namn:</div><div class="v" id="a4Kund"></div></div>
          <div class="kv"><div class="k">Adress:</div><div class="v" id="a4Adress"></div></div>
          <div class="kv"><div class="k">Telefon:</div><div class="v" id="a4Tel"></div></div>
          <div class="kv"><div class="k">E-post:</div><div class="v" id="a4Epost"></div></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Badrumsdata</h3>
        <div class="a4Grid">
          <div class="kv"><div class="k">Niv√•:</div><div class="v" id="a4Niva"></div></div>
          <div class="kv"><div class="k">Storlek:</div><div class="v" id="a4Storlek"></div></div>
          <div class="kv"><div class="k">Takh√∂jd:</div><div class="v" id="a4Takh"></div></div>
          <div class="kv"><div class="k">Avlopp:</div><div class="v" id="a4Avlopp"></div></div>
          <div class="kv"><div class="k">ROT:</div><div class="v" id="a4Rot"></div></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Val</h3>
        <div class="a4Grid" id="a4Val"></div>
      </div>

      <div class="a4Section a4Box">
        <h3>Uppskattat pris (efter ROT)</h3>
        <div class="a4Price" id="a4Pris"></div>

        <div class="split">
          <div class="splitRow"><span>Etablering (5%)</span><span id="a4Etab"></span></div>
          <div class="splitRow"><span>Arbetskostnad (55%)</span><span id="a4Arb"></span></div>
          <div class="splitRow"><span>Materialkostnad (40%)</span><span id="a4Mat"></span></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Anteckningar</h3>
        <div style="white-space:pre-wrap; font-size:11pt; font-weight:650;" id="a4Notes"></div>
      </div>
    </div>

  </div>

<script>
/* =========================
   KONFIG
========================= */
const STORAGE_KEY = "petrabadrum_form_v1";
const LOGO_SRC = "logo.png";

/* Prislista ‚Äì BEH√ÖLL som den √§r nu (du sa: beh√•ll priserna).
   Fyll i basePerM2 om de inte redan finns i din version.
*/
const PRICES = {
  PCT_UPLIFT: 0.10,
  VAT: 0.25,

  flyttAvlopp: { nej: 0, tra: 10000, betong: 20000 },
  hamtaService: 5000,

  nyDor: 0,
  nyTroskel: 0,
  undertak: 0,
  spacklaMala: 0,
  tvattmaskin: 0,
  badkar: 0,

  basePerM2: {
    standard: 0,
    premium: 0,
    exclusive: 0
  },
  ceilingFactor: (h) => {
    if (h >= 2.8) return 1.10;
    if (h >= 2.5) return 1.05;
    return 1.00;
  }
};

/* =========================
   HJ√ÑLPARE
========================= */
const el = (id) => document.getElementById(id);
const fmt = (n) => (Math.round(n)).toLocaleString("sv-SE") + " kr";
const parseSEK = (txt) => {
  // "153 700 kr" -> 153700
  const s = String(txt||"0").replace("kr","").replace(/\s/g,"").replace(/\./g,"").replace(",",".");
  const n = Number(s);
  return isFinite(n) ? n : 0;
};

function fallbackLogoSVG(){
  // enkel, stilren fallback
  return `
    <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
      <path fill="#1d4ed8" d="M12 2a6 6 0 0 0-6 6v2.2c0 .7-.3 1.4-.8 1.9L4 13.3V16h16v-2.7l-1.2-1.2c-.5-.5-.8-1.2-.8-1.9V8a6 6 0 0 0-6-6Zm-4 18a4 4 0 0 0 8 0H8Z"/>
    </svg>`;
}

function setLogo(){
  const imgTop = el("logoTop");
  const imgPrint = el("logoPrint");
  const fb = el("logoFallback");

  fb.innerHTML = fallbackLogoSVG();

  imgTop.src = LOGO_SRC;
  imgPrint.src = LOGO_SRC;

  imgTop.onload = () => { imgTop.style.display="block"; fb.style.display="none"; };
  imgTop.onerror = () => { imgTop.style.display="none"; fb.style.display="flex"; };

  imgPrint.onerror = () => { imgPrint.style.display="none"; };
}

function populateDateTime(){
  const dSel = el("datum");
  dSel.innerHTML = `<option value="">Datum</option>`;
  const now = new Date();
  for(let i=0;i<61;i++){
    const d = new Date(now);
    d.setDate(now.getDate()+i);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const val = `${y}-${m}-${day}`;
    const txt = `${day}/${m}/${y}`;
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = txt;
    dSel.appendChild(opt);
  }

  const tSel = el("tid");
  tSel.innerHTML = `<option value="">Tid</option>`;
  for(let h=7; h<=19; h++){
    for(let min=0; min<60; min+=15){
      const hh = String(h).padStart(2,"0");
      const mm = String(min).padStart(2,"0");
      const val = `${hh}:${mm}`;
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      tSel.appendChild(opt);
    }
  }
}

function populateBathroom(){
  const size = el("storlek");
  size.innerHTML = `<option value="">Ej valt</option>`;
  for(let i=2;i<=20;i++){
    const opt=document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i} m¬≤`;
    size.appendChild(opt);
  }

  const takh = el("takh");
  takh.innerHTML = `<option value="">Ej valt</option>`;
  for(let x=2.0; x<=3.0+1e-9; x+=0.1){
    const v = x.toFixed(1).replace(".", ",");
    const opt=document.createElement("option");
    opt.value = String(x.toFixed(1));
    opt.textContent = `${v} m`;
    takh.appendChild(opt);
  }
}

function markChosenUI(){
  document.querySelectorAll("select.select").forEach(s=>{
    if(s.value && s.value !== "nej") s.classList.add("chosen");
    else s.classList.remove("chosen");
  });

  const rb = el("rotBelopp");
  if((rb.value||"").trim() && Number(rb.value||0) > 0) rb.classList.add("chosen");
  else rb.classList.remove("chosen");
}

/* =========================
   STATE
========================= */
function getOvrigt(){
  return [...document.querySelectorAll(".ovrItem")].map(row=>{
    const t = row.querySelector(".ovrText").value.trim();
    const a = Number((row.querySelector(".ovrAmount").value||"0").replace(/\s/g,"").replace(",", "."));
    return { text:t, amount:isFinite(a)?a:0 };
  }).filter(x=>x.text || x.amount);
}

function getState(){
  return {
    kundnamn: el("kundnamn").value.trim(),
    adress: el("adress").value.trim(),
    telefon: el("telefon").value.trim(),
    epost: el("epost").value.trim(),

    datum: el("datum").value,
    tid: el("tid").value,
    motestyp: el("motestyp").value,
    plats: el("plats").value.trim(),

    rotCheck: el("rotCheck").checked,
    rotBelopp: Number((el("rotBelopp").value||"0").replace(/\s/g,"").replace(",", ".")) || 0,

    niva: el("niva").value,
    storlek: Number(el("storlek").value||0) || 0,
    takh: Number(el("takh").value||0) || 0,

    flyttAvlopp: el("flyttAvlopp").value,

    checks: {
      wcVagg: el("wcVagg").checked,
      wcGolv: el("wcGolv").checked,
      handdusch: el("handdusch").checked,
      badkar: el("badkar").checked,
      enbartDusch: el("enbartDusch").checked,
      tvattmaskin: el("tvattmaskin").checked,
      undertak: el("undertak").checked,
      spacklaMala: el("spacklaMala").checked,
      behallDorTroskel: el("behallDorTroskel").checked,
      nyDor: el("nyDor").checked,
      nyTroskel: el("nyTroskel").checked,
      hamtaKakel: el("hamtaKakel").checked,
      hamtaInredning: el("hamtaInredning").checked
    },

    ovrigt: getOvrigt(),
    notes: el("notes").value
  };
}

function setState(s){
  if(!s) return;

  el("kundnamn").value = s.kundnamn || "";
  el("adress").value = s.adress || "";
  el("telefon").value = s.telefon || "";
  el("epost").value = s.epost || "";

  el("datum").value = s.datum || "";
  el("tid").value = s.tid || "";
  el("motestyp").value = s.motestyp || "";
  el("plats").value = s.plats || "";

  el("rotCheck").checked = !!s.rotCheck;
  el("rotBelopp").value = (s.rotBelopp ?? 0) ? String(s.rotBelopp) : "";

  el("niva").value = s.niva || "";
  el("storlek").value = s.storlek ? String(s.storlek) : "";
  el("takh").value = s.takh ? String(Number(s.takh).toFixed(1)) : "";

  el("flyttAvlopp").value = s.flyttAvlopp || "nej";
  el("notes").value = s.notes || "";

  const c = s.checks || {};
  Object.keys(c).forEach(k=>{
    const node = document.getElementById(k);
    if(node && node.type === "checkbox") node.checked = !!c[k];
  });

  el("ovrigtList").innerHTML = "";
  (s.ovrigt || []).forEach(x => addOvrigtRow(x.text, x.amount));

  markChosenUI();
}

function persist(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(getState()));
}

function restore(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{ setState(JSON.parse(raw)); }catch(e){}
}

function resetAll(){
  localStorage.removeItem(STORAGE_KEY);
  document.querySelectorAll("input, textarea").forEach(i=>{
    if(i.type === "checkbox") i.checked = false;
    else i.value = "";
  });
  document.querySelectorAll("select").forEach(s=> s.value = "");
  el("flyttAvlopp").value = "nej";
  el("ovrigtList").innerHTML = "";
  updatePriceUI(0,0,0,0);
  markChosenUI();
}

/* =========================
   √ñVRIGT
========================= */
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function addOvrigtRow(text="", amount=0){
  const row = document.createElement("div");
  row.className = "grid2 ovrItem";
  row.style.marginTop="10px";

  row.innerHTML = `
    <div>
      <label>Post</label>
      <input class="field ovrText" placeholder="Ex. F√∂nsterbyte / Bygga in badkar" value="${escapeHtml(text)}" />
    </div>
    <div>
      <label>Belopp (kr)</label>
      <input class="field ovrAmount" inputmode="numeric" placeholder="0" value="${amount ? String(amount) : ""}" />
    </div>
  `;

  el("ovrigtList").appendChild(row);

  row.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", ()=>{ persist(); calc(); });
  });
}

/* =========================
   PRISLOGIK
========================= */
function calcBreakdown(){
  const s = getState();

  // Bas (niv√• + storlek)
  let base = 0;
  if(s.niva && s.storlek){
    const per = PRICES.basePerM2[s.niva] || 0;
    base = per * s.storlek;
    if(s.takh) base = base * PRICES.ceilingFactor(s.takh);
  }

  // Till√§gg
  const items = [];
  let add = 0;

  // Avlopp (nu i Badrumsdata)
  const av = PRICES.flyttAvlopp[s.flyttAvlopp] || 0;
  items.push({ key:"Flytt av avlopp", value:
    s.flyttAvlopp==="nej" ? "Nej" :
    s.flyttAvlopp==="tra" ? "Tr√§bj√§lklag" : "Betongbj√§lklag",
    price: av
  });
  add += av;

  // H√§mtservice
  if(s.checks.hamtaKakel){
    items.push({ key:"Vi h√§mtar kakel & klinker", value:"Ja", price: PRICES.hamtaService });
    add += PRICES.hamtaService;
  } else items.push({ key:"Vi h√§mtar kakel & klinker", value:"Nej", price: 0 });

  if(s.checks.hamtaInredning){
    items.push({ key:"Vi h√§mtar badrumsinredning", value:"Ja", price: PRICES.hamtaService });
    add += PRICES.hamtaService;
  } else items.push({ key:"Vi h√§mtar badrumsinredning", value:"Nej", price: 0 });

  // √ñvrigt
  (s.ovrigt||[]).forEach((x,idx)=>{
    const p = Number(x.amount)||0;
    items.push({ key:`√ñvrigt ${idx+1}`, value: x.text || "‚Äî", price: p });
    add += p;
  });

  // Ev prissatta checkboxar (beh√•ll 0 om du inte priss√§tter dem)
  const opt = [
    ["Ny d√∂rr", "nyDor"],
    ["Ny tr√∂skel", "nyTroskel"],
    ["Nytt undertak / s√§nkt tak", "undertak"],
    ["Spackling & m√•lning", "spacklaMala"],
    ["Tv√§ttmaskin inkl el & avlopp", "tvattmaskin"],
    ["Badkar", "badkar"]
  ];
  opt.forEach(([label, key])=>{
    const checked = !!s.checks[key];
    const p = checked ? (PRICES[key] || 0) : 0;
    items.push({ key: label, value: checked ? "Ja" : "Nej", price: p });
    add += p;
  });

  let subtotal = base + add;
  const uplift = subtotal * PRICES.PCT_UPLIFT;
  subtotal = subtotal + uplift;

  let rot = 0;
  if(s.rotCheck) rot = Math.max(0, Number(s.rotBelopp)||0);
  rot = Math.min(rot, subtotal);

  const afterRotEx = Math.max(0, subtotal - rot);
  const afterRotInc = afterRotEx * (1 + PRICES.VAT);

  return { s, base, add, uplift, subtotal, rot, afterRotEx, afterRotInc, items };
}

function calc(){
  const b = calcBreakdown();
  updatePriceUI(b.subtotal, b.rot, b.afterRotEx, b.afterRotInc);
  markChosenUI();
  persist();
}

function updatePriceUI(subtotal=0, rot=0, afterRotEx=0, afterRotInc=0){
  el("sumEx").textContent = fmt(subtotal);
  el("rotOut").textContent = "-" + fmt(rot);
  el("afterRotEx").textContent = fmt(afterRotEx);
  el("afterRotInc").textContent = fmt(afterRotInc);
}

/* =========================
   PDF / A4
========================= */
function buildA4(){
  const b = calcBreakdown();
  const s = b.s;

  const metaParts = [];
  if(s.datum) metaParts.push(`Datum: ${s.datum}`);
  if(s.tid) metaParts.push(`Tid: ${s.tid}`);
  if(s.motestyp) metaParts.push(`M√∂testyp: ${s.motestyp}`);
  if(s.plats) metaParts.push(`Plats: ${s.plats}`);
  el("a4Meta").textContent = metaParts.join("  ‚Ä¢  ");

  el("a4Kund").textContent = s.kundnamn || "‚Äî";
  el("a4Adress").textContent = s.adress || "‚Äî";
  el("a4Tel").textContent = s.telefon || "‚Äî";
  el("a4Epost").textContent = s.epost || "‚Äî";

  el("a4Niva").textContent = s.niva ? (s.niva[0].toUpperCase()+s.niva.slice(1)) : "‚Äî";
  el("a4Storlek").textContent = s.storlek ? `${s.storlek} m¬≤` : "‚Äî";
  el("a4Takh").textContent = s.takh ? `${String(s.takh).replace(".", ",")} m` : "‚Äî";
  el("a4Avlopp").textContent =
    s.flyttAvlopp==="nej" ? "Nej" :
    s.flyttAvlopp==="tra" ? "Tr√§bj√§lklag" : "Betongbj√§lklag";
  el("a4Rot").textContent = s.rotCheck ? (`Ja, ${fmt(s.rotBelopp||0)}`) : "Nej";

  el("a4Pris").textContent = `${fmt(b.afterRotEx)} (efter ROT, exkl. moms)`;

  const etab = b.afterRotEx * 0.05;
  const arb  = b.afterRotEx * 0.55;
  const mat  = b.afterRotEx * 0.40;

  el("a4Etab").textContent = fmt(etab);
  el("a4Arb").textContent  = fmt(arb);
  el("a4Mat").textContent  = fmt(mat);

  const yesNo = (x)=> x ? "Ja" : "Nej";
  const c = s.checks || {};
  const pairs = [
    ["V√§ggh√§ngd WC", yesNo(c.wcVagg)],
    ["Golvst√•ende WC", yesNo(c.wcGolv)],
    ["Handdusch vid toalett", yesNo(c.handdusch)],
    ["Badkar", yesNo(c.badkar)],
    ["Enbart dusch", yesNo(c.enbartDusch)],
    ["Tv√§ttmaskin", yesNo(c.tvattmaskin)],
    ["Undertak/s√§nkt tak", yesNo(c.undertak)],
    ["Spackling & m√•lning", yesNo(c.spacklaMala)],
    ["Beh√•lla d√∂rr & tr√∂skel", yesNo(c.behallDorTroskel)],
    ["Ny d√∂rr", yesNo(c.nyDor)],
    ["Ny tr√∂skel", yesNo(c.nyTroskel)],
    ["Vi h√§mtar kakel & klinker", c.hamtaKakel ? "Ja" : "Nej"],
    ["Vi h√§mtar badrumsinredning", c.hamtaInredning ? "Ja" : "Nej"],
  ];
  (s.ovrigt||[]).forEach((x,idx)=>{
    if(x.text || x.amount) pairs.push([`√ñvrigt ${idx+1}`, `${x.text || "‚Äî"} (${fmt(x.amount||0)})`]);
  });

  const box = el("a4Val");
  box.innerHTML = "";
  pairs.forEach(([k,v])=>{
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<div class="k">${escapeHtml(k)}:</div><div class="v">${escapeHtml(v)}</div>`;
    box.appendChild(div);
  });

  el("a4Notes").textContent = (s.notes || "‚Äî");
}

function printPDF(){
  buildA4();
  window.print();
}

/* =========================
   KALENDER (.ics)
========================= */
function addToCalendar(){
  const s = getState();
  if(!s.datum || !s.tid){
    alert("Fyll i datum och tid f√∂rst.");
    return;
  }
  const [y,m,d] = s.datum.split("-").map(Number);
  const [hh,mm] = s.tid.split(":").map(Number);

  const start = new Date(y, m-1, d, hh, mm, 0);
  const end = new Date(start.getTime() + 60*60*1000);

  const pad = (n)=> String(n).padStart(2,"0");
  const toICS = (dt)=> `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}00`;

  const title = `Kundbes√∂k: ${s.kundnamn || "Badrum"}`;
  const loc = s.plats || s.adress || "";
  const desc = `Petrabadrum ‚Äì offertunderlag.\nM√∂testyp: ${s.motestyp||"‚Äî"}\nTelefon: ${s.telefon||"‚Äî"}\nE-post: ${s.epost||"‚Äî"}`;

  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Petrabadrum//SE
BEGIN:VEVENT
DTSTART:${toICS(start)}
DTEND:${toICS(end)}
SUMMARY:${title}
LOCATION:${loc}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  downloadBlob(blob, `petrabadrum_mote_${s.datum}_${s.tid.replace(":","")}.ics`);
}

/* =========================
   SAVE / SHARE helpers
========================= */
function safeFileBaseName(s){
  const name = (s.kundnamn || "kund").replace(/[^\w√•√§√∂√Ö√Ñ√ñ-]+/g,"_");
  const date = (s.datum || "datum");
  return `petrabadrum_${name}_${date}`;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function shareFile(file){
  // iOS: fungerar ofta med navigator.share + files (iOS 16+)
  if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })) {
    await navigator.share({ files:[file], title: file.name });
    return true;
  }
  return false;
}

/* =========================
   Spara (dialog + val)
========================= */
function openSaveModal(){
  el("saveModal").style.display = "flex";
}
function closeSaveModal(){
  el("saveModal").style.display = "none";
}

async function doSaveFlow(){
  calc();
  const b = calcBreakdown();
  const s = b.s;
  const baseName = safeFileBaseName(s);
  const type = document.querySelector('input[name="saveType"]:checked')?.value || "pdf";

  closeSaveModal();

  if(type === "pdf"){
    // iOS: anv√§nd print -> spara som PDF via share sheet
    printPDF();
    return;
  }

  if(type === "json"){
    const payload = {
      ...s,
      price: {
        subtotal_excl_vat_incl_uplift: b.subtotal,
        rot: b.rot,
        after_rot_excl_vat: b.afterRotEx,
        after_rot_incl_vat: b.afterRotInc,
        split: {
          etablering_5pct: b.afterRotEx * 0.05,
          arbete_55pct: b.afterRotEx * 0.55,
          material_40pct: b.afterRotEx * 0.40
        }
      },
      savedAt: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json;charset=utf-8"});
    const file = new File([blob], `${baseName}.json`, {type: blob.type});
    const shared = await shareFile(file);
    if(!shared) downloadBlob(blob, file.name);
    return;
  }

  // TXT summering (utan radpriser, men med split + total)
  const txt = buildMailText({ includePricesPerItem:false, includeTotals:true });
  const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
  const file = new File([blob], `${baseName}.txt`, {type: blob.type});
  const shared = await shareFile(file);
  if(!shared) downloadBlob(blob, file.name);
}

/* =========================
   Maila (utan radpriser)
========================= */
function buildMailText({includePricesPerItem=false, includeTotals=true} = {}){
  const b = calcBreakdown();
  const s = b.s;

  const etab = Math.round(b.afterRotEx * 0.05);
  const arb  = Math.round(b.afterRotEx * 0.55);
  const mat  = Math.round(b.afterRotEx * 0.40);

  const yesNo = (x)=> x ? "Ja" : "Nej";
  const c = s.checks || {};

  const lines = [];
  lines.push("PETRABADRUM ‚Äì Underlag");
  lines.push("");
  lines.push(`Kund: ${s.kundnamn || "‚Äî"}`);
  lines.push(`Adress: ${s.adress || "‚Äî"}`);
  lines.push(`Telefon: ${s.telefon || "‚Äî"}`);
  lines.push(`E-post: ${s.epost || "‚Äî"}`);
  lines.push("");
  lines.push(`M√∂te: ${s.datum || "‚Äî"} ${s.tid || ""} ‚Ä¢ ${s.motestyp || "‚Äî"} ‚Ä¢ ${s.plats || "‚Äî"}`);
  lines.push("");
  lines.push(`Niv√•: ${s.niva || "‚Äî"} ‚Ä¢ Storlek: ${s.storlek ? s.storlek+" m¬≤" : "‚Äî"} ‚Ä¢ Takh√∂jd: ${s.takh ? String(s.takh).replace(".",",")+" m" : "‚Äî"}`);
  lines.push(`√Ñndra avloppsplacering: ${
    s.flyttAvlopp==="nej" ? "Nej" :
    s.flyttAvlopp==="tra" ? "Tr√§bj√§lklag" : "Betongbj√§lklag"
  }`);
  lines.push(`ROT: ${s.rotCheck ? "Ja" : "Nej"}${s.rotCheck ? ` (${fmt(s.rotBelopp||0)})` : ""}`);
  lines.push("");
  lines.push("Val:");
  lines.push(`- V√§ggh√§ngd WC: ${yesNo(c.wcVagg)}`);
  lines.push(`- Golvst√•ende WC: ${yesNo(c.wcGolv)}`);
  lines.push(`- Handdusch vid toalett: ${yesNo(c.handdusch)}`);
  lines.push(`- Badkar: ${yesNo(c.badkar)}`);
  lines.push(`- Enbart dusch: ${yesNo(c.enbartDusch)}`);
  lines.push(`- Tv√§ttmaskin inkl el & avlopp: ${yesNo(c.tvattmaskin)}`);
  lines.push(`- Nytt undertak / s√§nkt tak: ${yesNo(c.undertak)}`);
  lines.push(`- Spackling & m√•lning: ${yesNo(c.spacklaMala)}`);
  lines.push(`- Beh√•lla befintlig d√∂rr & tr√∂skel: ${yesNo(c.behallDorTroskel)}`);
  lines.push(`- Ny d√∂rr: ${yesNo(c.nyDor)}`);
  lines.push(`- Ny tr√∂skel: ${yesNo(c.nyTroskel)}`);
  lines.push(`- Vi h√§mtar kakel & klinker: ${yesNo(c.hamtaKakel)}`);
  lines.push(`- Vi h√§mtar badrumsinredning: ${yesNo(c.hamtaInredning)}`);

  (s.ovrigt||[]).forEach((x,idx)=>{
    if(x.text || x.amount) lines.push(`- √ñvrigt ${idx+1}: ${x.text || "‚Äî"} (${fmt(x.amount||0)})`);
  });

  lines.push("");
  if(includeTotals){
    lines.push("Prisuppdelning (efter ROT, exkl. moms):");
    lines.push(`- Etablering (5%): ${fmt(etab)}`);
    lines.push(`- Arbetskostnad (55%): ${fmt(arb)}`);
    lines.push(`- Materialkostnad (40%): ${fmt(mat)}`);
    lines.push(`- Totalt efter ROT (exkl. moms): ${fmt(b.afterRotEx)}`);
  }

  lines.push("");
  lines.push("Anteckningar:");
  lines.push(s.notes || "‚Äî");

  if(includePricesPerItem){
    lines.push("");
    lines.push("Radpriser (intern):");
    b.items.forEach(it=>{
      lines.push(`- ${it.key}: ${it.value} ‚Ä¢ ${fmt(it.price)}`);
    });
    lines.push(`Bas: ${fmt(b.base)}`);
    lines.push(`Till√§gg: ${fmt(b.add)}`);
    lines.push(`10% h√∂jning: ${fmt(b.uplift)}`);
    lines.push(`Delsumma: ${fmt(b.subtotal)}`);
    lines.push(`ROT: -${fmt(b.rot)}`);
    lines.push(`Efter ROT (exkl. moms): ${fmt(b.afterRotEx)}`);
    lines.push(`Efter ROT (inkl. moms): ${fmt(b.afterRotInc)}`);
  }

  return lines.join("\n");
}

function mailTo(){
  calc();
  const s = getState();
  const subject = `Petrabadrum ‚Äì Underlag (${s.kundnamn || "kund"})`;
  const body = buildMailText({ includePricesPerItem:false, includeTotals:true });
  const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailto;
}

/* =========================
   Detaljerad summering (modal)
========================= */
function openDetailModal(){
  calc();
  const txt = buildMailText({ includePricesPerItem:true, includeTotals:true });
  el("detailBox").textContent = txt;
  el("detailModal").style.display = "flex";
}
function closeDetailModal(){
  el("detailModal").style.display = "none";
}

/* =========================
   EVENTS
========================= */
function bindEvents(){
  document.querySelectorAll("input, textarea, select").forEach(inp=>{
    inp.addEventListener("change", ()=>{ persist(); calc(); });
    inp.addEventListener("input", ()=>{ persist(); });
  });

  el("resetBtn").addEventListener("click", ()=>{
    if(confirm("Nollst√§lla allt?")) resetAll();
  });

  el("ovrigtBtn").addEventListener("click", ()=>{
    addOvrigtRow("", 0);
    persist();
  });

  el("calcBtn").addEventListener("click", calc);
  el("calendarBtn").addEventListener("click", addToCalendar);

  // Spara dialog
  el("saveBtn").addEventListener("click", openSaveModal);
  el("closeSaveModal").addEventListener("click", closeSaveModal);
  el("doSave").addEventListener("click", doSaveFlow);

  // Maila
  el("mailBtn").addEventListener("click", mailTo);

  // Detaljer
  el("detailBtn").addEventListener("click", openDetailModal);
  el("closeDetailModal").addEventListener("click", closeDetailModal);

  // st√§ng modal p√• klick utanf√∂r
  el("saveModal").addEventListener("click", (e)=>{ if(e.target.id==="saveModal") closeSaveModal(); });
  el("detailModal").addEventListener("click", (e)=>{ if(e.target.id==="detailModal") closeDetailModal(); });
}

/* =========================
   INIT
========================= */
(function init(){
  setLogo();
  populateDateTime();
  populateBathroom();
  bindEvents();
  restore();
  calc();
})();
</script>
</body>
</html>
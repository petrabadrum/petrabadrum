<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Petrabadrum ‚Äì Offertapp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jsPDF f√∂r robust PDF p√• iPhone (Share Sheet / Spara i Filer) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root {
      --petra-dark: #003c8f;
      --petra-main: #1d4ed8;
      --bg-body: #f3f4f6;

      --pill-bg: #f8fafc;
      --pill-border: #cbd5e1;

      --pill-green-bg: #e7f7ec;
      --pill-green-border: #7ac897;
      --pill-green-text: #065f46;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, system-ui, -webkit-system-font, sans-serif;
      background: var(--bg-body);
      color: #0f172a;
      font-size: 16px;
    }

    /* SPLASH */
    #splash {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #ffffff;
      text-align: center;
      padding: 40px 16px 24px;
    }
    #splash-logo {
      width: 210px;
      max-width: 70%;
      height: auto;
      margin-bottom: 24px;
    }
    #splash-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    #splash-arrow {
      font-size: 24px;
      opacity: 0.4;
      animation: bounce 1.2s infinite;
      margin-top: 28px;
    }
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50%     { transform: translateY(6px); }
    }

    /* APP */
    #app {
      padding: 0 12px 40px;
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 16px 16px 18px;
      margin-bottom: 14px;
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.12);
      border: 1px solid #dde3ee;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    h2 {
      font-size: 18px;
      margin: 0;
      color: var(--petra-dark);
      font-weight: 700;
    }
    .section-caption {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 10px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .field-group { margin-bottom: 10px; }
    .field-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #1e293b;
    }

    input[type="text"], input[type="email"], input[type="tel"], textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      padding: 10px 14px;
      font-size: 15px;
      min-height: 44px;
    }

    input[type="date"], input[type="time"] {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      padding: 10px 14px;
      font-size: 15px;
      min-height: 44px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    textarea {
      border-radius: 14px;
      resize: vertical;
      min-height: 90px;
      font-family: inherit;
    }

    .pill-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--pill-border);
      background: var(--pill-bg);
      padding: 10px 14px;
      font-size: 15px;
      min-height: 44px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      position: relative;
      color: #0f172a;
      font-weight: 500;
      background-image:
        linear-gradient(45deg, transparent 50%, #64748b 50%),
        linear-gradient(135deg, #64748b 50%, transparent 50%);
      background-position: calc(100% - 18px) 17px, calc(100% - 13px) 17px;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }
    .pill-select.filled {
      background: var(--pill-green-bg);
      border-color: var(--pill-green-border);
      color: var(--pill-green-text);
    }

    .calendar-btn {
      border-radius: 999px;
      border: none;
      background: #fbbf24;
      color: #78350f;
      font-weight: 700;
      font-size: 13px;
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 6px 15px rgba(217, 119, 6, 0.4);
      cursor: pointer;
      white-space: nowrap;
    }
    .calendar-btn span.icon { font-size: 18px; }

    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }
    .checkbox-row input[type="checkbox"] {
      transform: scale(1.1);
    }
    .checkbox-row label {
      font-size: 14px;
      color: #111827;
    }

    .chip-group-label {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin: 10px 0 4px;
    }

    .small { font-size: 12px; color: #6b7280; }

    .price-box {
      font-size: 22px;
      font-weight: 700;
      color: var(--petra-dark);
      margin-bottom: 4px;
    }
    .price-details {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .btn {
      flex: 1 1 calc(50% - 4px);
      border-radius: 999px;
      border: none;
      padding: 13px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-primary { background: var(--petra-main); color: #ffffff; }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-outline { background: #ffffff; border: 1px solid var(--petra-main); color: var(--petra-main); }
    .btn-icon { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-icon span { font-size: 18px; }

    @media (max-width: 640px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }

    @media print {
      #splash { display: none; }
      body { background: #ffffff; }
      .btn-row, .calendar-btn, #foto_info { display: none !important; }
      .card { box-shadow: none; border-color: #cbd5e1; }
    }
  </style>
</head>

<body>

<section id="splash">
  <img id="splash-logo" src="petrabygg_logo.png" alt="Petra Bygg & Renovering AB" />
  <div id="splash-title">Offertunderlag f√∂r badrumsrenovering</div>
  <div class="small">Skrolla ned f√∂r att fylla i kunduppgifter och r√§kna fram prelimin√§rt pris.</div>
  <div id="splash-arrow">‚¨áÔ∏é</div>
</section>

<div id="app">

  <!-- KUNDUPPGIFTER & M√ñTESDATA -->
  <div class="card">
    <div class="card-header">
      <h2>Kunduppgifter</h2>
      <button type="button" class="calendar-btn" onclick="l√§ggTillIKalender()">
        <span class="icon">üìÖ</span> L√§gg till i kalender
      </button>
    </div>
    <div class="section-caption">
      Fylls i vid f√∂rsta telefonkontakten och inf√∂r kundbes√∂k.
    </div>

    <div class="grid-2">
      <div class="field-group">
        <div class="field-label">Kundnamn</div>
        <input id="kundnamn" type="text" placeholder="Ex. Anna Andersson" />
      </div>
      <div class="field-group">
        <div class="field-label">Adress</div>
        <input id="adress" type="text" placeholder="Gata, postnummer, ort" />
      </div>
      <div class="field-group">
        <div class="field-label">Telefon</div>
        <input id="telefon" type="tel" />
      </div>
      <div class="field-group">
        <div class="field-label">E-post</div>
        <input id="epost" type="email" />
      </div>
    </div>

    <div class="field-group">
      <div class="field-label">M√∂tesdata</div>
    </div>

    <div class="grid-2">
      <div class="field-group">
        <div class="field-label">Datum</div>
        <input id="mote_datum" type="text" placeholder="Datum"
               onfocus="this.type='date';" onblur="if(!this.value){this.type='text';}" />
      </div>
      <div class="field-group">
        <div class="field-label">Tid</div>
        <input id="mote_tid" type="text" placeholder="Tid"
               onfocus="this.type='time';" onblur="if(!this.value){this.type='text';}" />
      </div>
      <div class="field-group">
        <div class="field-label">M√∂testyp</div>
        <select id="motestyp" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="f√∂rsta_bes√∂k">F√∂rsta bes√∂k</option>
          <option value="√•terbes√∂k">√Öterbes√∂k</option>
          <option value="digitalt">Digitalt m√∂te</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Plats</div>
        <input id="mote_plats" type="text" placeholder="Hos kund, adress eller Teams-l√§nk" />
      </div>
    </div>

    <div class="field-group">
      <div class="field-label">R√∂sttranskribering</div>
      <div class="btn-row">
        <button type="button" class="btn btn-secondary" onclick="visaTranskribering('telefonsamtal')">
          Transkribera (samtal)
        </button>
        <button type="button" class="btn btn-secondary" onclick="visaTranskribering('m√∂te')">
          Transkribera (m√∂te)
        </button>
      </div>
      <div class="small" style="margin-top:4px;">
        Obs: Inspelning sker i separat app. Klistra sedan in texten i f√§lten nedan.
      </div>
    </div>

    <div class="chip-group-label">Transkriberade anteckningar</div>
    <div class="field-group">
      <div class="field-label">Telefonsamtal</div>
      <textarea id="transkrib_telefon" rows="3" placeholder="Klistra in transkriberad text h√§r..."></textarea>
    </div>
    <div class="field-group">
      <div class="field-label">M√∂te p√• plats</div>
      <textarea id="transkrib_mote" rows="3" placeholder="Klistra in transkriberad text h√§r..."></textarea>
    </div>
  </div>

  <!-- BADRUMSDATA -->
  <div class="card">
    <h2>Badrumsdata</h2>
    <div class="grid-2">
      <div class="field-group">
        <div class="field-label">Niv√•</div>
        <select id="niv√•" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="standard">Standard</option>
          <option value="premium">Premium</option>
          <option value="exklusiv">Exklusiv</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Storlek (m¬≤)</div>
        <select id="storlek" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10</option><option value="12">12</option><option value="15">15</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Takh√∂jd (m)</div>
        <select id="takh√∂jd" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="2.2">2,2</option><option value="2.3">2,3</option><option value="2.4">2,4</option>
          <option value="2.5">2,5</option><option value="2.6">2,6</option><option value="2.7">2,7</option>
          <option value="2.8">2,8</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Ny v√§gg (m¬≤)</div>
        <input id="ny_vagg_m2" type="text" placeholder="0" />
      </div>
    </div>
  </div>

  <!-- YTSKIKT -->
  <div class="card">
    <h2>Ytskikt</h2>
    <div class="grid-2">
      <div class="field-group">
        <div class="field-label">Kakel v√§gg</div>
        <input id="kakel_v√§gg" type="text" placeholder="Ex. 30x60" />
      </div>
      <div class="field-group">
        <div class="field-label">Fogf√§rg</div>
        <input id="fogf√§rg" type="text" />
      </div>
      <div class="field-group">
        <div class="field-label">Klinker golv</div>
        <input id="klinker_golv" type="text" placeholder="Ex. 10x10" />
      </div>
      <div class="field-group">
        <div class="field-label">‚Äî</div>
        <select id="ytskikt_reserv" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="halvf√∂rband">Halvf√∂rband</option>
          <option value="stens√§ttning">M√∂nster</option>
        </select>
      </div>
    </div>
  </div>

  <!-- FUNKTIONER -->
  <div class="card">
    <h2>Funktioner & utrustning</h2>

    <div class="chip-group-label">Sanitet & dusch</div>
    <div class="grid-2">
      <div class="field-group">
        <div class="checkbox-row"><input id="wc_v√§gg" type="checkbox" /><label for="wc_v√§gg">V√§ggh√§ngd toalett</label></div>
        <div class="checkbox-row"><input id="badkar" type="checkbox" /><label for="badkar">Badkar</label></div>
        <div class="checkbox-row"><input id="enbart_dusch" type="checkbox" /><label for="enbart_dusch">Enbart dusch</label></div>
      </div>
      <div class="field-group">
        <div class="checkbox-row"><input id="tv√§ttmaskin" type="checkbox" /><label for="tv√§ttmaskin">Tv√§ttmaskin (el & avlopp)</label></div>
        <div class="checkbox-row"><input id="ny_d√∂rr" type="checkbox" /><label for="ny_d√∂rr">Ny d√∂rr (montering)</label></div>
        <div class="checkbox-row"><input id="ny_tr√∂skel" type="checkbox" /><label for="ny_tr√∂skel">Ny tr√∂skel (montering)</label></div>
      </div>
    </div>

    <div class="chip-group-label">Inredning & nischer</div>
    <div class="grid-2">
      <div class="field-group">
        <div class="field-label">Nischer</div>
        <select id="nischer" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="0">0</option><option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Tv√§ttst√§ll</div>
        <select id="antal_tvattstall" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Duschset</div>
        <select id="antal_duschset" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Vattenledningar</div>
        <select id="vattenledningar" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="utan">Utanp√•</option>
          <option value="inf√§llda">Inf√§llda</option>
        </select>
      </div>
    </div>

    <div class="chip-group-label">V√§rme & el</div>
    <div class="grid-2">
      <div class="field-group">
        <div class="field-label">Golvv√§rme</div>
        <select id="golvv√§rme" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="ingen">Ingen</option>
          <option value="el">El</option>
          <option value="vatten">Vatten</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Handdukstork</div>
        <select id="handdukstork" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="ingen">Ingen</option>
          <option value="el">El</option>
          <option value="vatten">Vatten</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Spotlights</div>
        <select id="spotlights" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="0">0</option><option value="2">2</option><option value="4">4</option>
          <option value="6">6</option><option value="8">8</option><option value="10">10</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Golvavlopp</div>
        <select id="golvavlopp" class="pill-select">
          <option value="ej_valt">Ej valt</option>
          <option value="trad">Traditionellt</option>
          <option value="unidrain">Unidrain</option>
        </select>
      </div>
    </div>

    <div class="chip-group-label">Byggdelar</div>
    <div class="grid-2">
      <div class="field-group">
        <div class="checkbox-row"><input id="sankt_innertak" type="checkbox" /><label for="sankt_innertak">S√§nkt innertak</label></div>
        <div class="checkbox-row"><input id="spackling_malning" type="checkbox" /><label for="spackling_malning">Spackling och m√•lning</label></div>
      </div>
      <div class="field-group">
        <div class="checkbox-row"><input id="hamta_kakel" type="checkbox" /><label for="hamta_kakel">Vi h√§mtar kakel/klinker</label></div>
        <div class="checkbox-row"><input id="hamta_inredning" type="checkbox" /><label for="hamta_inredning">Vi h√§mtar inredning</label></div>
      </div>
    </div>

    <div class="chip-group-label">Duschl√∂sning</div>
    <div class="grid-2">
      <div class="field-group">
        <div class="checkbox-row"><input id="dusch_horna" type="checkbox" /><label for="dusch_horna">Duschh√∂rna</label></div>
        <div class="checkbox-row"><input id="dusch_fastglas" type="checkbox" /><label for="dusch_fastglas">Fast glasv√§gg</label></div>
        <div class="checkbox-row"><input id="dusch_vikdorr" type="checkbox" /><label for="dusch_vikdorr">Vikd√∂rrar</label></div>
      </div>
      <div class="field-group">
        <div class="checkbox-row"><input id="dusch_skjut" type="checkbox" /><label for="dusch_skjut">Skjutd√∂rr</label></div>
        <div class="checkbox-row"><input id="dusch_walkin" type="checkbox" /><label for="dusch_walkin">Walk-in</label></div>
      </div>
    </div>

    <div class="chip-group-label">√ñvrigt</div>
    <textarea id="ovrigt_text" placeholder="S√§rskilda f√∂ruts√§ttningar..."></textarea>
  </div>

  <!-- PRIS -->
  <div class="card">
    <h2>Prelimin√§rt pris & offertunderlag</h2>
    <p class="small">
      Prisniv√•er √§r prelimin√§ra (exkl. √ÑTA). Slutlig offert tas fram av entrepren√∂ren.
    </p>

    <div class="checkbox-row" style="margin-bottom:8px;">
      <input id="rot" type="checkbox" />
      <label for="rot">Kund vill utnyttja ROT</label>
    </div>

    <div id="pris_text" class="price-box">‚Äì</div>
    <div id="pris_detaljer" class="price-details"></div>

    <div id="foto_info" class="small" style="margin-top:6px;">
      Tips: Ta bilder/film och bifoga vid separat utskick.
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary btn-icon" onclick="√∂ppnaKamera('image')"><span>üì∑</span> Foto</button>
      <button class="btn btn-secondary btn-icon" onclick="√∂ppnaKamera('video')"><span>üé•</span> Film</button>
    </div>

    <input id="foto_input" type="file" accept="image/*" capture="environment" multiple style="display:none;" />
    <input id="video_input" type="file" accept="video/*" capture="environment" style="display:none;" />

    <div class="btn-row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="ber√§knaPris()">Ber√§kna</button>
      <button class="btn btn-secondary" onclick="kopieraSammanfattning()">Kopiera</button>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="skapaPDF()">Skapa PDF</button>
      <button class="btn btn-outline" onclick="skickaMail()">Mail</button>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="sparaPDF()">Spara</button>
    </div>

    <textarea id="sammanfattning" style="margin-top:8px;" rows="10"
              placeholder="H√§r visas sammanfattningen..."></textarea>
  </div>

</div>

<script>
  // =======================
  // PRISER (+10% EXKL MOMS)
  // =======================
  // Justera nya posterna om du vill:
  // - SPACKLING_MALNING
  // - NY_DORR
  // - NY_TROSKEL
  const priser = {
    BASE_STD_M2:   11000,
    BASE_PREM_M2:  15950,
    BASE_EXKL_M2:  21450,

    WC_V√ÑGG:       13200,
    GOLVV_EL_M2:    1980,
    GOLVV_VAT_M2:   2310,
    UNIDRAIN:       8800,
    NISCH:          4400,
    TV√ÑTT:          6600,
    GLAS:           9900,
    HANDDUK_EL:     4400,
    HANDDUK_VAT:    5500,
    SPOT:           1210,
    UNDERTAK:       6600,

    HAMTA_KAKEL:     2750,
    HAMTA_INREDNING: 2750,

    OVRIGT_FAST:    33000,

    // NYA POSTER (med 10% inr√§knat)
    SPACKLING_MALNING: 4950,
    NY_DORR:            3850,
    NY_TROSKEL:         1650
  };

  function formatCurrency(value) {
    if (isNaN(value)) return "-";
    return value.toLocaleString("sv-SE", { style: "currency", currency: "SEK", maximumFractionDigits: 0 });
  }

  function √∂ppnaKamera(typ) {
    document.getElementById(typ === "image" ? "foto_input" : "video_input").click();
  }

  function ber√§knaPris() {
    const m2Val = document.getElementById("storlek").value;
    const m2 = (m2Val === "ej_valt") ? 0 : (parseFloat(m2Val) || 0);

    const niv√• = document.getElementById("niv√•").value;

    const wcV√§gg = document.getElementById("wc_v√§gg").checked;
    const tv√§tt = document.getElementById("tv√§ttmaskin").checked;

    const nyD√∂rr = document.getElementById("ny_d√∂rr").checked;
    const nyTr√∂skel = document.getElementById("ny_tr√∂skel").checked;

    const sanktInnertak = document.getElementById("sankt_innertak").checked;
    const spacklingMalning = document.getElementById("spackling_malning").checked;

    const golvv√§rme = document.getElementById("golvv√§rme").value;
    const handduk = document.getElementById("handdukstork").value;

    const golvavlopp = document.getElementById("golvavlopp").value;

    const nischerVal = document.getElementById("nischer").value;
    const nischer = (nischerVal === "ej_valt") ? 0 : (parseInt(nischerVal) || 0);

    const spotsVal = document.getElementById("spotlights").value;
    const spots = (spotsVal === "ej_valt") ? 0 : (parseInt(spotsVal) || 0);

    const hamtaKakel = document.getElementById("hamta_kakel").checked;
    const hamtaInred = document.getElementById("hamta_inredning").checked;

    const duschVal = ["dusch_horna","dusch_fastglas","dusch_vikdorr","dusch_skjut","dusch_walkin"]
      .some(id => document.getElementById(id).checked);

    let sumEx = 0;
    const rader = [];

    // Bas per m¬≤
    if (m2 > 0 && (niv√• === "standard" || niv√• === "premium" || niv√• === "exklusiv")) {
      const kod = niv√• === "standard" ? "BASE_STD_M2" : (niv√• === "premium" ? "BASE_PREM_M2" : "BASE_EXKL_M2");
      const belopp = m2 * priser[kod];
      sumEx += belopp;
      rader.push(`Basrenovering ${niv√•} ${m2.toFixed(1)} m¬≤: ${formatCurrency(belopp)}`);
    }

    if (wcV√§gg) { sumEx += priser.WC_V√ÑGG; rader.push(`V√§ggh√§ngd WC: ${formatCurrency(priser.WC_V√ÑGG)}`); }

    if (tv√§tt) { sumEx += priser.TV√ÑTT; rader.push(`Tv√§ttmaskin (el & avlopp): ${formatCurrency(priser.TV√ÑTT)}`); }

    if (nyD√∂rr) { sumEx += priser.NY_DORR; rader.push(`Montering ny d√∂rr: ${formatCurrency(priser.NY_DORR)}`); }

    if (nyTr√∂skel) { sumEx += priser.NY_TROSKEL; rader.push(`Montering ny tr√∂skel: ${formatCurrency(priser.NY_TROSKEL)}`); }

    if (spacklingMalning) { sumEx += priser.SPACKLING_MALNING; rader.push(`Spackling och m√•lning: ${formatCurrency(priser.SPACKLING_MALNING)}`); }

    // Golvv√§rme (per m¬≤)
    if (golvv√§rme === "el" && m2 > 0) {
      const belopp = m2 * priser.GOLVV_EL_M2;
      sumEx += belopp;
      rader.push(`Golvv√§rme (el) ${m2.toFixed(1)} m¬≤: ${formatCurrency(belopp)}`);
    } else if (golvv√§rme === "vatten" && m2 > 0) {
      const belopp = m2 * priser.GOLVV_VAT_M2;
      sumEx += belopp;
      rader.push(`Golvv√§rme (vatten) ${m2.toFixed(1)} m¬≤: ${formatCurrency(belopp)}`);
    }

    if (golvavlopp === "unidrain") { sumEx += priser.UNIDRAIN; rader.push(`Unidrain: ${formatCurrency(priser.UNIDRAIN)}`); }

    if (nischer > 0) {
      const belopp = nischer * priser.NISCH;
      sumEx += belopp;
      rader.push(`Nischer ${nischer} st: ${formatCurrency(belopp)}`);
    }

    if (duschVal) { sumEx += priser.GLAS; rader.push(`Dusch/glasl√∂sning: ${formatCurrency(priser.GLAS)}`); }

    if (handduk === "el") { sumEx += priser.HANDDUK_EL; rader.push(`Handdukstork (el): ${formatCurrency(priser.HANDDUK_EL)}`); }
    else if (handduk === "vatten") { sumEx += priser.HANDDUK_VAT; rader.push(`Handdukstork (vatten): ${formatCurrency(priser.HANDDUK_VAT)}`); }

    if (spots > 0) {
      const belopp = spots * priser.SPOT;
      sumEx += belopp;
      rader.push(`Spotlights ${spots} st: ${formatCurrency(belopp)}`);
    }

    if (sanktInnertak) { sumEx += priser.UNDERTAK; rader.push(`S√§nkt innertak: ${formatCurrency(priser.UNDERTAK)}`); }

    if (hamtaKakel) { sumEx += priser.HAMTA_KAKEL; rader.push(`H√§mtning kakel/klinker: ${formatCurrency(priser.HAMTA_KAKEL)}`); }
    if (hamtaInred) { sumEx += priser.HAMTA_INREDNING; rader.push(`H√§mtning inredning: ${formatCurrency(priser.HAMTA_INREDNING)}`); }

    // √ñvrigt fast
    if (m2 > 0) { sumEx += priser.OVRIGT_FAST; rader.push(`√ñvrigt (etablering/resor/deponi): ${formatCurrency(priser.OVRIGT_FAST)}`); }

    const sumInkl = sumEx * 1.25;

    if (sumEx > 0) {
      document.getElementById("pris_text").innerText = `${formatCurrency(sumInkl)} inkl moms (prelimin√§rt)`;
      document.getElementById("pris_detaljer").innerText =
        `Exkl moms: ${formatCurrency(sumEx)} ‚Ä¢ Moms 25%: ${formatCurrency(sumInkl - sumEx)}`;
    } else {
      document.getElementById("pris_text").innerText = "‚Äì";
      document.getElementById("pris_detaljer").innerText = "";
    }

    byggSammanfattning(sumInkl, sumEx, rader);
    saveState();
  }

  function byggSammanfattning(sumInkl, sumEx, prisrader) {
    const kund = document.getElementById("kundnamn").value || "-";
    const adress = document.getElementById("adress").value || "-";
    const tel = document.getElementById("telefon").value || "";
    const epost = document.getElementById("epost").value || "";

    const niv√• = document.getElementById("niv√•").value;
    const m2 = document.getElementById("storlek").value;
    const tak = document.getElementById("takh√∂jd").value;

    const kakel = document.getElementById("kakel_v√§gg").value || "?";
    const fog = document.getElementById("fogf√§rg").value || "?";
    const klinker = document.getElementById("klinker_golv").value || "?";

    const rotVal = document.getElementById("rot").checked ? "Ja" : "Nej";

    const transTel = (document.getElementById("transkrib_telefon").value || "").trim();
    const transMote = (document.getElementById("transkrib_mote").value || "").trim();
    const ovrigt = (document.getElementById("ovrigt_text").value || "").trim();

    let text = "";
    text += `Kund: ${kund}\n`;
    text += `Adress: ${adress}\n`;
    if (tel) text += `Telefon: ${tel}\n`;
    if (epost) text += `E-post: ${epost}\n`;
    text += "\n";

    text += `Standardniv√•: ${niv√• === "ej_valt" ? "Ej vald" : niv√•}\n`;
    text += `Badrum ca ${m2 || "?"} m¬≤, takh√∂jd ${tak || "?"} m\n`;
    text += `Ytskikt: v√§ggkakel ${kakel}, fog ${fog}, klinker ${klinker}\n`;
    text += `Kund vill utnyttja ROT: ${rotVal}\n\n`;

    if (transTel) text += `Transkriberat telefonsamtal:\n${transTel}\n\n`;
    if (transMote) text += `Transkriberat kundm√∂te:\n${transMote}\n\n`;
    if (ovrigt) text += `√ñvrigt:\n${ovrigt}\n\n`;

    if (prisrader?.length) {
      text += "Prisuppdelning (prelimin√§r, exkl moms):\n";
      prisrader.forEach(r => text += `- ${r}\n`);
      text += "\n";
    }

    if (!isNaN(sumInkl) && sumInkl > 0) {
      text += `Prelimin√§rt totalpris (exkl moms): ${formatCurrency(sumEx)}\n`;
      text += `Prelimin√§rt totalpris (inkl moms): ${formatCurrency(sumInkl)}\n\n`;
      text += "Observera: prelimin√§rt pris. Slutlig offert efter genomg√•ng av detaljer.\n";
    } else {
      text += "Prelimin√§rt pris ej ber√§knat.\n";
    }

    document.getElementById("sammanfattning").value = text;
  }

  function kopieraSammanfattning() {
    const ta = document.getElementById("sammanfattning");
    if (!ta.value) ber√§knaPris();
    ta.select();
    ta.setSelectionRange(0, 99999);
    document.execCommand("copy");
    alert("Sammanfattning kopierad.");
  }

  function skickaMail() {
    if (!document.getElementById("sammanfattning").value) ber√§knaPris();
    const kund = document.getElementById("kundnamn").value || "";
    const bodyText = document.getElementById("sammanfattning").value +
      "\n\nOBS: Bifoga √§ven bilder/video separat.";
    const body = encodeURIComponent(bodyText);
    const subject = encodeURIComponent("Offertunderlag badrumsrenovering ‚Äì " + kund);
    window.location.href = "mailto:?subject=" + subject + "&body=" + body;
  }

  function visaTranskribering(typ) {
    const msg = (typ === "telefonsamtal")
      ? "√ñppna din transkriberingsapp och spela in. Klistra sedan in texten i f√§ltet 'Telefonsamtal'."
      : "√ñppna din transkriberingsapp och spela in m√∂tet. Klistra sedan in texten i f√§ltet 'M√∂te p√• plats'.";
    alert(msg);
  }

  function l√§ggTillIKalender() {
    const datum = document.getElementById("mote_datum").value;
    const tid = document.getElementById("mote_tid").value;
    if (!datum || !tid) { alert("Fyll i datum och tid f√∂rst."); return; }

    const kund = document.getElementById("kundnamn").value || "Kundbes√∂k";
    const plats = document.getElementById("mote_plats").value || "";
    const motestypVal = document.getElementById("motestyp").value;
    const motestypText = (motestypVal === "f√∂rsta_bes√∂k") ? "F√∂rsta bes√∂k"
      : (motestypVal === "√•terbes√∂k") ? "√Öterbes√∂k"
      : (motestypVal === "digitalt") ? "Digitalt m√∂te"
      : "Kundbes√∂k";

    const start = new Date(datum + "T" + tid);
    const end = new Date(start.getTime() + 60 * 60 * 1000);

    const pad = n => (n < 10 ? "0" + n : "" + n);
    const toICS = d =>
      d.getFullYear().toString() + pad(d.getMonth()+1) + pad(d.getDate()) + "T" +
      pad(d.getHours()) + pad(d.getMinutes()) + pad(d.getSeconds());

    const ics =
      "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Petrabadrum//SV\nBEGIN:VEVENT\n" +
      "UID:petrabadrum-" + Date.now() + "@petrabadrum\n" +
      "DTSTAMP:" + toICS(new Date()) + "\n" +
      "DTSTART:" + toICS(start) + "\n" +
      "DTEND:" + toICS(end) + "\n" +
      "SUMMARY:" + motestypText + " ‚Äì " + kund + "\n" +
      (plats ? "LOCATION:" + plats + "\n" : "") +
      "DESCRIPTION:Bokat via Petrabadrum.\nEND:VEVENT\nEND:VCALENDAR";

    const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "kundbes√∂k-" + kund.replace(/[^a-z0-9_-]+/gi, "_") + ".ics";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // =======================
  // PDF (robust p√• iPhone)
  // =======================
  async function buildPdfBlob(filenameBase) {
    if (!document.getElementById("sammanfattning").value) ber√§knaPris();

    const text = document.getElementById("sammanfattning").value || "";
    const kund = (document.getElementById("kundnamn").value || filenameBase || "kund")
      .replace(/[^a-z0-9_-]+/gi, "_");

    // jsPDF (via CDN)
    const jspdf = window.jspdf;
    if (!jspdf || !jspdf.jsPDF) {
      // Fallback (om CDN blockas): print
      window.print();
      return null;
    }

    const doc = new jspdf.jsPDF({ unit: "pt", format: "a4" });
    const margin = 40;
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const maxW = pageW - margin * 2;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);

    const lines = doc.splitTextToSize(text, maxW);
    let y = margin;

    for (const line of lines) {
      if (y > pageH - margin) {
        doc.addPage();
        y = margin;
      }
      doc.text(line, margin, y);
      y += 15;
    }

    const pdfBlob = doc.output("blob");
    const filename = `petrabadrum-${kund}.pdf`;
    return { pdfBlob, filename };
  }

  async function skapaPDF() {
    const res = await buildPdfBlob("kund");
    if (!res) return;

    // √ñppna PDF i ny flik (fungerar ofta) + kan delas manuellt
    const url = URL.createObjectURL(res.pdfBlob);
    window.open(url, "_blank");
    setTimeout(() => URL.revokeObjectURL(url), 60000);
  }

  async function sparaPDF() {
    const res = await buildPdfBlob("kund");
    if (!res) return;

    // iOS: Share Sheet -> "Spara i Filer" -> iCloud delad mapp
    const file = new File([res.pdfBlob], res.filename, { type: "application/pdf" });

    if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
      try {
        await navigator.share({ files: [file], title: res.filename });
        return;
      } catch (e) {
        // om anv√§ndaren avbryter share: g√∂r inget
      }
    }

    // Fallback: klassisk nedladdning
    const url = URL.createObjectURL(res.pdfBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = res.filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 60000);
  }

  // =======================
  // Autosave (s√• data ej f√∂rsvinner)
  // =======================
  const STORAGE_KEY = "petrabadrum_form_v5";

  function saveState() {
    const data = {};
    document.querySelectorAll("#app input, #app select, #app textarea").forEach(el => {
      if (!el.id || el.type === "file") return;
      data[el.id] = (el.type === "checkbox") ? el.checked : el.value;
    });
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      Object.keys(data).forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === "checkbox") el.checked = !!data[id];
        else el.value = data[id];
      });
    } catch(e) {}
    const d = document.getElementById("mote_datum");
    if (d && d.value) d.type = "date";
    const t = document.getElementById("mote_tid");
    if (t && t.value) t.type = "time";
    updateFilledPills();
  }

  function updateFilledPills() {
    document.querySelectorAll(".pill-select").forEach(sel => {
      sel.classList.toggle("filled", sel.value && sel.value !== "ej_valt");
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadState();
    document.querySelectorAll("#app input, #app select, #app textarea").forEach(el => {
      if (el.type === "file") return;
      el.addEventListener("input", () => { if (el.classList?.contains("pill-select")) updateFilledPills(); saveState(); });
      el.addEventListener("change", () => { if (el.classList?.contains("pill-select")) updateFilledPills(); saveState(); });
    });
  });
</script>

</body>
</html>

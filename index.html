<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petrabadrum ‚Äì Offertunderlag</title>
  <style>
    :root{
      --bg:#eef2f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#1d4ed8;
      --btn:#e9eef6;
      --btnText:#0f172a;
      --pill:#f8fafc;
      --chosenBg:#e8f5e9;
      --chosenBorder:#2e7d32;
      --shadow:0 12px 26px rgba(15,23,42,.08);
      --radius:18px;
      --radiusSm:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:linear-gradient(180deg,#f7f9fc 0%, var(--bg) 45%, #edf2f7 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 36px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 6px 14px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;color:#0b2a6a;letter-spacing:.2px;}
    .brand img{
      width:34px;height:34px;object-fit:contain;border-radius:10px;background:#fff;border:1px solid var(--line);
    }
    .actions{display:flex;gap:10px;align-items:center;}
    .btn{
      appearance:none;border:1px solid var(--line);background:var(--btn);color:var(--btnText);
      border-radius:999px;padding:10px 14px;font-weight:600;letter-spacing:.1px;
      box-shadow:0 6px 14px rgba(15,23,42,.06);
      min-height:44px;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{background:var(--brand);color:#fff;border-color:transparent;}

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:16px;margin:12px 0;
    }
    .card h2{margin:0 0 6px;font-size:22px;font-weight:800;letter-spacing:.2px;color:#0b2a6a;}
    .card .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.35;font-weight:500;}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:700px){.grid2{grid-template-columns:1fr 1fr;}}

    label{
      display:block;font-size:12px;color:var(--muted);font-weight:700;letter-spacing:.2px;margin:0 0 6px;
    }
    .field,.select,.pillBtn{
      width:100%;border:1px solid var(--line);border-radius:var(--radiusSm);background:var(--pill);
      padding:12px 12px;font-size:15px;font-weight:600;color:var(--text);outline:none;min-height:48px;
    }
    .field::placeholder{color:#94a3b8;font-weight:600}
    .select{padding-right:38px}
    .chosen{
      background:var(--chosenBg) !important;
      border-color:rgba(46,125,50,.65) !important;
      box-shadow:0 8px 18px rgba(46,125,50,.10);
      color:#0b3d1a !important;
    }

    .twoBtns{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
    .note{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px;font-weight:500;}

    /* Luftigare summeringsruta */
    .priceBox{
      border:2px dashed #cbd5e1;
      border-radius:18px;
      padding:18px 18px;
      background:#fbfdff;
      margin-top:14px;
    }
    .priceRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      padding:10px 0;
      color:#0f172a;
      font-weight:700;
    }
    .priceRow small{
      color:var(--muted);
      font-weight:700;
      line-height:1.35;
      max-width:70%;
    }
    .priceRow span{
      text-align:right;
      min-width:110px;
      line-height:1.25;
      font-weight:800;
    }
    .priceBig{
      font-size:18px;
      font-weight:900;
      color:#0b2a6a;
      padding-top:14px;
      margin-top:10px;
      border-top:1px solid var(--line);
    }
    @media (max-width:700px){
      .priceBox{ padding:20px; }
      .priceRow small{ max-width:64%; }
    }

    .textarea{
      width:100%;min-height:110px;resize:vertical;border:1px solid var(--line);
      border-radius:var(--radiusSm);padding:12px;font-size:14px;font-weight:600;
      background:#fbfdff;outline:none;
    }
    .textarea::placeholder{color:#94a3b8;font-weight:600}

    /* Modal */
    .modalOverlay{
      position:fixed;inset:0;background:rgba(15,23,42,.40);display:none;
      align-items:flex-end;justify-content:center;padding:14px;z-index:9999;
    }
    .modal{
      width:min(920px,100%);max-height:86vh;overflow:auto;background:#fff;border:1px solid var(--line);
      border-radius:18px;box-shadow:0 20px 60px rgba(15,23,42,.25);padding:14px;
    }
    .modalHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 4px 10px;}
    .modalHeader h3{margin:0;font-size:16px;font-weight:800;color:#0b2a6a}
    .modalBtns{display:flex;gap:10px;flex-wrap:wrap;}
    .modalBody{padding:8px 6px 4px;}
    .table{
      width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--line);
      border-radius:14px;
    }
    .table th,.table td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px;text-align:left;}
    .table th{background:#f8fafc;color:#0f172a;font-weight:800}
    .table tr:last-child td{border-bottom:none;}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #dbe4ff;font-size:12px;font-weight:700;color:#1e40af;}

    /* Print A4 */
    .printOnly{display:none}
    @media print{
      body{background:#fff}
      .wrap{max-width:none;padding:0}
      .noPrint{display:none !important}
      .modalOverlay{display:none !important}
      .printOnly{display:block !important}
      .a4{width:210mm;min-height:297mm;padding:16mm 14mm;}
      .a4Header{
        display:flex;align-items:center;justify-content:space-between;gap:12px;
        border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:12px;
      }
      .a4Header img{height:22mm;width:auto;object-fit:contain}
      .a4Title{font-size:18pt;font-weight:800;margin:0;}
      .a4Sub{margin:4px 0 0;color:#334155;font-weight:600}
      .a4Section{margin:12px 0}
      .a4Section h3{margin:0 0 6px;font-size:12.5pt;font-weight:800;color:#0f172a;}
      .a4Grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px;font-size:11pt;}
      .kv{display:flex;gap:8px}
      .k{min-width:82px;color:#334155;font-weight:800}
      .v{color:#0f172a;font-weight:650}
      .a4Box{border:1px solid #e5e7eb;border-radius:10px;padding:10px;}
      .a4Price{font-size:13pt;font-weight:900;color:#0b2a6a;}
      .split{margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px;}
      .splitRow{display:flex;justify-content:space-between;gap:10px;font-size:11pt;font-weight:800;padding:4px 0;}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar noPrint">
      <div class="brand">
        <img id="logoTop" alt="Petra" />
        <div>Petrabadrum</div>
      </div>
      <div class="actions">
        <button class="btn" id="resetBtn" type="button">Nollst√§ll</button>
      </div>
    </div>

    <!-- KUND + M√ñTE -->
    <div class="card noPrint">
      <h2>Kunduppgifter</h2>
      <p class="sub">Fylls i vid f√∂rsta telefonkontakten och inf√∂r kundbes√∂k.</p>

      <div class="grid2">
        <div>
          <label for="kundnamn">Kundnamn</label>
          <input class="field" id="kundnamn" placeholder="Ex. Anna Andersson" />
        </div>
        <div>
          <label for="adress">Adress</label>
          <input class="field" id="adress" placeholder="Gata, postnummer, ort" />
        </div>
        <div>
          <label for="telefon">Telefon</label>
          <input class="field" id="telefon" inputmode="tel" />
        </div>
        <div>
          <label for="epost">E-post</label>
          <input class="field" id="epost" inputmode="email" />
        </div>
      </div>

      <div style="height:10px"></div>
      <h2 style="font-size:20px; margin-top:6px;">M√∂tesdata</h2>

      <div class="grid2">
        <div>
          <label for="datum">Datum</label>
          <select class="select" id="datum"></select>
        </div>

        <div style="position:relative;">
          <label for="tid">Tid</label>
          <div style="position:relative;">
            <select class="select" id="tid" style="padding-right:58px;"></select>
            <button id="calendarBtn" type="button"
              title="L√§gg till i kalender"
              style="position:absolute; right:8px; top:50%; transform:translateY(-50%);
                     width:40px; height:40px; border-radius:12px; border:1px solid var(--line);
                     background:#fff; font-weight:900; cursor:pointer;">
              üìÖ
            </button>
          </div>
        </div>

        <div>
          <label for="motestyp">M√∂testyp</label>
          <select class="select" id="motestyp">
            <option value="">Ej valt</option>
            <option>F√∂rsta bes√∂k</option>
            <option>√Öterbes√∂k</option>
            <option>Digitalt m√∂te</option>
          </select>
        </div>
        <div>
          <label for="plats">Plats</label>
          <input class="field" id="plats" placeholder="Hos kund, adress eller Teams-l√§nk" />
        </div>

        <div>
          <label for="rotCheck">ROT</label>
          <select class="select" id="rotCheck">
            <option value="nej">Nej</option>
            <option value="ja">Ja</option>
          </select>
        </div>
        <div>
          <label for="rotBelopp">Belopp (ROT)</label>
          <input class="field" id="rotBelopp" inputmode="numeric" placeholder="0" />
        </div>
      </div>

      <div class="note">Kalenderknappen skapar en .ics-fil som du kan l√§gga till i iPhone-kalendern.</div>
    </div>

    <!-- BADRUMSDATA -->
    <div class="card noPrint">
      <h2>Badrumsdata</h2>
      <p class="sub">Valen anv√§nds f√∂r pris + sammanfattning.</p>

      <div class="grid2">
        <div>
          <label for="niva">Niv√•</label>
          <select class="select" id="niva">
            <option value="">Ej valt</option>
            <option value="standard">Standard</option>
            <option value="premium">Premium</option>
            <option value="exclusive">Exclusive</option>
          </select>
        </div>
        <div>
          <label for="storlek">Storlek (m¬≤)</label>
          <select class="select" id="storlek"></select>
        </div>
        <div>
          <label for="takh">Takh√∂jd (m)</label>
          <select class="select" id="takh"></select>
        </div>

        <!-- √Ñndra avloppsl√∂sning -->
        <div>
          <label for="avloppFlytt">√Ñndra avloppsl√∂sning</label>
          <select class="select" id="avloppFlytt">
            <option value="nej">Nej</option>
            <option value="tra">Tr√§bj√§lklag</option>
            <option value="lattbetong">L√§ttbetongbj√§lklag</option>
            <option value="betong">Betongbj√§lklag</option>
          </select>
        </div>
      </div>
    </div>

    <!-- VAL (ALLT DROPDOWNS) -->
    <div class="card noPrint">
      <h2>Funktioner & utrustning</h2>
      <p class="sub">Alla val g√∂rs som dropdown-menyer. Prissatta val p√•verkar kalkylen.</p>

      <div class="grid2">
        <!-- Dusch -->
        <div>
          <label for="duschTyp">Dusch</label>
          <select class="select" id="duschTyp">
            <option value="kaklad">Kaklad dusch</option>
            <option value="kabin">Duschkabin</option>
          </select>
        </div>

        <!-- Rivning -->
        <div>
          <label for="rivKakel">Rivning kakel & klinker</label>
          <select class="select" id="rivKakel">
            <option value="nej">Nej</option>
            <option value="ja">Ja</option>
          </select>
        </div>

        <div>
          <label for="rivGolvvarme">Rivning befintlig golvv√§rme</label>
          <select class="select" id="rivGolvvarme">
            <option value="nej">Nej</option>
            <option value="ja">Ja</option>
          </select>
        </div>

        <!-- Golvv√§rme -->
        <div>
          <label for="golvvarme">Golvv√§rme</label>
          <select class="select" id="golvvarme">
            <option value="behall">Beh√•ll befintlig</option>
            <option value="el">Ny golvv√§rme (el)</option>
            <option value="vatten">Ny golvv√§rme (vatten)</option>
          </select>
        </div>

        <!-- Rivning v√§gg -->
        <div>
          <label for="rivVagg">Rivning av v√§gg</label>
          <select class="select" id="rivVagg">
            <option value="nej">Nej</option>
            <option value="litet">Litet jobb</option>
            <option value="medel">Medelstort jobb</option>
            <option value="omfattande">Omfattande jobb</option>
          </select>
        </div>

        <!-- Avloppsl√∂sning -->
        <div>
          <label for="avloppsLosning">Avloppsl√∂sning</label>
          <select class="select" id="avloppsLosning">
            <option value="vanligt">Vanligt avlopp</option>
            <option value="unidrain">Unidrain eller likn</option>
          </select>
        </div>

        <!-- Kakelh√∂rn -->
        <div>
          <label for="kakelHorn">Kakelh√∂rn</label>
          <select class="select" id="kakelHorn">
            <option value="list">Kakellist</option>
            <option value="4545">45/45</option>
          </select>
        </div>

        <!-- Spotlights -->
        <div>
          <label for="spotlights">Spotlights</label>
          <select class="select" id="spotlights">
            <option value="behall">Beh√•ll befintliga</option>
            <option value="nya">Installera nya</option>
          </select>
        </div>

        <!-- H√§mtservice -->
        <div>
          <label for="hamtaKakel">Vi h√§mtar kakel & klinker</label>
          <select class="select" id="hamtaKakel">
            <option value="nej">Nej</option>
            <option value="ja">Ja</option>
          </select>
        </div>

        <div>
          <label for="hamtaInredning">Vi h√§mtar badrumsinredning</label>
          <select class="select" id="hamtaInredning">
            <option value="nej">Nej</option>
            <option value="ja">Ja</option>
          </select>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="grid2">
        <div>
          <label>√ñvrigt</label>
          <button class="pillBtn" id="ovrigtBtn" type="button">L√§gg till poster</button>
        </div>
        <div></div>
      </div>

      <div id="ovrigtList" style="margin-top:10px;"></div>

      <div class="priceBox">
        <div class="priceRow"><small>Delsumma (exkl. moms, inkl. 10% h√∂jning)</small><span id="sumEx">0 kr</span></div>
        <div class="priceRow"><small>ROT-avdrag</small><span id="rotOut">-0 kr</span></div>
        <div class="priceRow priceBig"><span>Pris efter ROT-avdrag (exkl. moms)</span><span id="afterRotEx">0 kr</span></div>
        <div class="priceRow"><small>Pris efter ROT-avdrag (inkl. moms)</small><span id="afterRotInc">0 kr</span></div>
      </div>
    </div>

    <!-- ANTECKNINGAR -->
    <div class="card noPrint">
      <h2>Anteckningar</h2>
      <p class="sub">Frivilligt.</p>

      <textarea class="textarea" id="notes" placeholder="S√§rskilda f√∂ruts√§ttningar, tr√•nga utrymmen, parkering, tidsf√∂nster, bilder/video bifogas separat etc."></textarea>

      <div class="twoBtns">
        <button class="btn btnPrimary" id="calcBtn" type="button">Ber√§kna pris</button>
        <button class="btn" id="sendBtn" type="button">Skicka till PetraBygg</button>
        <button class="btn" id="saveBtn" type="button">Spara</button>
        <button class="btn" id="detailBtn" type="button">Detaljerad summering</button>
      </div>
    </div>

    <!-- PRINT A4 -->
    <div class="printOnly a4" id="printA4">
      <div class="a4Header">
        <img id="logoPrint" alt="Petra" />
        <div style="flex:1;">
          <p class="a4Title">Offertunderlag f√∂r badrumsrenovering</p>
          <p class="a4Sub" id="a4Meta"></p>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Kund</h3>
        <div class="a4Grid">
          <div class="kv"><div class="k">Namn:</div><div class="v" id="a4Kund"></div></div>
          <div class="kv"><div class="k">Adress:</div><div class="v" id="a4Adress"></div></div>
          <div class="kv"><div class="k">Telefon:</div><div class="v" id="a4Tel"></div></div>
          <div class="kv"><div class="k">E-post:</div><div class="v" id="a4Epost"></div></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Badrumsdata</h3>
        <div class="a4Grid">
          <div class="kv"><div class="k">Niv√•:</div><div class="v" id="a4Niva"></div></div>
          <div class="kv"><div class="k">Storlek:</div><div class="v" id="a4Storlek"></div></div>
          <div class="kv"><div class="k">Takh√∂jd:</div><div class="v" id="a4Takh"></div></div>
          <div class="kv"><div class="k">ROT:</div><div class="v" id="a4Rot"></div></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Val & till√§gg</h3>
        <div class="a4Grid" id="a4Val"></div>
      </div>

      <div class="a4Section a4Box">
        <h3>Uppskattat pris (efter ROT)</h3>
        <div class="a4Price" id="a4Pris"></div>

        <div class="split">
          <div class="splitRow"><span>Etablering (5%)</span><span id="a4Etab"></span></div>
          <div class="splitRow"><span>Arbetskostnad (55%)</span><span id="a4Arb"></span></div>
          <div class="splitRow"><span>Materialkostnad (40%)</span><span id="a4Mat"></span></div>
        </div>
      </div>

      <div class="a4Section a4Box">
        <h3>Anteckningar</h3>
        <div style="white-space:pre-wrap; font-size:11pt; font-weight:650;" id="a4Notes"></div>
      </div>
    </div>

  </div>

  <!-- Modal: Detaljerad summering -->
  <div class="modalOverlay noPrint" id="detailOverlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="modalHeader">
        <h3 id="detailTitle">Detaljerad summering</h3>
        <div class="modalBtns">
          <button class="btn" id="detailSaveBtn" type="button">Spara</button>
          <button class="btn" id="detailCloseBtn" type="button">St√§ng</button>
        </div>
      </div>
      <div class="modalBody" id="detailBody"></div>
    </div>
  </div>

<script>
/* =========================
   KONFIG
========================= */
const STORAGE_KEY = "petrabadrum_form_dropdown_v1";
const LOGO_SRC = "petrabygg_logo.png";

/* Baspris (min + per m¬≤) */
const BASE_PRICING = {
  start: { standard: 115000, premium: 135000, exclusive: 165000 },
  perM2:  { standard: 6500,  premium: 8000,  exclusive: 9500 }
};

const PRICES = {
  PCT_UPLIFT: 0.10,
  VAT: 0.25,
  hamtaService: 5000,

  // √Ñndra avloppsl√∂sning (nya alternativ inkl l√§ttbetong)
  avloppFlytt: { nej: 0, tra: 10000, lattbetong: 15000, betong: 20000 },

  // Golvv√§rme ‚Äì per m¬≤ vid "ny"
  golvvarmePerM2: { behall: 0, el: 1800, vatten: 2100 },

  ceilingFactor: (h) => {
    if (h >= 2.8) return 1.10;
    if (h >= 2.5) return 1.05;
    return 1.00;
  }
};

/* Nya prissatta dropdown-val (rimliga default ‚Äì justera vid behov) */
const ADDON_PRICES = {
  duschTyp: { kaklad: 0, kabin: 9000 },
  rivKakel: { nej: 0, ja: 12000 },
  rivGolvvarme: { nej: 0, ja: 6000 },
  rivVagg: { nej: 0, litet: 5000, medel: 12000, omfattande: 25000 },
  avloppsLosning: { vanligt: 0, unidrain: 8000 },
  kakelHorn: { list: 0, "4545": 4000 },
  spotlights: { behall: 0, nya: 8000 }
};

/* =========================
   HJ√ÑLPARE
========================= */
const el = (id) => document.getElementById(id);
const fmt = (n) => (Math.round(n)).toLocaleString("sv-SE") + " kr";

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function setLogo(){
  const img1 = el("logoTop");
  const img2 = el("logoPrint");
  img1.src = LOGO_SRC;
  img2.src = LOGO_SRC;
  img1.onerror = () => { img1.style.display="none"; };
  img2.onerror = () => { img2.style.display="none"; };
}

function populateDateTime(){
  const dSel = el("datum");
  dSel.innerHTML = `<option value="">Datum</option>`;
  const now = new Date();
  for(let i=0;i<61;i++){
    const d = new Date(now);
    d.setDate(now.getDate()+i);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const val = `${y}-${m}-${day}`;
    const txt = `${day}/${m}/${y}`;
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = txt;
    dSel.appendChild(opt);
  }

  const tSel = el("tid");
  tSel.innerHTML = `<option value="">Tid</option>`;
  for(let h=7; h<=19; h++){
    for(let min=0; min<60; min+=15){
      const hh = String(h).padStart(2,"0");
      const mm = String(min).padStart(2,"0");
      const val = `${hh}:${mm}`;
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      tSel.appendChild(opt);
    }
  }
}

function populateBathroom(){
  const size = el("storlek");
  size.innerHTML = `<option value="">Ej valt</option>`;
  for(let i=2;i<=20;i++){
    const opt=document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i} m¬≤`;
    size.appendChild(opt);
  }

  const takh = el("takh");
  takh.innerHTML = `<option value="">Ej valt</option>`;
  for(let x=2.0; x<=3.0+1e-9; x+=0.1){
    const v = x.toFixed(1).replace(".", ",");
    const opt=document.createElement("option");
    opt.value = String(x.toFixed(1));
    opt.textContent = `${v} m`;
    takh.appendChild(opt);
  }
}

function markChosenUI(){
  document.querySelectorAll("select.select").forEach(s=>{
    if(s.value && s.value !== "nej") s.classList.add("chosen");
    else s.classList.remove("chosen");
  });
  const rb = el("rotBelopp");
  const rbNum = Number((rb.value||"0").replace(/\s/g,"").replace(",", "."));
  if(rb.value.trim() && rbNum > 0) rb.classList.add("chosen");
  else rb.classList.remove("chosen");
}

function addOvrigtRow(text="", amount=0){
  const row = document.createElement("div");
  row.className = "grid2 ovrItem";
  row.style.marginTop="10px";
  row.innerHTML = `
    <div>
      <label>Post</label>
      <input class="field ovrText" placeholder="Ex. F√∂nsterbyte / Bygga in badkar" value="${escapeHtml(text)}" />
    </div>
    <div>
      <label>Belopp (kr)</label>
      <input class="field ovrAmount" inputmode="numeric" placeholder="0" value="${amount ? String(amount) : ""}" />
    </div>
  `;
  el("ovrigtList").appendChild(row);
  row.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", ()=>{ persist(); calc(); });
  });
}

function getOvrigt(){
  return [...document.querySelectorAll(".ovrItem")].map(row=>{
    const t = row.querySelector(".ovrText").value.trim();
    const a = Number((row.querySelector(".ovrAmount").value||"0").replace(/\s/g,"").replace(",", "."));
    return { text:t, amount:isFinite(a)?a:0 };
  }).filter(x=>x.text || x.amount);
}

function getState(){
  return {
    kundnamn: el("kundnamn").value.trim(),
    adress: el("adress").value.trim(),
    telefon: el("telefon").value.trim(),
    epost: el("epost").value.trim(),

    datum: el("datum").value,
    tid: el("tid").value,
    motestyp: el("motestyp").value,
    plats: el("plats").value.trim(),

    rot: el("rotCheck").value, // ja/nej
    rotBelopp: Number((el("rotBelopp").value||"0").replace(/\s/g,"").replace(",", ".")) || 0,

    niva: el("niva").value,
    storlek: Number(el("storlek").value||0) || 0,
    takh: Number(el("takh").value||0) || 0,

    // nya dropdowns
    avloppFlytt: el("avloppFlytt").value,
    duschTyp: el("duschTyp").value,
    rivKakel: el("rivKakel").value,
    rivGolvvarme: el("rivGolvvarme").value,
    golvvarme: el("golvvarme").value,
    rivVagg: el("rivVagg").value,
    avloppsLosning: el("avloppsLosning").value,
    kakelHorn: el("kakelHorn").value,
    spotlights: el("spotlights").value,

    hamtaKakel: el("hamtaKakel").value,
    hamtaInredning: el("hamtaInredning").value,

    ovrigt: getOvrigt(),
    notes: el("notes").value
  };
}

function setState(s){
  if(!s) return;
  el("kundnamn").value = s.kundnamn || "";
  el("adress").value = s.adress || "";
  el("telefon").value = s.telefon || "";
  el("epost").value = s.epost || "";

  el("datum").value = s.datum || "";
  el("tid").value = s.tid || "";
  el("motestyp").value = s.motestyp || "";
  el("plats").value = s.plats || "";

  el("rotCheck").value = s.rot || "nej";
  el("rotBelopp").value = (s.rotBelopp ?? 0) ? String(s.rotBelopp) : "";

  el("niva").value = s.niva || "";
  el("storlek").value = s.storlek ? String(s.storlek) : "";
  el("takh").value = s.takh ? String(Number(s.takh).toFixed(1)) : "";

  el("avloppFlytt").value = s.avloppFlytt || "nej";
  el("duschTyp").value = s.duschTyp || "kaklad";
  el("rivKakel").value = s.rivKakel || "nej";
  el("rivGolvvarme").value = s.rivGolvvarme || "nej";
  el("golvvarme").value = s.golvvarme || "behall";
  el("rivVagg").value = s.rivVagg || "nej";
  el("avloppsLosning").value = s.avloppsLosning || "vanligt";
  el("kakelHorn").value = s.kakelHorn || "list";
  el("spotlights").value = s.spotlights || "behall";

  el("hamtaKakel").value = s.hamtaKakel || "nej";
  el("hamtaInredning").value = s.hamtaInredning || "nej";

  el("notes").value = s.notes || "";

  el("ovrigtList").innerHTML = "";
  (s.ovrigt || []).forEach(x => addOvrigtRow(x.text, x.amount));

  markChosenUI();
}

/* =========================
   LAGRING
========================= */
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(getState())); }
function restore(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{ setState(JSON.parse(raw)); }catch(e){}
}
function resetAll(){
  localStorage.removeItem(STORAGE_KEY);
  document.querySelectorAll("input, textarea").forEach(i=> i.value="");
  document.querySelectorAll("select").forEach(s=> s.selectedIndex = 0);
  el("ovrigtList").innerHTML = "";
  updatePriceUI(0,0,0,0);
  markChosenUI();
}

/* =========================
   PRISLOGIK
========================= */
function calc(){
  const s = getState();

  // Baspris (min + per m¬≤) med takh√∂jdsfaktor
  let base = 0;
  if(s.niva && s.storlek){
    const min = BASE_PRICING.start[s.niva] || 0;
    const per = BASE_PRICING.perM2[s.niva] || 0;
    base = min + (per * s.storlek);
    if(s.takh) base = base * PRICES.ceilingFactor(s.takh);
  }

  let add = 0;

  // √Ñndra avloppsl√∂sning (bj√§lklag)
  add += PRICES.avloppFlytt[s.avloppFlytt] || 0;

  // Dusch
  add += (ADDON_PRICES.duschTyp[s.duschTyp] || 0);

  // Rivning
  add += (ADDON_PRICES.rivKakel[s.rivKakel] || 0);
  add += (ADDON_PRICES.rivGolvvarme[s.rivGolvvarme] || 0);

  // Golvv√§rme (ny per m¬≤)
  if(s.storlek && (s.golvvarme === "el" || s.golvvarme === "vatten")){
    add += (PRICES.golvvarmePerM2[s.golvvarme] || 0) * s.storlek;
  }

  // Rivning v√§gg
  add += (ADDON_PRICES.rivVagg[s.rivVagg] || 0);

  // Avloppsl√∂sning (Unidrain)
  add += (ADDON_PRICES.avloppsLosning[s.avloppsLosning] || 0);

  // Kakelh√∂rn
  add += (ADDON_PRICES.kakelHorn[s.kakelHorn] || 0);

  // Spotlights
  add += (ADDON_PRICES.spotlights[s.spotlights] || 0);

  // H√§mtservice
  if(s.hamtaKakel === "ja") add += PRICES.hamtaService;
  if(s.hamtaInredning === "ja") add += PRICES.hamtaService;

  // √ñvrigt poster
  add += (s.ovrigt||[]).reduce((sum,x)=> sum + (Number(x.amount)||0), 0);

  let subtotal = base + add;

  // +10% exkl moms
  subtotal = subtotal * (1 + PRICES.PCT_UPLIFT);

  // ROT
  let rot = 0;
  if(s.rot === "ja"){
    rot = Math.max(0, Number(s.rotBelopp)||0);
  }
  rot = Math.min(rot, subtotal);

  const afterRotEx = Math.max(0, subtotal - rot);
  const afterRotInc = afterRotEx * (1 + PRICES.VAT);

  updatePriceUI(subtotal, rot, afterRotEx, afterRotInc);
  markChosenUI();
  persist();
}

function updatePriceUI(subtotal=0, rot=0, afterRotEx=0, afterRotInc=0){
  el("sumEx").textContent = fmt(subtotal);
  el("rotOut").textContent = "-" + fmt(rot).replace(" kr","");
  el("afterRotEx").textContent = fmt(afterRotEx);
  el("afterRotInc").textContent = fmt(afterRotInc);
}

/* =========================
   KALENDER (.ics)
========================= */
function addToCalendar(){
  const s = getState();
  if(!s.datum || !s.tid){
    alert("Fyll i datum och tid f√∂rst.");
    return;
  }
  const [y,m,d] = s.datum.split("-").map(Number);
  const [hh,mm] = s.tid.split(":").map(Number);
  const start = new Date(y, m-1, d, hh, mm, 0);
  const end = new Date(start.getTime() + 60*60*1000);

  const pad = (n)=> String(n).padStart(2,"0");
  const toICS = (dt)=> `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}00`;

  const title = `Kundbes√∂k: ${s.kundnamn || "Badrum"}`;
  const loc = s.plats || s.adress || "";
  const desc = `Petrabadrum ‚Äì offertunderlag.\nM√∂testyp: ${s.motestyp||"‚Äî"}\nTelefon: ${s.telefon||"‚Äî"}\nE-post: ${s.epost||"‚Äî"}`;

  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Petrabadrum//SE
BEGIN:VEVENT
DTSTART:${toICS(start)}
DTEND:${toICS(end)}
SUMMARY:${title}
LOCATION:${loc}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `petrabadrum_mote_${s.datum}_${s.tid.replace(":","")}.ics`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   A4 / Skicka till PetraBygg
========================= */
function buildA4(){
  calc();
  const s = getState();

  const metaParts = [];
  if(s.datum) metaParts.push(`Datum: ${s.datum}`);
  if(s.tid) metaParts.push(`Tid: ${s.tid}`);
  if(s.motestyp) metaParts.push(`M√∂testyp: ${s.motestyp}`);
  if(s.plats) metaParts.push(`Plats: ${s.plats}`);
  el("a4Meta").textContent = metaParts.join("  ‚Ä¢  ");

  el("a4Kund").textContent = s.kundnamn || "‚Äî";
  el("a4Adress").textContent = s.adress || "‚Äî";
  el("a4Tel").textContent = s.telefon || "‚Äî";
  el("a4Epost").textContent = s.epost || "‚Äî";

  el("a4Niva").textContent = s.niva ? (s.niva[0].toUpperCase()+s.niva.slice(1)) : "‚Äî";
  el("a4Storlek").textContent = s.storlek ? `${s.storlek} m¬≤` : "‚Äî";
  el("a4Takh").textContent = s.takh ? `${String(s.takh).replace(".", ",")} m` : "‚Äî";
  el("a4Rot").textContent = (s.rot === "ja") ? (`Ja, ${fmt(s.rotBelopp||0)}`) : "Nej";

  el("a4Pris").textContent = `${el("afterRotEx").textContent} (efter ROT, exkl. moms)`;

  const exNum = Number((el("afterRotEx").textContent||"0")
    .replaceAll("kr","").replace(/\s/g,"")
    .replaceAll(".", "").replace(",", ".")) || 0;

  el("a4Etab").textContent = fmt(exNum * 0.05);
  el("a4Arb").textContent  = fmt(exNum * 0.55);
  el("a4Mat").textContent  = fmt(exNum * 0.40);

  const pairs = [];
  const push = (k,v)=> pairs.push([k,v]);

  push("Dusch", s.duschTyp === "kaklad" ? "Kaklad dusch" : "Duschkabin");
  push("Rivning kakel/klinker", s.rivKakel === "ja" ? "Ja" : "Nej");
  push("Rivning bef. golvv√§rme", s.rivGolvvarme === "ja" ? "Ja" : "Nej");
  push("Golvv√§rme", s.golvvarme === "behall" ? "Beh√•ll befintlig" : (s.golvvarme === "el" ? "Ny (el)" : "Ny (vatten)"));
  push("Rivning v√§gg", s.rivVagg);
  push("Avloppsl√∂sning", s.avloppsLosning === "unidrain" ? "Unidrain eller likn" : "Vanligt avlopp");
  push("Kakelh√∂rn", s.kakelHorn === "4545" ? "45/45" : "Kakellist");
  push("Spotlights", s.spotlights === "nya" ? "Installera nya" : "Beh√•ll befintliga");
  push("√Ñndra avloppsl√∂sning", s.avloppFlytt);
  push("Vi h√§mtar kakel/klinker", s.hamtaKakel === "ja" ? "Ja" : "Nej");
  push("Vi h√§mtar badrumsinredning", s.hamtaInredning === "ja" ? "Ja" : "Nej");

  (s.ovrigt||[]).forEach((x,idx)=>{
    push(`√ñvrigt ${idx+1}`, `${x.text || "‚Äî"} (${fmt(x.amount||0)})`);
  });

  const box = el("a4Val");
  box.innerHTML = "";
  pairs.forEach(([k,v])=>{
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<div class="k">${escapeHtml(k)}:</div><div class="v">${escapeHtml(v)}</div>`;
    box.appendChild(div);
  });

  el("a4Notes").textContent = (s.notes || "‚Äî");
}

function sendToPetraBygg(){
  buildA4();
  window.print();
}

/* =========================
   Detaljerad summering
========================= */
function buildDetailed(){
  calc();
  const s = getState();

  const min = s.niva ? (BASE_PRICING.start[s.niva] || 0) : 0;
  const per = s.niva ? (BASE_PRICING.perM2[s.niva] || 0) : 0;
  const factor = s.takh ? PRICES.ceilingFactor(s.takh) : 1.00;

  const baseBeforeFactor = (s.niva && s.storlek) ? (min + per * s.storlek) : 0;
  const baseAfterFactor  = baseBeforeFactor * factor;

  const rows = [];

  // Radpriser (exkl. 10% h√∂jning, eftersom h√∂jningen √§r global)
  rows.push(["Dusch", s.duschTyp === "kabin" ? "Duschkabin" : "Kaklad dusch", fmt(ADDON_PRICES.duschTyp[s.duschTyp]||0)]);
  rows.push(["Rivning kakel & klinker", s.rivKakel === "ja" ? "Ja" : "Nej", fmt(ADDON_PRICES.rivKakel[s.rivKakel]||0)]);
  rows.push(["Rivning bef. golvv√§rme", s.rivGolvvarme === "ja" ? "Ja" : "Nej", fmt(ADDON_PRICES.rivGolvvarme[s.rivGolvvarme]||0)]);
  rows.push(["Golvv√§rme", s.golvvarme, (s.storlek && (s.golvvarme==="el"||s.golvvarme==="vatten")) ? fmt((PRICES.golvvarmePerM2[s.golvvarme]||0)*s.storlek) : "0 kr"]);
  rows.push(["Rivning av v√§gg", s.rivVagg, fmt(ADDON_PRICES.rivVagg[s.rivVagg]||0)]);
  rows.push(["Avloppsl√∂sning", s.avloppsLosning, fmt(ADDON_PRICES.avloppsLosning[s.avloppsLosning]||0)]);
  rows.push(["Kakelh√∂rn", s.kakelHorn, fmt(ADDON_PRICES.kakelHorn[s.kakelHorn]||0)]);
  rows.push(["Spotlights", s.spotlights, fmt(ADDON_PRICES.spotlights[s.spotlights]||0)]);
  rows.push(["√Ñndra avloppsl√∂sning", s.avloppFlytt, fmt(PRICES.avloppFlytt[s.avloppFlytt]||0)]);
  rows.push(["Vi h√§mtar kakel & klinker", s.hamtaKakel, s.hamtaKakel==="ja" ? fmt(PRICES.hamtaService) : "0 kr"]);
  rows.push(["Vi h√§mtar badrumsinredning", s.hamtaInredning, s.hamtaInredning==="ja" ? fmt(PRICES.hamtaService) : "0 kr"]);

  const ovrRows = (s.ovrigt||[]).map((x,idx)=>`
    <tr>
      <td>√ñvrigt ${idx+1}: ${escapeHtml(x.text||"‚Äî")}</td>
      <td>‚Äî</td>
      <td>${fmt(x.amount||0)}</td>
    </tr>
  `).join("");

  const meetingLine = [
    s.datum ? `Datum: ${escapeHtml(s.datum)}` : "",
    s.tid ? `Tid: ${escapeHtml(s.tid)}` : "",
    s.motestyp ? `M√∂testyp: ${escapeHtml(s.motestyp)}` : "",
    s.plats ? `Plats: ${escapeHtml(s.plats)}` : ""
  ].filter(Boolean).join(" ‚Ä¢ ");

  el("detailBody").innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
      <div><span class="tag">Kund</span> <b>${escapeHtml(s.kundnamn||"‚Äî")}</b></div>
      <div><span class="tag">Adress</span> <b>${escapeHtml(s.adress||"‚Äî")}</b></div>
      <div><span class="tag">Telefon</span> <b>${escapeHtml(s.telefon||"‚Äî")}</b></div>
      <div><span class="tag">E-post</span> <b>${escapeHtml(s.epost||"‚Äî")}</b></div>
      <div style="grid-column:1 / span 2;">
        <span class="tag">M√∂te</span> <b>${meetingLine || "‚Äî"}</b>
      </div>
    </div>

    <div style="margin:12px 0 10px;">
      <div style="font-weight:800;color:#0b2a6a;margin-bottom:6px;">Basv√§rden</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 12px;font-size:13px;">
        <div>Minpris: <b>${fmt(min)}</b></div>
        <div>kr/m¬≤: <b>${fmt(per)}</b></div>
        <div>Takh√∂jdsfaktor: <b>${factor.toFixed(2)}</b></div>
        <div>Baspris (f√∂re till√§gg): <b>${fmt(baseAfterFactor)}</b></div>
      </div>
    </div>

    <table class="table">
      <thead>
        <tr><th>Val</th><th>Valt</th><th>Radpris</th></tr>
      </thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r[0])}</td>
            <td>${escapeHtml(String(r[1]||"‚Äî"))}</td>
            <td>${escapeHtml(String(r[2]||"‚Äî"))}</td>
          </tr>
        `).join("")}
        ${ovrRows}
      </tbody>
    </table>

    <div style="margin-top:14px" class="priceBox">
      <div class="priceRow"><small>Delsumma (exkl. moms, inkl. 10%)</small><span>${el("sumEx").textContent}</span></div>
      <div class="priceRow"><small>ROT-avdrag</small><span>${el("rotOut").textContent} kr</span></div>
      <div class="priceRow priceBig"><span>Pris efter ROT (exkl. moms)</span><span>${el("afterRotEx").textContent}</span></div>
      <div class="priceRow"><small>Pris efter ROT (inkl. moms)</small><span>${el("afterRotInc").textContent}</span></div>
    </div>
  `;
}

function openDetails(){
  buildDetailed();
  el("detailOverlay").style.display = "flex";
}
function closeDetails(){
  el("detailOverlay").style.display = "none";
}

/* =========================
   SPARA (share/download JSON)
========================= */
async function shareFile(filename, mime, content){
  const blob = new Blob([content], {type:mime});
  const file = new File([blob], filename, {type:mime});

  if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
    try{
      await navigator.share({ files: [file], title: filename });
      return;
    }catch(e){}
  }

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function saveDialog(){
  calc();
  const s = getState();
  const safeName = (s.kundnamn || "kund").replace(/[^\w√•√§√∂√Ö√Ñ√ñ-]+/g,"_");
  const filename = `petrabadrum_${safeName}_${(s.datum||"datum")}.json`;

  const payload = {
    ...s,
    price: {
      subtotal_excl_vat_incl_uplift: el("sumEx").textContent,
      rot: el("rotOut").textContent + " kr",
      after_rot_excl_vat: el("afterRotEx").textContent,
      after_rot_incl_vat: el("afterRotInc").textContent
    },
    savedAt: new Date().toISOString()
  };

  await shareFile(filename, "application/json;charset=utf-8", JSON.stringify(payload, null, 2));
}

/* =========================
   EVENTS
========================= */
function bindEvents(){
  document.querySelectorAll("input, textarea, select").forEach(inp=>{
    inp.addEventListener("change", ()=>{ persist(); calc(); });
    inp.addEventListener("input", ()=>{ persist(); });
  });

  el("resetBtn").addEventListener("click", ()=>{
    if(confirm("Nollst√§lla allt?")) resetAll();
  });

  el("ovrigtBtn").addEventListener("click", ()=>{
    addOvrigtRow("", 0);
    persist();
    calc();
  });

  el("calcBtn").addEventListener("click", calc);
  el("calendarBtn").addEventListener("click", addToCalendar);
  el("saveBtn").addEventListener("click", saveDialog);
  el("detailBtn").addEventListener("click", openDetails);
  el("detailCloseBtn").addEventListener("click", closeDetails);
  el("detailOverlay").addEventListener("click", (e)=>{ if(e.target === el("detailOverlay")) closeDetails(); });
  el("detailSaveBtn").addEventListener("click", saveDialog);
  el("sendBtn").addEventListener("click", sendToPetraBygg);
}

/* =========================
   INIT
========================= */
(function init(){
  try{
    setLogo();
    populateDateTime();
    populateBathroom();

    bindEvents();
    restore();
    calc();

    // s√§kerhet
    if(el("storlek").options.length <= 1) populateBathroom();
    if(el("takh").options.length <= 1) populateBathroom();
  }catch(err){
    alert("Fel i scriptet: " + (err && err.message ? err.message : err));
  }
})();
</script>
</body>
</html>
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petrabadrum ‚Äì Offertunderlag</title>
  <style>
    :root{
      --bg:#eef2f7;
      --card:#ffffff;
      --stroke:#cfd7e3;
      --text:#0b1a33;
      --muted:#6c7a92;
      --primary:#1e5bd7;
      --pill:#f3f5f8;
      --pillText:#111827;
      --okBg:#e8f5ea;
      --okBorder:#2f7a3b;
      --shadow: 0 10px 30px rgba(10,20,40,.08);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, #f7f9fc, var(--bg));
      color:var(--text);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 60px;
    }

    .card{
      background:var(--card);
      border:1px solid rgba(207,215,227,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin: 14px 0;
    }

    h2{
      margin: 0 0 6px;
      font-size: 22px;
      letter-spacing: .2px;
      color: #163a7a;
    }
    .sub{
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }

    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .toprow .left{
      display:flex; align-items:center; gap:10px;
    }
    .btn{
      border:1px solid var(--stroke);
      background: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 700;
      color: #0b1a33;
      cursor:pointer;
      font-size: 14px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 14px;
    }
    @media (max-width: 720px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .field label{
      display:block;
      font-weight: 800;
      font-size: 14px;
      margin: 6px 0 6px;
      color:#142a55;
    }

    input[type="text"], input[type="tel"], input[type="email"], input[type="number"], input[type="date"], input[type="time"], textarea, select{
      width:100%;
      border: 1px solid var(--stroke);
      background: #f8fafc;
      border-radius: 16px;
      padding: 12px 12px;
      font-size: 16px;
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    /* ‚ÄúAppiga‚Äù pill-selects */
    .pillwrap{ position:relative; }
    .pill{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border: 1px solid var(--stroke);
      background: var(--pill);
      border-radius: 18px;
      padding: 12px 12px;
      font-size: 16px;
      cursor:pointer;
      user-select:none;
      min-height: 48px;
    }
    .pill .value{
      font-weight: 800;
      color: var(--pillText);
    }
    .pill .value.muted{
      font-weight: 800;
      color: #9aa6ba;
    }
    .pill .chev{
      opacity:.6;
      font-size: 18px;
      line-height: 1;
    }
    .pill.selected{
      background: var(--okBg);
      border-color: rgba(47,122,59,.45);
      box-shadow: 0 8px 18px rgba(47,122,59,.10);
    }

    /* Checkbox list */
    .checks{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 8px;
    }
    .check{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px;
      border:1px solid var(--stroke);
      border-radius: 16px;
      background:#fbfcfe;
    }
    .check input{ width:22px; height:22px; }
    .check span{ font-weight: 700; }

    /* Tid-f√§lt med kalenderikon INUTI */
    .timeWithIcon{ position:relative; }
    .timeWithIcon input{ padding-right: 46px; }
    .calIconBtn{
      position:absolute;
      top:50%;
      right:10px;
      transform: translateY(-50%);
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size: 18px;
    }

    /* Actions */
    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .actionBtn{
      border-radius: 22px;
      padding: 16px 12px;
      font-weight: 900;
      font-size: 16px;
      border: 1px solid var(--stroke);
      background: #eef2f7;
      cursor:pointer;
    }
    .actionBtn.primary{
      background: var(--primary);
      color:#fff;
      border-color: rgba(30,91,215,.3);
    }

    .priceBox{
      margin-top: 10px;
      padding: 14px;
      border-radius: 18px;
      border: 1px dashed rgba(30,91,215,.35);
      background: rgba(30,91,215,.05);
    }
    .priceRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin: 6px 0;
      font-size: 16px;
    }
    .priceRow strong{ font-size: 18px; }
    .muted{ color: var(--muted); }

    /* Modal for √ñvrigt */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(5,12,25,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border-radius: 22px;
      border:1px solid var(--stroke);
      box-shadow: 0 22px 60px rgba(0,0,0,.25);
      padding: 14px;
    }
    .modal h3{ margin: 6px 6px 10px; }
    .otherRows{ display:grid; gap:10px; }
    .otherRow{
      display:grid;
      grid-template-columns: 1fr 140px 44px;
      gap:10px;
      align-items:center;
    }
    .iconBtn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background:#fff;
      cursor:pointer;
      font-size: 18px;
      font-weight: 900;
    }
    .modalFoot{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top: 12px;
    }

    /* Print */
    @media print{
      body{ background:#fff; }
      .wrap{ max-width: 100%; padding: 0; }
      .card{ box-shadow:none; border:1px solid #ddd; page-break-inside: avoid; }
      .noPrint{ display:none !important; }
      textarea, input, select{ border:1px solid #ddd !important; background:#fff !important; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="appRoot">

    <div class="card">
      <div class="toprow">
        <div class="left">
          <h2 style="margin:0;">Kunduppgifter</h2>
        </div>
        <button class="btn noPrint" id="resetBtn" type="button">Nollst√§ll</button>
      </div>
      <p class="sub">Fylls i vid f√∂rsta telefonkontakten och inf√∂r kundbes√∂k.</p>

      <div class="grid2">
        <div class="field">
          <label>Kundnamn</label>
          <input id="kundnamn" type="text" placeholder="Ex. Anna Andersson" />
        </div>
        <div class="field">
          <label>Adress</label>
          <input id="adress" type="text" placeholder="Gata, postnummer, ort" />
        </div>

        <div class="field">
          <label>Telefon</label>
          <input id="telefon" type="tel" placeholder="" />
        </div>
        <div class="field">
          <label>E-post</label>
          <input id="epost" type="email" placeholder="" />
        </div>
      </div>

      <div style="height:10px"></div>

      <h2 style="margin-top:6px;">M√∂tesdata</h2>
      <div class="grid2">
        <!-- Datum som ‚Äúknapp‚Äù -->
        <div class="field pillwrap">
          <label>Datum</label>
          <div class="pill" id="datePill" role="button" tabindex="0">
            <div class="value muted" id="datePillText">Datum</div>
            <div class="chev">‚ñæ</div>
          </div>
          <input id="datum" type="date" style="position:absolute; inset:0; opacity:0; pointer-events:auto;" />
        </div>

        <!-- Tid som ‚Äúknapp‚Äù + kalenderikon inuti -->
        <div class="field pillwrap timeWithIcon">
          <label>Tid</label>
          <div class="pill" id="timePill" role="button" tabindex="0">
            <div class="value muted" id="timePillText">Tid</div>
            <div class="chev">‚ñæ</div>
          </div>
          <input id="tid" type="time" style="position:absolute; inset:0; opacity:0; pointer-events:auto;" />
          <button class="calIconBtn noPrint" id="calendarIconBtn" type="button" title="L√§gg till i kalender">üìÖ</button>
        </div>

        <div class="field">
          <label>M√∂testyp</label>
          <select id="motestyp">
            <option value="">Ej valt</option>
            <option>F√∂rsta bes√∂k</option>
            <option>√Öterbes√∂k</option>
            <option>Digitalt m√∂te</option>
            <option>Telefonsamtal</option>
          </select>
        </div>

        <div class="field">
          <label>Plats</label>
          <input id="plats" type="text" placeholder="Hos kund, adress eller Teams-l√§nk" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid2">
        <div class="check">
          <input id="rot" type="checkbox" />
          <span>Kund vill utnyttja ROT</span>
        </div>
        <div class="field">
          <label>Belopp (ROT)</label>
          <input id="rotBelopp" type="number" inputmode="numeric" placeholder="0" min="0" step="100" />
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Funktioner & utrustning</h2>
      <p class="sub">Valen anv√§nds f√∂r pris + sammanfattning.</p>

      <div class="checks">
        <label class="check"><input id="vh_wc" type="checkbox"><span>V√§ggh√§ngd WC</span></label>
        <label class="check"><input id="gs_wc" type="checkbox"><span>Golvst√•ende WC (info, ingen kostnad)</span></label>
        <label class="check"><input id="handdusch_wc" type="checkbox"><span>Handdusch vid toalett</span></label>
        <label class="check"><input id="badkar" type="checkbox"><span>Badkar</span></label>
        <label class="check"><input id="enbart_dusch" type="checkbox"><span>Enbart dusch</span></label>
        <label class="check"><input id="tvattmaskin" type="checkbox"><span>Tv√§ttmaskin inkl el & avlopp</span></label>
        <label class="check"><input id="sankt_innertak" type="checkbox"><span>S√§nkt innertak</span></label>
        <label class="check"><input id="spackel_malning" type="checkbox"><span>Spackling & m√•lning</span></label>
        <label class="check"><input id="ny_dorr" type="checkbox"><span>Ny d√∂rr</span></label>
        <label class="check"><input id="ny_troskel" type="checkbox"><span>Ny tr√∂skel</span></label>
      </div>

      <div style="height:14px"></div>

      <div class="grid2">
        <div class="field">
          <label>Flytt av avlopp</label>
          <select id="flytt_avlopp">
            <option value="0">Nej</option>
            <option value="10000">Tr√§bj√§lklag (+10 000)</option>
            <option value="20000">Betongbj√§lklag (+20 000)</option>
          </select>
        </div>

        <div class="field">
          <label>√ñvrigt</label>
          <button class="btn noPrint" id="otherBtn" type="button" style="width:100%; border-radius:16px; padding:12px; font-weight:900;">
            L√§gg till poster
          </button>
        </div>
      </div>

      <div class="priceBox">
        <div class="priceRow"><div class="muted">Delsumma (exkl. moms, inkl. 10% h√∂jning)</div><div><strong id="sumEx">0 kr</strong></div></div>
        <div class="priceRow"><div class="muted">ROT-avdrag</div><div><strong id="sumRot">0 kr</strong></div></div>
        <div class="priceRow"><div><strong>Pris efter ROT-avdrag (exkl. moms)</strong></div><div><strong id="sumAfterRot">0 kr</strong></div></div>
        <div class="priceRow"><div class="muted">Pris efter ROT-avdrag (inkl. moms)</div><div><strong id="sumAfterRotInc">0 kr</strong></div></div>
      </div>
    </div>

    <div class="card">
      <h2>Sammanfattning</h2>
      <p class="sub">Denna sammanfattning anv√§nds √§ven f√∂r entrepren√∂ren.</p>
      <textarea id="summary" placeholder="Sammanfattning genereras n√§r du ber√§knar pris. Du kan √§ven justera texten manuellt."></textarea>

      <div style="height:10px"></div>

      <h2>Entrepren√∂rssummering</h2>
      <p class="sub">Extra anteckningar till entrepren√∂ren (om du vill l√§gga till n√•got ut√∂ver sammanfattningen).</p>
      <textarea id="entreprenor" placeholder="Ex. s√§rskilda f√∂ruts√§ttningar, bilder/video bifogas separat, tidsf√∂nster etc."></textarea>

      <div class="actions noPrint">
        <button class="actionBtn primary" id="calcBtn" type="button">Ber√§kna pris</button>
        <button class="actionBtn" id="copyBtn" type="button">Kopiera sammanfattning</button>
        <button class="actionBtn" id="saveBtn" type="button">Spara</button>
        <button class="actionBtn" id="pdfBtn" type="button">Spara som PDF</button>
      </div>
    </div>

    <!-- Modal: √ñvrigt -->
    <div class="modalBack noPrint" id="modalBack">
      <div class="modal">
        <h3>√ñvrigt ‚Äì L√§gg till poster</h3>
        <p class="sub" style="margin: 0 6px 10px;">Ex. f√∂nsterbyte, bygga in badkar, special√∂nskem√•l. Belopp √§r exkl. moms (innan ROT).</p>

        <div class="otherRows" id="otherRows"></div>

        <div class="modalFoot">
          <button class="btn" id="addOtherRow" type="button">+ Ny rad</button>
          <div style="display:flex; gap:10px;">
            <button class="btn" id="closeOther" type="button">Klar</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================
   DATA & PRISER (EXKL MOMS)
   Alla priser h√∂js 10% i ber√§kningen.
   ========================= */

const PRICE = {
  vh_wc: 0,               // info/val (om du vill s√§tta pris senare)
  gs_wc: 0,               // info, ingen kostnad
  handdusch_wc: 2500,
  badkar: 12000,
  enbart_dusch: 0,
  tvattmaskin: 8500,
  sankt_innertak: 6500,
  spackel_malning: 9500,
  ny_dorr: 4500,
  ny_troskel: 2500
};

// 10% p√•slag
const UPLIFT = 1.10;
const VAT = 1.25;

const el = (id) => document.getElementById(id);

const state = {
  other: [] // {text, amount}
};

function formatSEK(n){
  const v = Math.max(0, Math.round(n));
  return v.toLocaleString("sv-SE") + " kr";
}

/* ==============
   PERSISTENS
   ============== */

const LS_KEY = "petrabadrum_state_v1";

function readForm(){
  const ids = [
    "kundnamn","adress","telefon","epost",
    "datum","tid","motestyp","plats",
    "rot","rotBelopp",
    "vh_wc","gs_wc","handdusch_wc","badkar","enbart_dusch","tvattmaskin","sankt_innertak","spackel_malning","ny_dorr","ny_troskel",
    "flytt_avlopp",
    "summary","entreprenor"
  ];
  const obj = {};
  ids.forEach(id=>{
    const node = el(id);
    if(!node) return;
    if(node.type === "checkbox") obj[id] = node.checked;
    else obj[id] = node.value ?? "";
  });
  obj.other = state.other;
  return obj;
}

function writeForm(obj){
  if(!obj) return;
  Object.keys(obj).forEach(k=>{
    if(k === "other") return;
    const node = el(k);
    if(!node) return;
    if(node.type === "checkbox") node.checked = !!obj[k];
    else node.value = obj[k];
  });
  state.other = Array.isArray(obj.other) ? obj.other : [];
  renderOtherRows();
  syncDateTimePills();
  recalc(false);
}

function saveToLS(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(readForm()));
  }catch(e){}
}

function loadFromLS(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    writeForm(JSON.parse(raw));
  }catch(e){}
}

/* Autospara vid all input */
function bindAutoSave(){
  document.addEventListener("input", (e)=>{
    if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT")){
      syncDateTimePills();
      saveToLS();
      recalc(false);
    }
  });
  document.addEventListener("change", ()=>{
    syncDateTimePills();
    saveToLS();
    recalc(false);
  });
}

/* ==============
   ‚ÄúPILL‚Äù DATE/TIME
   ============== */

function syncDateTimePills(){
  const d = el("datum").value;
  const t = el("tid").value;

  const datePill = el("datePill");
  const dateTxt = el("datePillText");
  if(d){
    datePill.classList.add("selected");
    dateTxt.classList.remove("muted");
    dateTxt.textContent = d;
  }else{
    datePill.classList.remove("selected");
    dateTxt.classList.add("muted");
    dateTxt.textContent = "Datum";
  }

  const timePill = el("timePill");
  const timeTxt = el("timePillText");
  if(t){
    timePill.classList.add("selected");
    timeTxt.classList.remove("muted");
    timeTxt.textContent = t;
  }else{
    timePill.classList.remove("selected");
    timeTxt.classList.add("muted");
    timeTxt.textContent = "Tid";
  }
}

function initPillClicks(){
  // Klick p√• ‚Äúpillen‚Äù ska fokusera date/time
  el("datePill").addEventListener("click", ()=> el("datum").showPicker ? el("datum").showPicker() : el("datum").focus());
  el("timePill").addEventListener("click", ()=> el("tid").showPicker ? el("tid").showPicker() : el("tid").focus());
}

/* ==============
   √ñVRIGT MODAL
   ============== */

function renderOtherRows(){
  const wrap = el("otherRows");
  wrap.innerHTML = "";

  if(state.other.length === 0){
    state.other.push({ text:"", amount:"" });
  }

  state.other.forEach((row, idx)=>{
    const div = document.createElement("div");
    div.className = "otherRow";

    const t = document.createElement("input");
    t.type = "text";
    t.placeholder = "Beskrivning (ex. f√∂nsterbyte)";
    t.value = row.text || "";
    t.addEventListener("input", ()=>{
      state.other[idx].text = t.value;
      saveToLS();
      recalc(false);
    });

    const a = document.createElement("input");
    a.type = "number";
    a.inputMode = "numeric";
    a.placeholder = "Belopp";
    a.min = "0";
    a.step = "100";
    a.value = row.amount ?? "";
    a.addEventListener("input", ()=>{
      state.other[idx].amount = a.value;
      saveToLS();
      recalc(false);
    });

    const del = document.createElement("button");
    del.className = "iconBtn";
    del.type = "button";
    del.textContent = "‚úï";
    del.addEventListener("click", ()=>{
      state.other.splice(idx,1);
      if(state.other.length===0) state.other.push({text:"", amount:""});
      renderOtherRows();
      saveToLS();
      recalc(false);
    });

    div.appendChild(t);
    div.appendChild(a);
    div.appendChild(del);
    wrap.appendChild(div);
  });
}

function openOther(){
  el("modalBack").style.display = "flex";
}
function closeOther(){
  el("modalBack").style.display = "none";
  saveToLS();
  recalc(false);
}

/* ==============
   KALKYL
   ============== */

function getSelectedCostBase(){
  let sum = 0;

  // checkboxes
  Object.keys(PRICE).forEach(k=>{
    const node = el(k);
    if(node && node.type === "checkbox" && node.checked){
      sum += (PRICE[k] || 0);
    }
  });

  // flytt av avlopp (select)
  const av = parseInt(el("flytt_avlopp").value || "0", 10);
  sum += isNaN(av) ? 0 : av;

  // √∂vrigt
  for(const r of state.other){
    const amt = parseFloat(r.amount || "0");
    if(!isNaN(amt) && amt>0) sum += amt;
  }

  return sum;
}

function recalc(updateSummary=true){
  const base = getSelectedCostBase();
  const uplifted = base * UPLIFT;

  const rotOn = el("rot").checked;
  const rotAmt = rotOn ? Math.max(0, parseFloat(el("rotBelopp").value || "0")) : 0;

  const afterRot = Math.max(0, uplifted - rotAmt);
  const afterRotInc = afterRot * VAT;

  el("sumEx").textContent = formatSEK(uplifted);
  el("sumRot").textContent = "-" + formatSEK(rotAmt);
  el("sumAfterRot").textContent = formatSEK(afterRot);
  el("sumAfterRotInc").textContent = formatSEK(afterRotInc);

  if(updateSummary){
    el("summary").value = buildSummary(uplifted, rotAmt, afterRot, afterRotInc);
  }

  saveToLS();
}

function buildSummary(sumEx, rotAmt, afterRot, afterRotInc){
  const lines = [];
  const name = el("kundnamn").value.trim();
  const addr = el("adress").value.trim();
  const tel = el("telefon").value.trim();
  const mail = el("epost").value.trim();

  const d = el("datum").value;
  const t = el("tid").value;
  const mt = el("motestyp").value;
  const pl = el("plats").value.trim();

  lines.push("PETRABADRUM ‚Äì Offertunderlag");
  lines.push("");

  lines.push("Kund:");
  if(name) lines.push("‚Ä¢ Namn: " + name);
  if(addr) lines.push("‚Ä¢ Adress: " + addr);
  if(tel)  lines.push("‚Ä¢ Telefon: " + tel);
  if(mail) lines.push("‚Ä¢ E-post: " + mail);
  lines.push("");

  lines.push("M√∂te:");
  if(d) lines.push("‚Ä¢ Datum: " + d);
  if(t) lines.push("‚Ä¢ Tid: " + t);
  if(mt) lines.push("‚Ä¢ M√∂testyp: " + mt);
  if(pl) lines.push("‚Ä¢ Plats: " + pl);
  lines.push("");

  lines.push("Val:");
  const chosen = [];

  const mapLabel = {
    vh_wc: "V√§ggh√§ngd WC",
    gs_wc: "Golvst√•ende WC (info, 0 kr)",
    handdusch_wc: "Handdusch vid toalett",
    badkar: "Badkar",
    enbart_dusch: "Enbart dusch",
    tvattmaskin: "Tv√§ttmaskin inkl el & avlopp",
    sankt_innertak: "S√§nkt innertak",
    spackel_malning: "Spackling & m√•lning",
    ny_dorr: "Ny d√∂rr",
    ny_troskel: "Ny tr√∂skel"
  };

  Object.keys(mapLabel).forEach(k=>{
    const node = el(k);
    if(node && node.checked) chosen.push("‚Ä¢ " + mapLabel[k]);
  });

  const avVal = parseInt(el("flytt_avlopp").value || "0", 10);
  if(avVal === 10000) chosen.push("‚Ä¢ Flytt av avlopp: Tr√§bj√§lklag (+10 000)");
  if(avVal === 20000) chosen.push("‚Ä¢ Flytt av avlopp: Betongbj√§lklag (+20 000)");

  // √ñvrigt
  const otherLines = [];
  for(const r of state.other){
    const txt = (r.text || "").trim();
    const amt = parseFloat(r.amount || "0");
    if(txt || (amt && amt>0)){
      otherLines.push(`‚Ä¢ √ñvrigt: ${txt || "(utan text)"} ‚Äì ${formatSEK(amt || 0)}`);
    }
  }

  if(chosen.length===0 && otherLines.length===0) lines.push("‚Ä¢ (Inga val √§nnu)");
  else{
    lines.push(...chosen);
    lines.push(...otherLines);
  }

  lines.push("");
  if(el("rot").checked){
    lines.push("ROT:");
    lines.push("‚Ä¢ Kund vill utnyttja ROT");
    lines.push("‚Ä¢ ROT-belopp: " + formatSEK(rotAmt));
    lines.push("");
  }

  lines.push("Pris (alla priser inkl. 10% h√∂jning, exkl. moms om inget annat anges):");
  lines.push("‚Ä¢ Delsumma (exkl. moms): " + formatSEK(sumEx));
  lines.push("‚Ä¢ ROT-avdrag: -" + formatSEK(rotAmt));
  lines.push("‚Ä¢ Pris efter ROT-avdrag (exkl. moms): " + formatSEK(afterRot));
  lines.push("‚Ä¢ Pris efter ROT-avdrag (inkl. moms): " + formatSEK(afterRotInc));

  const extra = el("entreprenor").value.trim();
  if(extra){
    lines.push("");
    lines.push("Entrepren√∂r ‚Äì extra anteckningar:");
    lines.push(extra);
  }

  return lines.join("\n");
}

/* ==============
   KALENDER (ICS)
   ============== */

function pad2(n){ return String(n).padStart(2,"0"); }

function toICSDateTime(dateStr, timeStr){
  // date: YYYY-MM-DD, time: HH:MM
  if(!dateStr || !timeStr) return null;
  const [Y,M,D] = dateStr.split("-").map(Number);
  const [h,m] = timeStr.split(":").map(Number);
  // Vi g√∂r ‚Äúfloating‚Äù lokal tid i ICS (utan Z) f√∂r enkelhet.
  return `${Y}${pad2(M)}${pad2(D)}T${pad2(h)}${pad2(m)}00`;
}

function download(filename, text, mime="text/plain"){
  const blob = new Blob([text], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function addToCalendar(){
  const d = el("datum").value;
  const t = el("tid").value;
  if(!d || !t){
    alert("Fyll i Datum och Tid f√∂rst.");
    return;
  }
  const dtStart = toICSDateTime(d,t);
  // 60 min default
  const end = new Date(`${d}T${t}:00`);
  end.setMinutes(end.getMinutes()+60);
  const dtEnd = `${end.getFullYear()}${pad2(end.getMonth()+1)}${pad2(end.getDate())}T${pad2(end.getHours())}${pad2(end.getMinutes())}00`;

  const title = `Kundbes√∂k ‚Äì ${el("kundnamn").value.trim() || "Petrabadrum"}`;
  const loc = el("plats").value.trim() || el("adress").value.trim();
  const desc = "Bokat via Petrabadrum (offertunderlag).";

  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Petrabadrum//SE
CALSCALE:GREGORIAN
BEGIN:VEVENT
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${title}
LOCATION:${loc}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

  download("kundbesok.ics", ics, "text/calendar");
}

/* ==============
   SPARA / PDF / COPY
   ============== */

function copySummary(){
  const txt = el("summary").value || "";
  navigator.clipboard?.writeText(txt).then(()=>{
    alert("Sammanfattning kopierad.");
  }).catch(()=>{
    // fallback
    const ta = el("summary");
    ta.focus(); ta.select();
    document.execCommand("copy");
    alert("Sammanfattning kopierad.");
  });
}

async function savePack(){
  // Skapar en fil med sammanfattning + pris
  recalc(true);
  const txt = el("summary").value || "";
  const safeName = (el("kundnamn").value.trim() || "kund").replace(/[^\w√•√§√∂√Ö√Ñ√ñ\- ]+/g,"").trim().replace(/\s+/g,"_");
  const filename = `Petrabadrum_${safeName}.txt`;

  // Ladda ned som fil
  download(filename, txt, "text/plain");

  // F√∂rs√∂k √∂ppna delning (iOS: Spara i filer/iCloud Drive)
  try{
    if(navigator.share){
      const file = new File([txt], filename, {type:"text/plain"});
      await navigator.share({ title: "Petrabadrum ‚Äì underlag", text: "Underlag bifogat.", files: [file] });
    }
  }catch(e){
    // Ignorera om anv√§ndaren avbryter delning
  }
}

function saveAsPDF(){
  // F√∂r b√§sta kompatibilitet: anv√§nd webbl√§sarens ‚ÄúSkriv ut‚Äù => spara som PDF i iOS
  recalc(true);
  window.print();
}

/* ==============
   RESET
   ============== */

function resetAll(){
  if(!confirm("Nollst√§ll allt? (Detta rensar alla f√§lt, val, √ñvrigt och sparad data.)")) return;
  try{ localStorage.removeItem(LS_KEY); }catch(e){}
  // reset inputs
  document.querySelectorAll("input, textarea, select").forEach(node=>{
    if(node.type === "checkbox") node.checked = false;
    else node.value = "";
  });
  state.other = [{text:"", amount:""}];
  renderOtherRows();
  syncDateTimePills();
  recalc(true);
}

/* ==============
   INIT
   ============== */

function init(){
  bindAutoSave();
  initPillClicks();

  el("calendarIconBtn").addEventListener("click", addToCalendar);
  el("calcBtn").addEventListener("click", ()=>recalc(true));
  el("copyBtn").addEventListener("click", copySummary);
  el("saveBtn").addEventListener("click", savePack);
  el("pdfBtn").addEventListener("click", saveAsPDF);
  el("resetBtn").addEventListener("click", resetAll);

  el("otherBtn").addEventListener("click", openOther);
  el("closeOther").addEventListener("click", closeOther);
  el("modalBack").addEventListener("click", (e)=>{ if(e.target === el("modalBack")) closeOther(); });
  el("addOtherRow").addEventListener("click", ()=>{
    state.other.push({text:"", amount:""});
    renderOtherRows();
    saveToLS();
  });

  // F√∂rsta render
  renderOtherRows();
  syncDateTimePills();
  loadFromLS();
  recalc(false);
}
init();
</script>
</body>
</html>